<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
  <title>SocialAvatar Lite（Basic Display）</title>
  <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    :root{--bg:#0b1220;--panel:#121a2b;--muted:#94a3b8;--text:#e6edf3;--accent:#74c0fc;--border:#22314f;--chip:#1a243a}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;color:var(--text);background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC",Arial,sans-serif;
         background: radial-gradient(900px 560px at 15% -10%, #1b2a4b 0%, transparent 55%),
                    radial-gradient(800px 500px at 110% 10%, #0f2450 0%, transparent 55%),
                    var(--bg);
         display:flex;align-items:center;justify-content:center;padding:16px}
    .wrap{width:100%;max-width:960px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .brand{font-weight:800;letter-spacing:.3px}
    .panel{background:linear-gradient(180deg, rgba(26,36,58,.9), rgba(14,20,34,.92));border:1px solid var(--border);border-radius:18px;padding:16px}
    .btn{background:#162544;border:1px solid #2b4473;color:#dbeafe;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted)}
    .card{border:1px solid #213050;border-radius:16px;background:rgba(18,26,43,.6);padding:16px;margin-top:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="text"]{padding:10px;border-radius:10px;border:1px solid #2d416e;background:#0e1730;color:#e6edf3;width:220px}
    input[type="file"]{accent-color:#6aa6ff}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media (max-width:880px){.grid{grid-template-columns:1fr}}
    .sec-title{font-weight:800;margin-bottom:8px;color:#cfe4ff}
    .mbti{font-size:32px;font-weight:900;letter-spacing:2px;margin:6px 0}
    .reason{color:#d7e0f5;line-height:1.7}
    pre{white-space:pre-wrap;background:#0a1328;border:1px solid #22345f;border-radius:12px;padding:10px}
    .ok{color:#86efac} .err{color:#ffb4b4}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">SocialAvatar Lite</div>
      <div class="row">
        <button class="btn" id="btnStatus">狀態</button>
        <button class="btn" id="btnLogin">IG 登入</button>
      </div>
    </header>

    <section class="panel">
      <div class="muted" id="desc">流程：IG Basic Display 登入 → 上傳個人頁截圖 → 本機 OCR → 與登入帳號比對一致 → 產生 MBTI 結果。</div>

      <div class="card" id="cardLogin" style="display:none">
        <div class="row"><button class="btn" onclick="location.href='/bd/login'">前往 IG 登入</button></div>
      </div>

      <div class="card" id="cardUpload" style="display:none">
        <div class="sec-title">上傳截圖（需包含 Username / Followers / Following / Posts）</div>
        <div class="row">
          <input id="file" type="file" accept="image/*"/>
          <button class="btn" id="btnOCR" disabled>開始辨識（本機）</button>
        </div>
        <div class="grid" style="margin-top:10px">
          <div>
            <div class="muted">辨識結果（可手動修正）</div>
            <div class="row" style="margin-top:8px"><label style="width:110px;display:inline-block">Username</label><input id="u" type="text" placeholder="username"/></div>
            <div class="row"><label style="width:110px;display:inline-block">Followers</label><input id="f1" type="text" placeholder="10.5k / 1234"/></div>
            <div class="row"><label style="width:110px;display:inline-block">Following</label><input id="f2" type="text" placeholder=""/></div>
            <div class="row"><label style="width:110px;display:inline-block">Posts</label><input id="p" type="text" placeholder=""/></div>
            <div class="row"><button class="btn" id="btnSubmit" disabled>送出驗證（必須與登入帳號一致）</button></div>
            <div id="msg" class="muted"></div>
          </div>
          <div>
            <div class="muted">OCR 原文</div>
            <pre id="raw"></pre>
          </div>
        </div>
      </div>

      <div class="card" id="cardResult" style="display:none">
        <div class="sec-title">分析結果 <span class="ok">✓</span></div>
        <div class="mbti" id="mbti">—</div>
        <div class="reason" id="reason">—</div>
        <pre id="json" style="display:none"></pre>
      </div>

      <div class="card" id="cardError" style="display:none">
        <div class="err" id="errTitle">分析失敗</div>
        <pre id="errDetail" class="muted"></pre>
      </div>
    </section>
  </div>

<script>
const $ = s => document.querySelector(s);
const api = (p, o={}) => fetch(p, {credentials:'include', headers:{'Content-Type':'application/json'}, ...o}).then(r=>r.json());
const show = (id, on=true) => { const el=$(id); if(el) el.style.display = on ? '' : 'none'; };

function extract(text){
  const t = (text||'').replace(/\s+/g,' ');
  const userM = t.match(/@([A-Za-z0-9._]{2,30})/);
  let username = userM ? userM[1] : (t.match(/\b([A-Za-z0-9._]{2,30})\b/)||[])[1];

  const pickNum = s=>{
    const m = s.match(/(\d{1,3}(?:,\d{3})+|\d+(?:\.\d+)?\s*[kKmM]?)/);
    return m ? m[1] : '';
  };
  let followers = pickNum(t.match(/粉絲|followers|팔로워|フォロワー|seguidores/i)? RegExp.rightContext : '');
  let following = pickNum(t.match(/追蹤|following|팔로잉|フォロー中|seguidos/i)? RegExp.rightContext : '');
  let posts     = pickNum(t.match(/貼文|posts|게시물|投稿|publicaciones/i)? RegExp.rightContext : '');
  return {username, followers, following, posts};
}

async function boot(){
  $('#btnStatus').onclick = async ()=> alert(JSON.stringify(await api('/bd/status'), null, 2));
  $('#btnLogin').onclick = ()=> location.href='/bd/login';

  const st = await api('/bd/status').catch(()=>null);
  if(!st || st.status!=='bound'){ show('#cardLogin', true); return; }
  show('#cardUpload', true);

  const file = $('#file'); const btnOCR = $('#btnOCR'); const btnSubmit = $('#btnSubmit');
  file.onchange = ()=> btnOCR.disabled = !file.files?.length;

  btnOCR.onclick = async ()=>{
    if(!file.files?.length) return;
    $('#msg').textContent = '辨識中（本機處理，不會上傳圖片）…';
    btnOCR.disabled = true;
    try{
      const worker = await Tesseract.createWorker('chi_sim','eng');
      const { data } = await worker.recognize(file.files[0]);
      await worker.terminate();
      $('#raw').textContent = data.text || '(no text)';
      const r = extract(data.text||'');
      $('#u').value = r.username || '';
      $('#f1').value = r.followers || '';
      $('#f2').value = r.following || '';
      $('#p').value = r.posts || '';
      $('#msg').textContent = '請確認 OCR 結果，必要時手動修正，接著送出驗證。';
      btnSubmit.disabled = false;
    }catch(e){
      $('#msg').textContent = 'OCR 失敗：' + e;
      btnOCR.disabled = false;
    }
  };

  btnSubmit.onclick = async ()=>{
    $('#msg').textContent = '送出驗證中…';
    const payload = {
      ocr_username: $('#u').value,
      followers: $('#f1').value,
      following: $('#f2').value,
      posts: $('#p').value
    };
    const res = await api('/bd/verify_submit', {method:'POST', body: JSON.stringify(payload)});
    if(!res.ok){
      if(res.where==='username_mismatch'){
        $('#msg').innerHTML = `❌ 帳號不一致：登入是 <b>@${res.expected}</b>，截圖讀到 <b>@${res.got}</b>。請確認上傳正確帳號截圖。`;
      }else{
        $('#msg').textContent = '驗證失敗：' + JSON.stringify(res);
      }
      return;
    }
    $('#msg').innerHTML = `✅ 通過：@${res.username}（followers: ${res.followers ?? '-'}）`;
    // 直接分析
    const out = await api('/bd/analyze', {method:'POST', body:'{}'});
    if(!out.ok){
      show('#cardError', true);
      $('#errTitle').textContent = '分析失敗';
      $('#errDetail').textContent = JSON.stringify(out, null, 2);
      return;
    }
    show('#cardResult', true);
    $('#mbti').textContent = out.mbti || '—';
    $('#reason').textContent = out.reason || '—';
    $('#json').textContent = JSON.stringify(out, null, 2);
  };
}

document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
