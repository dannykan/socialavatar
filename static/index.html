<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
/>
  <title>SocialAvatar</title>
  <meta name="description" content="AI 驅動的 Instagram 人格分析工具" />
  <style>
    :root{
      --bg:#0b1220;
      --panel:#121a2b;
      --muted:#94a3b8;
      --text:#e6edf3;
      --accent:#74c0fc;
      --accent-2:#2ecc71;
      --danger:#ef4444;
      --border:#22314f;
      --chip:#1a243a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      background: radial-gradient(1000px 600px at 20% -10%, #1b2a4b 0%, transparent 55%),
                  radial-gradient(800px 500px at 110% 10%, #0f2450 0%, transparent 55%),
                  var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Microsoft JhengHei", "細明體", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display:flex;align-items:center;justify-content:center;
      padding:24px;
    }
    .shell{
      width:100%;
      max-width:960px;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:16px;gap:12px;
    }
    .brand{
      font-size: clamp(18px, 3vw, 22px);
      font-weight:700;
      letter-spacing:.4px;
      display:flex;align-items:center;gap:10px;
    }
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent-2);box-shadow:0 0 10px 2px rgba(46,204,113,.5)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      background:var(--chip);color:var(--text);
      border:1px solid var(--border);
      padding:10px 14px;border-radius:12px;
      cursor:pointer;transition:.15s;font-weight:600
    }
    .btn:hover{transform:translateY(-1px);border-color:#2c3e64}
    .btn.primary{background:#1e2a44;border-color:#26406c;color:#dbeafe}
    .btn.success{background:#183524;border-color:#265b3c;color:#d1f4dc}
    .btn.danger{background:#361b1b;border-color:#5e2a2a;color:#ffd7d7}
    .panel{
      background:linear-gradient(180deg, rgba(26,36,58,.9), rgba(14,20,34,.92));
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow:0 14px 50px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    }
    .card{
      border:1px solid #213050;border-radius:16px;background:rgba(18,26,43,.6);
      padding:18px;margin-top:12px
    }
    h1{
      margin:0 0 6px;font-size: clamp(18px, 4vw, 24px);
      font-weight:800;letter-spacing:.3px
    }
    .subtitle{color:var(--muted);font-size:14px}
    .result{display:grid;grid-template-columns: 1.1fr .9fr;gap:16px;margin-top:14px}
    @media (max-width:880px){.result{grid-template-columns:1fr}}
    .section-title{
      font-weight:700;font-size:15px;margin:0 0 10px;color:#c8d7ff
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:#15203a;border:1px solid #263556;color:#cfe4ff;font-weight:700
    }
    .ok{color:#86efac}
    .spinner{
      width:22px;height:22px;border:3px solid #2b3a5d;border-top-color:#86efac;border-radius:50%;
      animation:spin .9s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .mbti{
      font-size:32px;font-weight:900;letter-spacing:2px;margin:8px 0 6px
    }
    .reason{color:#d7e0f5;line-height:1.7;font-size:16px}
    .meta{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0 2px}
    .meta .chip{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:10px;color:#cbd5e1;font-weight:600}
    .profile{
      display:flex;gap:14px;align-items:center;margin-bottom:10px
    }
    .avatar{width:52px;height:52px;border-radius:50%;object-fit:cover;border:1px solid #2b3c63;background:#0b1322}
    .username{font-weight:800}
    .pics{
      display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-top:8px
    }
    .thumb{
      width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:10px;border:1px solid #223252;background:#0e1629
    }
    @media (max-width:640px){.thumb{border-radius:8px}}
    .muted{color:#98a6c7}
    .center{display:flex;align-items:center;justify-content:center}
    .err{color:#ffb4b4}
    .footer-note{color:#8692b3;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand"><span class="dot"></span> SocialAvatar</div>
      <div class="toolbar">
        <button class="btn" id="btnDebug">偵錯</button>
        <button class="btn" id="btnRetry">重新整理</button>
        <button class="btn primary" id="btnRelogin">重新登入</button>
      </div>
    </header>

    <section class="panel">
      <h1>AI 驅動的 Instagram 人格分析工具</h1>
      <div class="subtitle" id="subtitle">系統將分析你的公開資訊與貼文特徵，輸出 MBTI 類型與 100 字說明。</div>

      <div class="card" id="cardLoading" style="display:none">
        <div class="center" style="gap:12px;padding:32px 4px;">
          <div class="spinner" aria-label="loading"></div>
          <div class="muted">正在分析你的 Instagram 個人頁面，請稍候…</div>
        </div>
      </div>

      <div class="card" id="cardLogin" style="display:none">
        <div class="muted" style="margin-bottom:10px">尚未完成 Facebook 授權登入。</div>
        <button class="btn success" id="btnGoLogin">前往登入</button>
      </div>

      <div class="result" id="resultWrap" style="display:none">
        <div class="card">
          <div class="section-title">分析結果 <span class="ok">✓</span></div>
          <div id="profileRow" class="profile" style="display:none">
            <img id="avatar" class="avatar" alt="">
            <div>
              <div class="username" id="name"></div>
              <div class="muted" id="uname"></div>
            </div>
          </div>
          <div class="meta" id="metaRow" style="display:none">
            <div class="chip" id="mFollowers"></div>
            <div class="chip" id="mFollows"></div>
            <div class="chip" id="mPosts"></div>
          </div>

          <div class="pill" id="pill"><span>MBTI</span> <strong id="mbtiText">—</strong></div>
          <div class="mbti" id="mbtiBig">—</div>
          <div class="reason" id="reason">—</div>
        </div>

        <div class="card">
          <div class="section-title">最近貼文</div>
          <div class="pics" id="pics"></div>
          <div class="footer-note">僅展示最近 12 張公開貼文首圖。若無法讀取，仍不影響 MBTI 分析。</div>
        </div>
      </div>

      <div class="card" id="cardError" style="display:none">
        <div class="err" id="errTitle">分析失敗</div>
        <pre class="muted" id="errDetail" style="white-space:pre-wrap;margin:10px 0 0"></pre>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnShowStatus">/auth/status</button>
          <button class="btn" id="btnShowSession">/debug/session</button>
          <button class="btn" id="btnShowCheck">/me/ig/check</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    const api = (path, opts={}) =>
      fetch(path, {
        credentials: 'include',
        headers: {'Content-Type':'application/json'},
        ...opts
      }).then(r => r.json());

    const $ = sel => document.querySelector(sel);
    const show = (id, on=true) => { const el=$(id); if(!el) return; el.style.display = on ? '' : 'none' };

    const ui = {
      setLoading() {
        show('#cardLogin', false);
        show('#cardError', false);
        show('#resultWrap', false);
        show('#cardLoading', true);
      },
      showLogin(){
        show('#cardLoading', false);
        show('#cardError', false);
        show('#resultWrap', false);
        show('#cardLogin', true);
      },
      showError(title, detail=''){
        show('#cardLoading', false);
        show('#cardLogin', false);
        show('#resultWrap', false);
        $('#errTitle').textContent = title || '分析失敗';
        $('#errDetail').textContent = typeof detail==='string' ? detail : JSON.stringify(detail, null, 2);
        show('#cardError', true);
      },
      renderResult({profile, media, analyze}){
        show('#cardLoading', false);
        show('#cardLogin', false);
        show('#cardError', false);
        show('#resultWrap', true);

        // MBTI + reason
        const mbti = analyze?.mbti || '—';
        $('#mbtiText').textContent = mbti;
        $('#mbtiBig').textContent = mbti;
        $('#reason').textContent = analyze?.reason || '—';

        // Profile
        if (profile && typeof profile==='object') {
          const {username, name, profile_picture_url, followers_count, follows_count, media_count} = profile;
          if (profile_picture_url) { $('#avatar').src = profile_picture_url; }
          $('#name').textContent = name || '';
          $('#uname').textContent = username ? '@' + username : '';
          show('#profileRow', !!(username || name));

          if (followers_count!=null || follows_count!=null || media_count!=null) {
            $('#mFollowers').textContent = `粉絲 ${toK(followers_count)}`;
            $('#mFollows').textContent = `追蹤 ${toK(follows_count)}`;
            $('#mPosts').textContent = `貼文 ${toK(media_count)}`;
            show('#metaRow', true);
          } else {
            show('#metaRow', false);
          }
        } else {
          show('#profileRow', false);
          show('#metaRow', false);
        }

        // Media thumbnails
        const pics = $('#pics');
        pics.innerHTML = '';
        const thumbs = (media?.data || []).slice(0, 12);
        for (const m of thumbs) {
          const url = m.thumbnail_url || m.media_url;
          if (!url) continue;
          const img = document.createElement('img');
          img.src = url;
          img.loading = 'lazy';
          img.className = 'thumb';
          img.alt = m.caption || '';
          pics.appendChild(img);
        }
      }
    };

    function toK(n){
      if(n==null || isNaN(n)) return '-';
      if(n>=1000000) return (n/1000000).toFixed(1).replace(/\.0$/,'')+'M';
      if(n>=1000) return (n/1000).toFixed(1).replace(/\.0$/,'')+'K';
      return String(n);
    }

    async function fetchBasic(){
      try { return await api('/me/ig/basic'); } catch(e){ return null; }
    }
    async function fetchMedia(){
      try { return await api('/me/ig/media'); } catch(e){ return null; }
    }
    async function analyze(){
      try {
        return await api('/me/ig/analyze', {method:'POST', body: JSON.stringify({})});
      } catch(e){
        return {ok:false, where:'network', detail: String(e)};
      }
    }

    async function boot(){
      // wired buttons
      $('#btnRelogin').onclick = () => location.href = '/auth/login';
      $('#btnGoLogin').onclick = () => location.href = '/auth/login';
      $('#btnRetry').onclick = () => location.reload();
      $('#btnDebug').onclick = async () => {
        try{
          const s = await api('/auth/status');
          alert('auth/status:\n\n' + JSON.stringify(s,null,2));
        }catch(e){ alert('debug failed: ' + e) }
      };
      $('#btnShowStatus').onclick = async () => alert(JSON.stringify(await api('/auth/status'), null, 2));
      $('#btnShowSession').onclick = async () => alert(JSON.stringify(await api('/debug/session'), null, 2));
      $('#btnShowCheck').onclick = async () => alert(JSON.stringify(await api('/me/ig/check'), null, 2));

      ui.setLoading();

      // 先看是否綁定
      let st;
      try {
        st = await api('/auth/status');
      } catch (e) {
        ui.showError('無法連線伺服器，請稍後重試。', String(e));
        return;
      }

      if (!st || st.status !== 'bound') {
        ui.showLogin();
        return;
      }

      // 已登入 → 併發抓資料
      const [profile, media, analyzeRes] = await Promise.all([
        fetchBasic(),
        fetchMedia(),
        analyze()
      ]);

      if (!analyzeRes || analyzeRes.ok !== true) {
        ui.showError('分析失敗', analyzeRes || {});
        return;
      }

      ui.renderResult({
        profile,
        media,
        analyze: analyzeRes
      });
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
