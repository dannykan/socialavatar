<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Story - Social Net Worth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background: #1a1a1a;
            padding: 40px 20px;
            gap: 20px;
        }
        
        .story-container {
            width: 100%;
            max-width: 450px;
            aspect-ratio: 9 / 16;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
        }
        
        .story-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 50px 35px 40px;
            position: relative;
            background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.5) 100%);
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            animation: fadeInDown 0.8s ease-out;
        }
        
        .username {
            color: white;
            font-size: clamp(26px, 6vw, 34px);
            font-weight: 900;
            margin-bottom: 5px;
            text-shadow: 0 4px 15px rgba(0,0,0,0.5);
            letter-spacing: -1px;
        }
        
        .profile-name {
            color: rgba(255,255,255,0.95);
            font-size: clamp(14px, 4vw, 18px);
            font-weight: 500;
            text-shadow: 0 2px 10px rgba(0,0,0,0.4);
        }
        
        .main-value-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 35px;
            padding: 35px 30px 26px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            margin-bottom: 20px;
            animation: scaleIn 0.6s ease-out 0.2s both;
        }
        
        .total-value-label {
            color: #6B7280;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }
        
        .total-value-amount {
            font-size: 64px;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 8px;
            letter-spacing: -2px;
            background: linear-gradient(110deg, #ff9bff 0%, #ff6fd8 35%, #ff499f 70%, #ff1f63 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-flex;
            align-items: baseline;
            justify-content: center;
            gap: 6px;
            padding: 0 16px;
        }

        .total-value-amount .currency {
            font-size: 0.45em;
            letter-spacing: 0;
        }

        .currency-display {
            display: inline-flex;
            align-items: baseline;
            justify-content: center;
            gap: 4px;
            padding: 0 10px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .value-subtitle {
            color: #9CA3AF;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 25px;
        }
        
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
            margin: 24px 0 0;
        }
        
        .price-item {
            background: linear-gradient(135deg, #F9FAFB, #F3F4F6);
            padding: 12px 8px;
            border-radius: 15px;
            text-align: center;
            border: 1.5px solid #E5E7EB;
        }
        
        .price-label {
            font-size: 10px;
            color: #6B7280;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .price-value {
            font-size: 18px;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            display: inline-flex;
            align-items: baseline;
            justify-content: center;
            gap: 2px;
        }

        .price-value .currency {
            font-size: 12px;
            letter-spacing: 0;
        }
        
        .ai-review {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            animation: fadeInUp 0.6s ease-out 0.4s both;
            text-align: center;
        }
        
        .ai-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 6px 18px;
            border-radius: 20px;
            font-size: 12px;
            color: white;
            font-weight: 700;
            margin: 0 auto 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .review-text {
            color: #374151;
            font-size: 14px;
            line-height: 1.6;
            font-weight: 500;
        }
        
        .cta-section {
            margin-top: auto;
            text-align: center;
            animation: fadeInUp 0.8s ease-out 0.6s both;
        }
        
        .cta-text {
            color: white;
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 15px;
            text-shadow: 0 4px 15px rgba(0,0,0,0.5);
            line-height: 1.2;
        }
        
        .cta-button {
            display: inline-block;
            background: white;
            color: #1F2937;
            padding: 16px 45px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 800;
            text-decoration: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            transition: transform 0.2s;
            border: none;
            cursor: pointer;
            margin-bottom: 12px;
        }
        
        .cta-button:hover {
            transform: scale(1.05);
        }
        
        .website {
            color: white;
            font-size: 15px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.4);
            letter-spacing: 0.5px;
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .sparkle {
            position: absolute;
            font-size: 28px;
            animation: float 3s ease-in-out infinite;
        }
        
        .sparkle:nth-child(1) { top: 12%; left: 8%; animation-delay: 0s; }
        .sparkle:nth-child(2) { top: 20%; right: 10%; animation-delay: 1s; }
        .sparkle:nth-child(3) { top: 45%; left: 5%; animation-delay: 2s; }
        .sparkle:nth-child(4) { bottom: 25%; right: 8%; animation-delay: 1.5s; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) scale(1) rotate(0deg); opacity: 0.7; }
            50% { transform: translateY(-25px) scale(1.1) rotate(180deg); opacity: 1; }
        }
        
        .instructions-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px 20px;
            z-index: 2000;
        }
        
        .instructions-card {
            background: rgba(255,255,255,0.98);
            padding: 25px;
            border-radius: 18px;
            max-width: 360px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.45);
            font-size: 14px;
            line-height: 1.6;
        }
        
        .instructions-card h3 {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .instructions-card ol {
            margin-left: 18px;
            color: #4B5563;
            margin-bottom: 12px;
        }
        
        .instructions-card li {
            margin-bottom: 6px;
        }
        
        .instructions-card p {
            color: #9CA3AF;
            font-size: 12px;
        }
        
        .instructions-close {
            margin-top: 18px;
            width: 100%;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 700;
            font-size: 15px;
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.35);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 25px 12px;
            }
            .story-container {
                max-width: 360px;
            }
        }
    </style>
</head>
<body>
    <div class="instructions-popup" id="instructions-popup">
        <div class="instructions-card">
            <h3><span>ğŸ“±</span>ä½¿ç”¨èªªæ˜</h3>
            <ol>
                <li>é€™æ˜¯ IG Story é è¦½å°ºå¯¸</li>
                <li>è«‹ç”¨æ‰‹æ©Ÿå°ç•«é¢æˆªåœ–ä¿å­˜</li>
                <li>ç›´æ¥ä¸Šå‚³åˆ°ä½ çš„ IG Story</li>
                <li>å¸å¼•æœ‹å‹ä¸€èµ·æ¸¬èº«åƒ¹ï¼</li>
            </ol>
            <p>ğŸ’¡ å»ºè­°ç”¨æ‰‹æ©Ÿæˆªåœ–å¯ç²å¾—æœ€ä½³ç•«è³ª</p>
            <button class="instructions-close" id="popup-close">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <div class="story-container">
        <div class="sparkle">âœ¨</div>
        <div class="sparkle">ğŸ’</div>
        <div class="sparkle">â­</div>
        <div class="sparkle">ğŸ’«</div>
        
        <div class="story-content">
            <div class="header">
                <div class="username" id="story-username">@username</div>
                <div class="profile-name" id="story-display">Display Name</div>
            </div>
            
            <div class="main-value-card">
                <div class="total-value-label">ğŸ’° IG ç¤¾ç¾¤å¸³è™Ÿç¸½åƒ¹å€¼ (TWD)</div>
                <div class="total-value-amount currency-display" data-base-size="64">
                    <span class="currency">$</span>
                    <span class="amount" id="story-total-value">0</span>
                </div>
                <div class="value-subtitle" id="story-value-subtitle">åŸºæ–¼ AI æ™ºèƒ½é‘‘åƒ¹æ¨¡å‹</div>
                
                <div class="pricing-grid">
                    <div class="price-item">
                        <div class="price-label">ğŸ“¸ è²¼æ–‡ Post</div>
                        <div class="price-value currency-display" data-base-size="18">
                            <span class="currency">$</span>
                            <span class="amount" id="story-post-value">0</span>
                        </div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">ğŸ“± é™å‹• Story</div>
                        <div class="price-value currency-display" data-base-size="18">
                            <span class="currency">$</span>
                            <span class="amount" id="story-story-value">0</span>
                        </div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">ğŸ¬ çŸ­å½±éŸ³ Reel</div>
                        <div class="price-value currency-display" data-base-size="18">
                            <span class="currency">$</span>
                            <span class="amount" id="story-reels-value">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="ai-review">
                <div class="ai-badge">Social NetWorth çŸ­è©•</div>
                <div class="review-text" id="story-review">
                    AI åˆ†ææ­£åœ¨è¼‰å…¥...
                </div>
            </div>
            
            <div class="cta-section">
                <div class="cta-text">
                    ğŸ“² æƒ³çŸ¥é“ä½ çš„ IG å€¼å¤šå°‘ï¼Ÿ
                </div>
                <button class="cta-button" id="story-cta">æƒæç”Ÿæˆä½ çš„å°ˆå±¬å¡ â†’</button>
                <div class="website">www.SocialNetWorth.com</div>
            </div>
        </div>
    </div>

    <script>
        function getQueryParam(key) {
            const params = new URLSearchParams(window.location.search);
            const value = params.get(key);
            return value ? decodeURIComponent(value.trim()) : null;
        }

        function formatNumber(value) {
            const num = Number(value) || 0;
            return num.toLocaleString();
        }

        function updateCurrencyAmount(amountId, value) {
            const amountEl = document.getElementById(amountId);
            if (!amountEl) return;
            amountEl.textContent = formatNumber(value);
            const container = amountEl.closest('.currency-display');
            if (!container) return;
            const baseSize = Number(container.dataset.baseSize) || 40;
            const digits = amountEl.textContent.replace(/[^0-9]/g, '').length;
            let fontSize = baseSize;
            if (digits > 9) fontSize = baseSize * 0.85;
            if (digits > 12) fontSize = baseSize * 0.7;
            if (digits > 15) fontSize = baseSize * 0.6;
            container.style.fontSize = fontSize + 'px';
        }

        function loadStoryData() {
            try {
                const stored = localStorage.getItem('sa_story_data');
                if (!stored) return null;
                return JSON.parse(stored);
            } catch (err) {
                console.error('ç„¡æ³•è¼‰å…¥åˆ†äº«è³‡æ–™', err);
                return null;
            }
        }

        function truncateReview(text) {
            if (!text) return 'AI åµæ¢æ­£åœ¨å¿™ç¢Œï¼Œç¨å¾Œå†ä¾†çœ‹çœ‹å§ï¼';
            const clean = text.replace(/<br\s*\/?>/gi, ' ').trim();
            if (clean.length <= 120) return clean;
            return clean.slice(0, 120).trim() + 'â€¦';
        }

        async function fetchStoryData(username) {
            try {
                const resp = await fetch(`/api/result?username=${encodeURIComponent(username)}`);
                if (!resp.ok) throw new Error(`API ${resp.status}`);
                return await resp.json();
            } catch (err) {
                console.error('Fetch story data error', err);
                return null;
            }
        }

        function applyStoryData(data) {
            document.getElementById('story-username').textContent = data.username || '@username';
            document.getElementById('story-display').textContent = data.display_name || '';
            updateCurrencyAmount('story-total-value', data.total_value);
            document.getElementById('story-value-subtitle').textContent = data.value_subtitle || 'åŸºæ–¼ AI æ™ºèƒ½é‘‘åƒ¹æ¨¡å‹';
            updateCurrencyAmount('story-post-value', data.post_value);
            updateCurrencyAmount('story-story-value', data.story_value);
            updateCurrencyAmount('story-reels-value', data.reels_value);
            document.getElementById('story-review').textContent = truncateReview(data.review);
        }

        (async function init() {
            let data = null;
            const usernameParam = getQueryParam('username');
            if (usernameParam) {
                data = await fetchStoryData(usernameParam);
                if (data && data.value_estimation) {
                    data = buildStoryPayloadFromResult(data);
                }
            }

            if (!data) {
                const local = loadStoryData();
                if (!local) {
                    alert('æ‰¾ä¸åˆ°åˆ†äº«è³‡æ–™ï¼Œè«‹å›åˆ°åˆ†æé é‡æ–°ç”Ÿæˆ');
                    window.location.href = '/static/upload.html';
                    return;
                }
                data = local;
            }

            applyStoryData(data);

            document.getElementById('story-cta').addEventListener('click', () => {
                window.location.href = '/static/upload.html';
            });

            const popup = document.getElementById('instructions-popup');
            const closeBtn = document.getElementById('popup-close');
            closeBtn.addEventListener('click', () => {
                popup.style.opacity = '0';
                popup.style.pointerEvents = 'none';
                setTimeout(() => popup.style.display = 'none', 200);
            });
        })();

        function buildStoryPayloadFromResult(result) {
            const valData = result.value_estimation || {};
            return {
                username: result.username ? (result.username.startsWith('@') ? result.username : `@${result.username}`) : '@username',
                plain_username: (result.plain_username || result.username || '').replace(/^@/, ''),
                display_name: result.display_name || result.username || '',
                total_value: valData.account_asset_value || 0,
                post_value: valData.post_value || 0,
                story_value: valData.story_value || 0,
                reels_value: valData.reels_value || 0,
                review: result.analysis_text || '',
                value_subtitle: result.value_subtitle || 'åŸºæ–¼ AI æ™ºèƒ½é‘‘åƒ¹æ¨¡å‹'
            };
        }
    </script>
</body>
</html>

