<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ä¸Šå‚³ç´ æï½œSocial Avatar</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
         margin:0;background:#0b1220;color:#e5e7eb;min-height:100vh}
    header{padding:16px 20px;border-bottom:1px solid #1f2937;background:#0b1220;position:sticky;top:0;display:flex;justify-content:space-between;align-items:center}
    .user-badge{background:#065f46;color:#d1fae5;padding:6px 12px;border-radius:8px;font-size:13px;display:flex;align-items:center;gap:8px}
    .user-avatar{width:24px;height:24px;border-radius:50%;object-fit:cover}
    main{max-width:760px;margin:0 auto;padding:20px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:18px;margin:14px 0}
    h1{margin:6px 0 0}
    .muted{opacity:.8}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input[type=file]{width:100%;background:#0b1220;border:1px dashed #374151;border-radius:10px;padding:14px;color:#e5e7eb;cursor:pointer}
    input[type=file]:hover{border-color:#22d3ee}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
    .primary{background:#22d3ee;color:#0b1220}
    .primary:hover{filter:brightness(1.1)}
    .ghost{background:transparent;border:1px solid #374151;color:#e5e7eb}
    .hint{font-size:13px;opacity:.8;margin-top:6px}
    .err{background:#7f1d1d;color:#fecaca;border:1px solid #ef4444;padding:12px;border-radius:10px;display:none;margin-top:10px;white-space:pre-wrap}
    .ok{background:#052e1a;color:#bbf7d0;border:1px solid #22c55e;padding:12px;border-radius:10px;display:none;margin-top:10px}
  </style>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBI2-4yEwzxvYOvui9FZiGAzCE22OhKmU8",
      authDomain: "social-avatar-d13c8.firebaseapp.com",
      projectId: "social-avatar-d13c8",
      storageBucket: "social-avatar-d13c8.appspot.com",
      messagingSenderId: "280598358339",
      appId: "1:280598358339:web:214a0d4ca53793163367f6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Check authentication
    function checkAuth() {
      try {
        const user = sessionStorage.getItem('user');
        if (!user) {
          alert('è«‹å…ˆç™»å…¥');
          window.location.href = '/static/landing.html';
          return false;
        }
        
        const userData = JSON.parse(user);
        // Display user info in header
        const userBadge = document.getElementById('userBadge');
        if (userBadge && userData) {
          if (userData.photoURL) {
            userBadge.innerHTML = `
              <img class="user-avatar" src="${userData.photoURL}" alt="User">
              <span>${userData.displayName || userData.email || 'User'}</span>
            `;
          } else {
            userBadge.innerHTML = `<span>ğŸ‘¤ ${userData.displayName || userData.email || 'User'}</span>`;
          }
        }
        return userData;
      } catch (e) {
        console.error('Auth check failed:', e);
        window.location.href = '/static/landing.html';
        return false;
      }
    }

    // Check auth on page load
    const currentUser = checkAuth();
    if (!currentUser) {
      throw new Error('Authentication required');
    }

    window.startAnalyze = async function() {
      const errBox = document.getElementById('err');
      const okBox = document.getElementById('ok');
      errBox.style.display = 'none';
      okBox.style.display = 'none';

      const form = new FormData();
      const profile = document.querySelector('#profile').files[0];
      
      if (!profile) {
        alert('è«‹å…ˆä¸Šå‚³ IG å€‹äººé æˆªåœ–');
        return;
      }
      
      form.append('profile', profile);

      const posts = document.querySelector('#posts').files;
      for (let i = 0; i < Math.min(posts.length, 6); i++) {
        form.append('posts', posts[i]);
      }

      okBox.textContent = 'ä¸Šå‚³ä¸­ï¼Œè«‹ç¨å€™...';
      okBox.style.display = 'block';

      try {
        const res = await fetch('/bd/analyze', {
          method: 'POST',
          body: form
        });

        const data = await res.json();
        
        if (!data.ok) {
          console.error('analyze error:', data);
          errBox.textContent = 'åˆ†æå¤±æ•—ï¼š' + (data.error || 'server error');
          errBox.style.display = 'block';
          okBox.style.display = 'none';
          return;
        }

        console.log('[DEBUG] Analysis successful, saving to Firestore...');

        // Store user info along with result
        const user = JSON.parse(sessionStorage.getItem('user'));
        data.user = user;
        data.timestamp = new Date().toISOString();

        console.log('[DEBUG] User UID:', user.uid);
        console.log('[DEBUG] Data to save:', data);

        // Save to Firestore
        try {
          const userDocRef = doc(db, 'users', user.uid);
          
          const firestoreData = {
            uid: user.uid,
            email: user.email,
            displayName: user.displayName,
            photoURL: user.photoURL,
            hasAnalysis: true,
            latestAnalysis: {
              ok: data.ok,
              mbti: data.mbti,
              display_name: data.display_name,
              username: data.username,
              followers: data.followers,
              following: data.following,
              posts: data.posts,
              summary: data.summary,
              vehicle: data.vehicle,
              diagnose: data.diagnose,
              timestamp: serverTimestamp()
            },
            updatedAt: serverTimestamp()
          };
          
          console.log('[DEBUG] Saving to Firestore:', firestoreData);
          
          await setDoc(userDocRef, firestoreData);
          
          console.log('[DEBUG] âœ… Successfully saved to Firestore!');
        } catch (firestoreError) {
          console.error('[ERROR] Failed to save to Firestore:', firestoreError);
          console.error('[ERROR] Error code:', firestoreError.code);
          console.error('[ERROR] Error message:', firestoreError.message);
          // Continue anyway - user can still see results
          alert('âš ï¸ åˆ†æå®Œæˆï¼Œä½†å„²å­˜åˆ°é›²ç«¯æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚\n\néŒ¯èª¤ï¼š' + firestoreError.message + '\n\nä½ ä»å¯ä»¥æŸ¥çœ‹çµæœï¼Œä½†ä¸‹æ¬¡ç™»å…¥æ™‚å¯èƒ½éœ€è¦é‡æ–°åˆ†æã€‚');
        }

        // Store in sessionStorage for result.html
        sessionStorage.setItem('sa_result', JSON.stringify(data));
        
        okBox.textContent = 'å·²é€å‡ºï¼Œå‰å¾€åˆ†æä¸­ç•«é¢â€¦';
        setTimeout(() => location.href = '/static/loading.html', 400);
        
      } catch (e) {
        console.error(e);
        errBox.textContent = 'ç¶²è·¯éŒ¯èª¤ï¼š' + e.message;
        errBox.style.display = 'block';
        okBox.style.display = 'none';
      }
    };
  </script>
</head>
<body>
  <header>
    <div><strong>Social Avatar</strong></div>
    <div class="user-badge" id="userBadge">è¼‰å…¥ä¸­...</div>
  </header>

  <main>
    <h1>ä¸Šå‚³ç´ æ</h1>
    <p class="muted">åªéœ€å…©æ­¥ï¼š<br>â‘  ä¸Šå‚³ IG å€‹äººé æˆªåœ–ï¼ˆå¿…å¡«ï¼‰<br>â‘¡ï¼ˆå¯é¸ï¼‰ä¸Šå‚³ 1ï½6 å¼µæœ€è¿‘è²¼æ–‡é¦–åœ–ï¼Œæœ‰åŠ© AI æ›´æº–ç¢ºã€‚</p>

    <div class="card">
      <label>IG å€‹äººé æˆªåœ–ï¼ˆå¿…å¡«ï¼‰</label>
      <input id="profile" type="file" accept="image/*" required />
      <p class="hint">ğŸ“¸ åœ–åƒæ¸…æ™°ã€åŒ…å«åç¨±ã€bioã€ç²‰çµ²/è¿½è¹¤/è²¼æ–‡æ•¸ã€‚å»ºè­°é•·é‚Š &lt;= 3000pxã€‚</p>
    </div>

    <div class="card">
      <label>è²¼æ–‡é¦–åœ–ï¼ˆé¸å¡«ï¼Œå¯å¤šé¸ï¼‰</label>
      <input id="posts" type="file" accept="image/*" multiple />
      <p class="hint">ğŸ–¼ï¸ å¯ä¸Šå‚³ 1ï½6 å¼µï¼Œç³»çµ±æœƒè‡ªå‹•å£“ç¸®ä»¥ç¯€çœç”¨é‡ã€‚</p>
    </div>

    <div class="row">
      <button class="primary" onclick="startAnalyze()">ğŸš€ é–‹å§‹åˆ†æ</button>
      <a class="ghost" href="/static/landing.html">â† è¿”å›é¦–é </a>
      <a class="ghost" href="/health" target="_blank">ç³»çµ±ç‹€æ…‹</a>
    </div>

    <div id="err" class="err"></div>
    <div id="ok" class="ok"></div>
  </main>
</body>
</html>
