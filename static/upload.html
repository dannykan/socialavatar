<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>上傳素材｜Social Avatar</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
         margin:0;background:#0b1220;color:#e5e7eb;min-height:100vh}
    header{padding:16px 20px;border-bottom:1px solid #1f2937;background:#0b1220;position:sticky;top:0;display:flex;justify-content:space-between;align-items:center}
    .user-badge{background:#065f46;color:#d1fae5;padding:6px 12px;border-radius:8px;font-size:13px;display:flex;align-items:center;gap:8px}
    .user-avatar{width:24px;height:24px;border-radius:50%;object-fit:cover}
    main{max-width:760px;margin:0 auto;padding:20px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:18px;margin:14px 0}
    h1{margin:6px 0 0}
    .muted{opacity:.8}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input[type=file]{width:100%;background:#0b1220;border:1px dashed #374151;border-radius:10px;padding:14px;color:#e5e7eb;cursor:pointer}
    input[type=file]:hover{border-color:#22d3ee}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
    .primary{background:#22d3ee;color:#0b1220}
    .primary:hover{filter:brightness(1.1)}
    .ghost{background:transparent;border:1px solid #374151;color:#e5e7eb}
    .hint{font-size:13px;opacity:.8;margin-top:6px}
    .err{background:#7f1d1d;color:#fecaca;border:1px solid #ef4444;padding:12px;border-radius:10px;display:none;margin-top:10px;white-space:pre-wrap}
    .ok{background:#052e1a;color:#bbf7d0;border:1px solid #22c55e;padding:12px;border-radius:10px;display:none;margin-top:10px}
  </style>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBI2-4yEwzxvYOvui9FZiGAzCE22OhKmU8",
      authDomain: "social-avatar-d13c8.firebaseapp.com",
      projectId: "social-avatar-d13c8",
      storageBucket: "social-avatar-d13c8.appspot.com",
      messagingSenderId: "280598358339",
      appId: "1:280598358339:web:214a0d4ca53793163367f6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Check authentication
    function checkAuth() {
      try {
        const user = sessionStorage.getItem('user');
        if (!user) {
          alert('請先登入');
          window.location.href = '/static/landing.html';
          return false;
        }
        
        const userData = JSON.parse(user);
        // Display user info in header
        const userBadge = document.getElementById('userBadge');
        if (userBadge && userData) {
          if (userData.photoURL) {
            userBadge.innerHTML = `
              <img class="user-avatar" src="${userData.photoURL}" alt="User">
              <span>${userData.displayName || userData.email || 'User'}</span>
            `;
          } else {
            userBadge.innerHTML = `<span>👤 ${userData.displayName || userData.email || 'User'}</span>`;
          }
        }
        return userData;
      } catch (e) {
        console.error('Auth check failed:', e);
        window.location.href = '/static/landing.html';
        return false;
      }
    }

    // Check auth on page load
    const currentUser = checkAuth();
    if (!currentUser) {
      throw new Error('Authentication required');
    }

    window.startAnalyze = async function() {
      const errBox = document.getElementById('err');
      const okBox = document.getElementById('ok');
      errBox.style.display = 'none';
      okBox.style.display = 'none';

      const form = new FormData();
      const profile = document.querySelector('#profile').files[0];
      
      if (!profile) {
        alert('請先上傳 IG 個人頁截圖');
        return;
      }
      
      form.append('profile', profile);

      const posts = document.querySelector('#posts').files;
      for (let i = 0; i < Math.min(posts.length, 6); i++) {
        form.append('posts', posts[i]);
      }

      okBox.textContent = '上傳中，請稍候...';
      okBox.style.display = 'block';

      try {
        const res = await fetch('/bd/analyze', {
          method: 'POST',
          body: form
        });

        const data = await res.json();
        
        if (!data.ok) {
          console.error('analyze error:', data);
          errBox.textContent = '分析失敗：' + (data.error || 'server error');
          errBox.style.display = 'block';
          okBox.style.display = 'none';
          return;
        }

        console.log('[DEBUG] Analysis successful, saving to Firestore...');

        // Store user info along with result
        const user = JSON.parse(sessionStorage.getItem('user'));
        data.user = user;
        data.timestamp = new Date().toISOString();

        console.log('[DEBUG] User UID:', user.uid);
        console.log('[DEBUG] Data to save:', data);

        // Save to Firestore
        try {
          const userDocRef = doc(db, 'users', user.uid);
          
          const firestoreData = {
            uid: user.uid,
            email: user.email,
            displayName: user.displayName,
            photoURL: user.photoURL,
            hasAnalysis: true,
            latestAnalysis: {
              ok: data.ok,
              mbti: data.mbti,
              display_name: data.display_name,
              username: data.username,
              followers: data.followers,
              following: data.following,
              posts: data.posts,
              summary: data.summary,
              vehicle: data.vehicle,
              diagnose: data.diagnose,
              timestamp: serverTimestamp()
            },
            updatedAt: serverTimestamp()
          };
          
          console.log('[DEBUG] Saving to Firestore:', firestoreData);
          
          await setDoc(userDocRef, firestoreData);
          
          console.log('[DEBUG] ✅ Successfully saved to Firestore!');
        } catch (firestoreError) {
          console.error('[ERROR] Failed to save to Firestore:', firestoreError);
          console.error('[ERROR] Error code:', firestoreError.code);
          console.error('[ERROR] Error message:', firestoreError.message);
          // Continue anyway - user can still see results
          alert('⚠️ 分析完成，但儲存到雲端時發生錯誤。\n\n錯誤：' + firestoreError.message + '\n\n你仍可以查看結果，但下次登入時可能需要重新分析。');
        }

        // Store in sessionStorage for result.html
        sessionStorage.setItem('sa_result', JSON.stringify(data));
        
        okBox.textContent = '已送出，前往分析中畫面…';
        setTimeout(() => location.href = '/static/loading.html', 400);
        
      } catch (e) {
        console.error(e);
        errBox.textContent = '網路錯誤：' + e.message;
        errBox.style.display = 'block';
        okBox.style.display = 'none';
      }
    };
  </script>
</head>
<body>
  <header>
    <div><strong>Social Avatar</strong></div>
    <div class="user-badge" id="userBadge">載入中...</div>
  </header>

  <main>
    <h1>上傳素材</h1>
    <p class="muted">只需兩步：<br>① 上傳 IG 個人頁截圖（必填）<br>②（可選）上傳 1～6 張最近貼文首圖，有助 AI 更準確。</p>

    <div class="card">
      <label>IG 個人頁截圖（必填）</label>
      <input id="profile" type="file" accept="image/*" required />
      <p class="hint">📸 圖像清晰、包含名稱、bio、粉絲/追蹤/貼文數。建議長邊 &lt;= 3000px。</p>
    </div>

    <div class="card">
      <label>貼文首圖（選填，可多選）</label>
      <input id="posts" type="file" accept="image/*" multiple />
      <p class="hint">🖼️ 可上傳 1～6 張，系統會自動壓縮以節省用量。</p>
    </div>

    <div class="row">
      <button class="primary" onclick="startAnalyze()">🚀 開始分析</button>
      <a class="ghost" href="/static/landing.html">← 返回首頁</a>
      <a class="ghost" href="/health" target="_blank">系統狀態</a>
    </div>

    <div id="err" class="err"></div>
    <div id="ok" class="ok"></div>
  </main>
</body>
</html>
