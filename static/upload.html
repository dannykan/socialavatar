<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>上傳素材 — SocialAvatar</title>
  <style>
    body{margin:0;background:#0b0f14;color:#e6eef9;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto}
    .wrap{min-height:100svh;display:grid;place-items:center;padding:40px 16px}
    .card{width:min(760px,96vw);padding:28px;border-radius:16px;background:#0f1724;border:1px solid #1f2a3c;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h2{margin:0 0 12px}
    .row{margin:14px 0}
    .email{opacity:.8;font-size:14px;margin-bottom:12px}
    input[type=file]{width:100%;padding:14px;border-radius:12px;border:1px dashed #2b3b55;background:#0b1221;color:#cfe2ff}
    button{padding:12px 16px;border-radius:12px;border:1px solid #334155;background:#172031;color:#e6eef9;cursor:pointer;font-weight:600}
    button:hover{background:#1b263a}
    .flex{display:flex;gap:10px;flex-wrap:wrap}
    .loading{
      position:fixed;inset:0;display:none;place-items:center;background:rgba(5,10,18,.65);backdrop-filter:blur(6px);z-index:50
    }
    .spinner{width:64px;height:64px;border-radius:50%;border:6px solid #4662ff33;border-top-color:#7aa2ff;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(1turn)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>上傳素材（登入後）</h2>
      <div class="email">已綁定 Email：<span id="userEmail">—</span></div>

      <div class="row">
        <div>上傳 IG 個人頁截圖（必填，1 張）</div>
        <input id="fileProfile" type="file" accept="image/*" />
      </div>

      <div class="row">
        <div>上傳貼文首圖（選填，最多 4 張）</div>
        <input id="filePosts" type="file" accept="image/*" multiple />
      </div>

      <div class="flex">
        <button id="btnSample" type="button">載入示例檔</button>
        <button id="btnAnalyze" type="button">開始分析</button>
      </div>

      <div style="opacity:.7;margin-top:10px;font-size:12px">提示：本頁只做上傳與分析，其他欄位不顯示。分析中會出現全螢幕 Loading。</div>
    </div>
  </div>

  <!-- 全螢幕 Loading -->
  <div class="loading" id="loading">
    <div>
      <div class="spinner" style="margin:auto"></div>
      <div style="text-align:center;margin-top:12px;letter-spacing:.1em">AI 分析中，請稍候…</div>
    </div>
  </div>

  <!-- Firebase + 分析流程 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    /* TODO: 換成你的 Firebase config */
    const firebaseConfig = {
      apiKey: "AI...YOUR_KEY...",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "XXXX",
      appId: "1:XXXX:web:XXXX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const elEmail   = document.getElementById("userEmail");
    const elProfile = document.getElementById("fileProfile");
    const elPosts   = document.getElementById("filePosts");
    const elLoading = document.getElementById("loading");

    // 若已分析過（前端快取存在）就不讓回此頁
    if (sessionStorage.getItem("BD_RESULT")) {
      location.replace("./result.html");
    }

    onAuthStateChanged(auth, async (u)=>{
      if(!u){ location.replace("./landing.html"); return; }
      // 顯示 email（若 FB 沒 email 用 Firestore 補）
      const ref = doc(db,"users",u.uid);
      const snap= await getDoc(ref);
      elEmail.textContent = snap.data()?.email || u.email || "（無 Email）";
    });

    // 載入示例：用 fetch 把 server 的示例圖塞進 input，不同瀏覽器安全限制不同；保留原本的示例按鈕做提示
    document.getElementById("btnSample").onclick = ()=>{
      alert("示例檔請自行選取；或把示例圖放到電腦後再選擇檔案上傳。");
    };

    document.getElementById("btnAnalyze").onclick = async ()=>{
      const u = auth.currentUser;
      if(!u){ location.replace("./landing.html"); return; }

      const fileP = elProfile.files?.[0];
      if(!fileP){ alert("請先選擇『IG 個人頁截圖』"); return; }

      // 準備 FormData
      const fd = new FormData();
      fd.append("profile", fileP);
      const posts = Array.from(elPosts.files||[]).slice(0,4);
      for (const f of posts) fd.append("posts", f);

      try{
        elLoading.style.display = "grid";
        const res = await fetch("/bd/analyze", { method:"POST", body: fd });
        const json = await res.json();
        if(!json.ok){
          console.warn(json);
          alert("分析失敗：" + (json.detail || json.where || "server error"));
          elLoading.style.display = "none";
          return;
        }

        // 寫入 sessionStorage（結果頁會直接吃）
        sessionStorage.setItem("BD_RESULT", JSON.stringify({
          display_name: json.display_name || json.ig_account || "使用者",
          username: json.username || "",
          followers: json.followers || 0,
          following: json.following || 0,
          posts: json.posts || 0,
          mbti: json.mbti || "不詳",
          summary: json.reason || "—",
          vehicle: json.vehicle || "步行",
          used_fallback: !!json.used_fallback
        }));

        // Firestore 記 analyzed 與 result（可作為日後 server 驗證）
        const ref = doc(db,"users", u.uid);
        await updateDoc(ref,{
          analyzed: true,
          result: JSON.parse(sessionStorage.getItem("BD_RESULT"))
        });

        // 導向結果頁
        location.replace("./result.html");
      }catch(err){
        console.error(err);
        alert("分析失敗（網路或伺服器錯誤）");
        elLoading.style.display = "none";
      }
    };
  </script>
</body>
</html>
