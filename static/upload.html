<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>上傳素材｜Social Avatar</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
         margin:0;background:#0b1220;color:#e5e7eb;min-height:100vh}
    header{padding:16px 20px;border-bottom:1px solid #1f2937;background:#0b1220;position:sticky;top:0}
    main{max-width:760px;margin:0 auto;padding:20px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:18px;margin:14px 0}
    h1{margin:6px 0 0}
    .muted{opacity:.8}
    label{display:block;margin:10px 0 6px}
    input[type=file]{width:100%;background:#0b1220;border:1px dashed #374151;border-radius:10px;padding:14px;color:#e5e7eb}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
    .primary{background:#22d3ee;color:#0b1220}
    .ghost{background:transparent;border:1px solid #374151;color:#e5e7eb}
    .hint{font-size:13px;opacity:.8}
    .err{background:#7f1d1d;color:#fecaca;border:1px solid #ef4444;padding:12px;border-radius:10px;display:none;margin-top:10px;white-space:pre-wrap}
    .ok{background:#052e1a;color:#bbf7d0;border:1px solid #22c55e;padding:12px;border-radius:10px;display:none;margin-top:10px}
  </style>
  <script>
    // 若已分析，導回結果頁；避免重複分析
    (function(){
      try{
        const r = localStorage.getItem('sa_result');
        if (r) location.href='/static/result.html';
      }catch(e){}
    })();

    async function startAnalyze(){
      const errBox = document.getElementById('err');
      const okBox  = document.getElementById('ok');
      errBox.style.display='none'; okBox.style.display='none'; errBox.textContent='';

      const fProfile = document.getElementById('profile');
      const fPosts   = document.getElementById('posts');

      if (!fProfile.files || fProfile.files.length===0){
        errBox.textContent='請先上傳 IG 個人頁截圖（必填）';
        errBox.style.display='block';
        return;
      }

      const fd = new FormData();
      fd.append('profile', fProfile.files[0]);
      if (fPosts.files && fPosts.files.length>0){
        for (const f of fPosts.files) fd.append('posts', f);
      }

      try{
        const resp = await fetch('/bd/analyze', { method:'POST', body: fd });
        const data = await resp.json();
        console.log('[ANALYZE RESP]', data);

        if (!data.ok){
          errBox.textContent='分析失敗：' + (data.error || JSON.stringify(data));
          errBox.style.display='block';
          return;
        }

        // 存起來給 loading/result 用
        localStorage.setItem('sa_result', JSON.stringify(data));
        okBox.textContent='已送出，前往分析中畫面…';
        okBox.style.display='block';
        setTimeout(()=> location.href='/static/loading.html', 400);
      }catch(e){
        errBox.textContent='網路錯誤：' + e.message;
        errBox.style.display='block';
      }
    }
  </script>
</head>
<body>
  <header>
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div><strong>Social Avatar</strong></div>
      <nav class="row">
        <a class="ghost" href="/static/landing.html">首頁</a>
      </nav>
    </div>
  </header>

  <main>
    <h1>上傳素材</h1>
    <p class="muted">只需兩步：<br>① 上傳 IG 個人頁截圖（必填）<br>②（可選）上傳 1～9 張最近貼文首圖，有助 AI 更準確。</p>

    <div class="card">
      <label>IG 個人頁截圖（必填）</label>
      <input id="profile" type="file" accept="image/*" />
      <p class="hint">圖像清晰、包含名稱、bio、粉絲/追蹤/貼文數。建議長邊 &lt;= 3000px。</p>
    </div>

    <div class="card">
      <label>貼文首圖（選填，可多選）</label>
      <input id="posts" type="file" accept="image/*" multiple />
      <p class="hint">可上傳 1～9 張，系統會自動壓縮以節省用量。</p>
    </div>

    <div class="row">
      <button class="primary" onclick="startAnalyze()">開始分析</button>
      <a class="ghost" href="/health" target="_blank">系統狀態</a>
    </div>

    <div id="err" class="err"></div>
    <div id="ok"  class="ok"></div>
  </main>
</body>
</html>
