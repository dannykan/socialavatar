<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>上傳素材（登入後）</title>
<link rel="icon" href="data:," />
<style>
  :root{color-scheme:dark}
  body{margin:0;background:#0f1115;color:#e6e9ef;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{min-height:100svh;display:grid;place-items:center;padding:32px}
  .card{width:min(900px,94vw);background:#0b0d12;border:1px solid #262a33;border-radius:16px;padding:26px;box-shadow:0 10px 40px rgba(0,0,0,.45)}
  h1{font-size:24px;margin:0 0 16px}
  .row{margin:14px 0}
  .btn{padding:12px 16px;border-radius:12px;border:1px solid #2f3441;background:#12151c;color:#e6e9ef;cursor:pointer}
  .btn:hover{background:#171b23}
  .danger{color:#ffb4b4}
  #err{white-space:pre-wrap;background:#1a0f0f;border:1px solid #432626;border-radius:12px;padding:12px;margin-top:12px;display:none}
  .hint{opacity:.7;font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>上傳素材（登入後）</h1>
    <div id="uinfo" class="row">已綁定 Email：<span id="email">—</span></div>

    <div class="row">
      <label>上傳 IG 個人頁截圖（<b>必填，1 張</b>）</label><br/>
      <input id="profile" type="file" accept="image/*" />
    </div>

    <div class="row">
      <label>上傳貼文首圖（<b>選填，最多 4 張</b>）</label><br/>
      <input id="posts" type="file" accept="image/*" multiple />
    </div>

    <div class="row">
      <button id="demo" class="btn" type="button">載入示例檔</button>
      <button id="go" class="btn" type="button" style="margin-left:8px">開始分析</button>
    </div>

    <div id="err" class="row"></div>
    <div class="hint">提示：本頁只做上傳與分析，其他欄位不顯示。分析中會出現全螢幕 Loading。</div>
  </div>
</div>

<script>
  // 若已分析完成，就直接看結果頁
  (function () {
    try {
      const raw = localStorage.getItem("sa_result");
      if (raw && JSON.parse(raw)) location.replace("/static/result.html");
    } catch {}
  })();

  // 必須登入
  (function () {
    const u = localStorage.getItem("sa_user");
    if (!u) { location.replace("/static/landing.html"); return; }
    try {
      const j = JSON.parse(u);
      document.getElementById("email").textContent = j.email || "—";
    } catch { location.replace("/static/landing.html"); }
  })();

  const elErr = document.getElementById("err");

  function showErr(text) {
    elErr.style.display = "block";
    elErr.textContent = text;
  }
  function clearErr(){ elErr.style.display="none"; elErr.textContent=""; }

  // 影像壓縮
  async function compressImage(file, maxSide=1600, quality=0.8) {
    const img = await createImageBitmap(file);
    const w = img.width, h = img.height;
    const ratio = (w > h ? maxSide / w : maxSide / h);
    const nw = Math.round(w * Math.min(1, ratio));
    const nh = Math.round(h * Math.min(1, ratio));
    const canvas = new OffscreenCanvas(nw, nh);
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, nw, nh);
    const blob = await canvas.convertToBlob({ type: "image/jpeg", quality });
    return new File([blob], file.name.replace(/\.\w+$/, ".jpg"), { type:"image/jpeg" });
  }

  // Demo
  document.getElementById("demo").onclick = async () => {
    clearErr();
    alert("Demo：請用你手邊的 IG 截圖；此按鈕僅保留占位目的。");
  };

  // 送出分析
  document.getElementById("go").onclick = async () => {
    clearErr();
    const pf = document.getElementById("profile").files?.[0];
    if (!pf) { showErr("請先選擇 IG 個人頁截圖（必填）"); return; }

    try {
      // 壓縮
      const pComp = await compressImage(pf);
      const fd = new FormData();
      fd.append("profile", pComp);

      const posts = Array.from(document.getElementById("posts").files || []).slice(0,4);
      for (const f of posts) {
        const img = await compressImage(f);
        fd.append("posts", img);
      }

      // 送出
      const res = await fetch("/bd/analyze", { method:"POST", body:fd });
      const data = await res.json().catch(()=> ({}));

      // 將「最後一次分析請求來源」標示，避免跨頁 Race
      localStorage.setItem("sa_last_req", String(Date.now()));

      // 若伺服器回 ok:true 日後可用；此處一律進 Loading 去 poll（避免後端還在跑）
      if (data.ok === false && data.error) {
        showErr("伺服器立即返回錯誤：\n" + JSON.stringify(data, null, 2));
        return;
      }
      location.replace("/static/loading.html");
    } catch (e) {
      showErr("上傳/分析發生錯誤：\n" + (e?.stack || e?.message || String(e)));
    }
  };
</script>
</body>
</html>
