<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Social Avatar ÈÅäÊà≤ÔΩúËßíËâ≤ÂÆ¢Ë£ΩÂåñ</title>
  <link rel="stylesheet" href="/static/app.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      color: #ffffff;
      font-family: 'Arial', sans-serif;
      overflow-x: hidden;
    }
    
    /* ÊòüÁ©∫ËÉåÊôØÂãïÁï´ */
    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: twinkle 2s infinite;
    }
    
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    
    /* ‰∏ªÂÆπÂô® */
    .game-container {
      position: relative;
      z-index: 10;
      display: grid;
      grid-template-columns: 300px 1fr 300px;
      grid-template-rows: 80px 1fr 80px;
      height: 100vh;
      gap: 10px;
      padding: 10px;
    }
    
    /* È†ÇÈÉ®ÁãÄÊÖãÊ¨Ñ */
    .status-bar {
      grid-column: 1 / -1;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      border: 2px solid #4a90e2;
      border-radius: 15px;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .character-name {
      font-size: 24px;
      font-weight: bold;
      color: #4a90e2;
      text-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
    }
    
    .level-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .level-badge {
      background: linear-gradient(45deg, #ff6b6b, #ffd93d);
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      color: #000;
      font-size: 14px;
    }
    
    .power-level {
      background: rgba(74, 144, 226, 0.2);
      padding: 5px 15px;
      border-radius: 20px;
      border: 1px solid #4a90e2;
      font-size: 14px;
    }
    
    .currency-display {
      display: flex;
      gap: 15px;
    }
    
    .currency-item {
      display: flex;
      align-items: center;
      gap: 5px;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 12px;
      border-radius: 15px;
      font-size: 14px;
    }
    
    /* Â∑¶ÂÅ¥ÈÅìÂÖ∑Ê¨Ñ */
    .inventory-panel {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #4a90e2;
      border-radius: 15px;
      padding: 20px;
      overflow-y: auto;
    }
    
    .panel-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #4a90e2;
      text-align: center;
      border-bottom: 2px solid rgba(74, 144, 226, 0.3);
      padding-bottom: 10px;
    }
    
    .category-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .category-tab {
      flex: 1;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(74, 144, 226, 0.3);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    
    .category-tab.active {
      background: rgba(74, 144, 226, 0.3);
      border-color: #4a90e2;
    }
    
    .items-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .item-card {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(74, 144, 226, 0.3);
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      text-align: center;
    }
    
    .item-card:hover {
      border-color: #4a90e2;
      background: rgba(74, 144, 226, 0.1);
      transform: translateY(-2px);
    }
    
    .item-card.equipped {
      border-color: #4a90e2;
      background: rgba(74, 144, 226, 0.2);
      box-shadow: 0 0 15px rgba(74, 144, 226, 0.5);
    }
    
    .item-card.premium {
      border-color: #ffd700;
      background: rgba(255, 215, 0, 0.1);
    }
    
    .item-card.premium::after {
      content: 'üíé';
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 12px;
    }
    
    .item-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .item-name {
      font-size: 12px;
      margin-bottom: 3px;
    }
    
    .item-power {
      font-size: 10px;
      color: #4a90e2;
    }
    
    .item-price {
      font-size: 10px;
      color: #ffd700;
      margin-top: 3px;
    }
    
    /* ‰∏≠Â§ÆËßíËâ≤Â±ïÁ§∫ÂçÄ */
    .character-display {
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid #4a90e2;
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    
    .character-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .character-video {
      max-width: 100%;
      max-height: 400px;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(74, 144, 226, 0.3);
      z-index: 2;
    }
    
    .equipment-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 3;
    }
    
    .equipped-item {
      position: absolute;
      font-size: 40px;
      text-shadow: 0 0 10px rgba(74, 144, 226, 0.8);
      animation: itemGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes itemGlow {
      0% { filter: brightness(1); }
      100% { filter: brightness(1.3); }
    }
    
    .weapon-overlay { top: 20%; right: 10%; }
    .armor-overlay { top: 30%; left: 10%; }
    .accessory-overlay { top: 15%; left: 50%; transform: translateX(-50%); }
    .special-overlay { top: 5%; right: 20%; }
    
    .character-stats {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #4a90e2;
    }
    
    .stat-label {
      font-size: 12px;
      color: #888;
    }
    
    /* Âè≥ÂÅ¥ËÉåÊôØÂíåËºâÂÖ∑Èù¢Êùø */
    .customization-panel {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #4a90e2;
      border-radius: 15px;
      padding: 20px;
      overflow-y: auto;
    }
    
    .background-section {
      margin-bottom: 20px;
    }
    
    .background-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .background-option {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(74, 144, 226, 0.3);
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .background-option:hover {
      border-color: #4a90e2;
    }
    
    .background-option.selected {
      border-color: #4a90e2;
      background: rgba(74, 144, 226, 0.2);
    }
    
    .background-option.premium {
      border-color: #ffd700;
    }
    
    .background-preview {
      width: 100%;
      height: 60px;
      border-radius: 5px;
      margin-bottom: 5px;
      background-size: cover;
      background-position: center;
    }
    
    .background-name {
      font-size: 12px;
    }
    
    .vehicle-section {
      margin-bottom: 20px;
    }
    
    .vehicle-display {
      text-align: center;
      padding: 15px;
      background: rgba(74, 144, 226, 0.1);
      border-radius: 10px;
      border: 1px solid rgba(74, 144, 226, 0.3);
    }
    
    .vehicle-image {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      margin: 10px auto;
      display: block;
      border: 2px solid #4a90e2;
    }
    
    .vehicle-name {
      font-size: 14px;
      color: #4a90e2;
      margin-top: 5px;
    }
    
    .vehicle-level {
      font-size: 12px;
      color: #888;
      margin-top: 3px;
    }
    
    /* Â∫ïÈÉ®ÊéßÂà∂Ê¨Ñ */
    .control-bar {
      grid-column: 1 / -1;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      border: 2px solid #4a90e2;
      border-radius: 15px;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #4a90e2, #357abd);
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(45deg, #357abd, #2c5aa0);
      transform: translateY(-2px);
    }
    
    .btn-premium {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #000;
    }
    
    .btn-premium:hover {
      background: linear-gradient(45deg, #ffed4e, #ffd700);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(74, 144, 226, 0.5);
    }
    
    .btn-secondary:hover {
      background: rgba(74, 144, 226, 0.2);
    }
    
    .level-progress {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .progress-bar {
      width: 200px;
      height: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(45deg, #4a90e2, #357abd);
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      font-size: 12px;
      color: #888;
    }
    
    /* ÈüøÊáâÂºèË®≠Ë®à */
    @media (max-width: 1200px) {
      .game-container {
        grid-template-columns: 250px 1fr 250px;
      }
    }
    
    @media (max-width: 768px) {
      .game-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
        height: auto;
        min-height: 100vh;
      }
      
      .inventory-panel,
      .customization-panel {
        order: 2;
      }
      
      .character-display {
        order: 1;
        height: 400px;
      }
      
      .items-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .background-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- ÊòüÁ©∫ËÉåÊôØ -->
  <div class="stars" id="stars"></div>

  <div class="game-container">
    <!-- È†ÇÈÉ®ÁãÄÊÖãÊ¨Ñ -->
    <div class="status-bar">
      <div class="user-info">
        <div class="character-name" id="characterName">@username</div>
        <div class="level-info">
          <div class="level-badge" id="levelBadge">Lv.1</div>
          <div class="power-level" id="powerLevel">Êà∞Âäõ: 0</div>
        </div>
      </div>
      <div class="currency-display">
        <div class="currency-item">
          <span>üíé</span>
          <span id="diamonds">0</span>
        </div>
        <div class="currency-item">
          <span>‚≠ê</span>
          <span id="stars">951</span>
        </div>
        <div class="currency-item">
          <span>üí∞</span>
          <span id="coins">21.82Ëê¨</span>
        </div>
      </div>
    </div>

    <!-- Â∑¶ÂÅ¥ÈÅìÂÖ∑Ê¨Ñ -->
    <div class="inventory-panel">
      <div class="panel-title">ÈÅìÂÖ∑Ê¨Ñ</div>
      <div class="category-tabs">
        <div class="category-tab active" data-category="all">ÂÖ®ÈÉ®</div>
        <div class="category-tab" data-category="weapon">Ê≠¶Âô®</div>
        <div class="category-tab" data-category="armor">Ë≠∑Áî≤</div>
        <div class="category-tab" data-category="accessory">È£æÂìÅ</div>
        <div class="category-tab" data-category="special">ÁâπÊÆä</div>
      </div>
      <div class="items-grid" id="itemsGrid">
        <!-- ÈÅìÂÖ∑È†ÖÁõÆÂ∞áÁî±JavaScriptÂãïÊÖãÁîüÊàê -->
      </div>
    </div>

    <!-- ‰∏≠Â§ÆËßíËâ≤Â±ïÁ§∫ÂçÄ -->
    <div class="character-display">
      <div class="character-container">
        <video id="characterVideo" class="character-video" autoplay muted loop style="display: none;">
          <source src="" type="video/mp4">
        </video>
        <div id="characterPlaceholder" class="character-video" style="display: flex; align-items: center; justify-content: center; background: rgba(74, 144, 226, 0.1); height: 300px;">
          ËºâÂÖ•ËßíËâ≤‰∏≠...
        </div>
        
        <!-- Ë£ùÂÇôÁñäÂä†Â±§ -->
        <div class="equipment-overlay">
          <div class="equipped-item weapon-overlay" id="weaponOverlay" style="display: none;"></div>
          <div class="equipped-item armor-overlay" id="armorOverlay" style="display: none;"></div>
          <div class="equipped-item accessory-overlay" id="accessoryOverlay" style="display: none;"></div>
          <div class="equipped-item special-overlay" id="specialOverlay" style="display: none;"></div>
        </div>
      </div>
      
      <div class="character-stats">
        <div class="stat-item">
          <div class="stat-value" id="attackPower">0</div>
          <div class="stat-label">ÊîªÊìäÂäõ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="defensePower">0</div>
          <div class="stat-label">Èò≤Á¶¶Âäõ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="magicPower">0</div>
          <div class="stat-label">È≠îÊ≥ïÂäõ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="speedPower">0</div>
          <div class="stat-label">ÈÄüÂ∫¶</div>
        </div>
      </div>
    </div>

    <!-- Âè≥ÂÅ¥ËÉåÊôØÂíåËºâÂÖ∑Èù¢Êùø -->
    <div class="customization-panel">
      <div class="background-section">
        <div class="panel-title">ËÉåÊôØÈ¢®Ê†º</div>
        <div class="background-grid" id="backgroundGrid">
          <!-- ËÉåÊôØÈÅ∏È†ÖÂ∞áÁî±JavaScriptÂãïÊÖãÁîüÊàê -->
        </div>
      </div>
      
      <div class="vehicle-section">
        <div class="panel-title">ËºâÂÖ∑</div>
        <div class="vehicle-display">
          <img id="vehicleImage" class="vehicle-image" src="" alt="ËºâÂÖ∑" style="display: none;">
          <div class="vehicle-name" id="vehicleName">Âü∫Á§éËºâÂÖ∑</div>
          <div class="vehicle-level" id="vehicleLevel">Á≠âÁ¥ö 1</div>
        </div>
      </div>
    </div>

    <!-- Â∫ïÈÉ®ÊéßÂà∂Ê¨Ñ -->
    <div class="control-bar">
      <div class="level-progress">
        <div class="progress-text">‰∏ã‰∏ÄÁ≠âÁ¥ö</div>
        <div class="progress-bar">
          <div class="progress-fill" id="levelProgress" style="width: 0%"></div>
        </div>
        <div class="progress-text" id="levelProgressText">0/1000</div>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="saveCharacter()">ÂÑ≤Â≠òËßíËâ≤</button>
        <button class="btn btn-premium" onclick="openShop()">ÂïÜÂ∫ó</button>
        <button class="btn btn-secondary" onclick="goBackToResult()">ËøîÂõûÁµêÊûú</button>
      </div>
    </div>
  </div>

  <script>
    // ÈÅäÊà≤Êï∏Êìö
    let gameData = {
      character: {
        mbti: '',
        gender: '',
        username: '',
        followers: 0,
        level: 1,
        experience: 0,
        power: 0
      },
      equipment: {
        weapon: null,
        armor: null,
        accessory: null,
        special: null
      },
      inventory: [],
      background: 'default',
      currency: {
        diamonds: 0,
        stars: 951,
        coins: 218200
      }
    };

    // ÈÅìÂÖ∑Êï∏ÊìöÂ∫´
    const itemDatabase = {
      weapon: [
        { id: 'sword_basic', name: 'Âü∫Á§éÂäç', icon: '‚öîÔ∏è', power: 100, type: 'weapon', premium: false, price: 0, stats: { attack: 100, defense: 0, magic: 0, speed: 0 } },
        { id: 'sword_fire', name: 'ÁÅ´ÁÑ∞Âäç', icon: 'üî•', power: 500, type: 'weapon', premium: true, price: 100, stats: { attack: 500, defense: 0, magic: 200, speed: 0 } },
        { id: 'sword_ice', name: 'ÂÜ∞ÈúúÂäç', icon: '‚ùÑÔ∏è', power: 500, type: 'weapon', premium: true, price: 100, stats: { attack: 500, defense: 0, magic: 200, speed: 0 } },
        { id: 'staff_lightning', name: 'Èõ∑ÈõªÊ≥ïÊùñ', icon: '‚ö°', power: 800, type: 'weapon', premium: true, price: 200, stats: { attack: 300, defense: 0, magic: 800, speed: 100 } }
      ],
      armor: [
        { id: 'armor_basic', name: 'Âü∫Á§éË≠∑Áî≤', icon: 'üõ°Ô∏è', power: 50, type: 'armor', premium: false, price: 0, stats: { attack: 0, defense: 100, magic: 0, speed: 0 } },
        { id: 'armor_plate', name: 'ÊùøÁî≤', icon: 'üõ°Ô∏è', power: 300, type: 'armor', premium: true, price: 150, stats: { attack: 0, defense: 500, magic: 0, speed: -50 } },
        { id: 'robe_magic', name: 'È≠îÊ≥ïË¢ç', icon: 'üßô', power: 400, type: 'armor', premium: true, price: 200, stats: { attack: 0, defense: 200, magic: 600, speed: 100 } }
      ],
      accessory: [
        { id: 'ring_power', name: 'ÂäõÈáèÊàíÊåá', icon: 'üíç', power: 200, type: 'accessory', premium: true, price: 100, stats: { attack: 200, defense: 0, magic: 0, speed: 0 } },
        { id: 'amulet_wisdom', name: 'Êô∫ÊÖßË≠∑Á¨¶', icon: 'üîÆ', power: 300, type: 'accessory', premium: true, price: 150, stats: { attack: 0, defense: 0, magic: 400, speed: 0 } },
        { id: 'crown_royal', name: 'ÁöáÂÆ∂ÁéãÂÜ†', icon: 'üëë', power: 500, type: 'accessory', premium: true, price: 300, stats: { attack: 200, defense: 200, magic: 200, speed: 100 } }
      ],
      special: [
        { id: 'wings_angel', name: 'Â§©‰Ωø‰πãÁøº', icon: 'üëº', power: 1000, type: 'special', premium: true, price: 500, stats: { attack: 0, defense: 0, magic: 0, speed: 1000 } },
        { id: 'halo_divine', name: 'Á•ûËÅñÂÖâÁí∞', icon: 'üòá', power: 800, type: 'special', premium: true, price: 400, stats: { attack: 200, defense: 200, magic: 400, speed: 0 } },
        { id: 'aura_dragon', name: 'Èæç‰πãÊ∞£ÊÅØ', icon: 'üêâ', power: 1200, type: 'special', premium: true, price: 600, stats: { attack: 600, defense: 0, magic: 600, speed: 0 } }
      ]
    };

    // ËÉåÊôØÈÅ∏È†Ö
    const backgroundOptions = [
      { id: 'default', name: 'ÈªòË™ç', preview: 'linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%)', premium: false },
      { id: 'forest', name: 'Ê£ÆÊûó', preview: 'linear-gradient(135deg, #0d4f3c 0%, #1a5f4a 50%, #2d7a5f 100%)', premium: false },
      { id: 'ocean', name: 'Êµ∑Ê¥ã', preview: 'linear-gradient(135deg, #0c4a6e 0%, #1e5f8f 50%, #2d7aa0 100%)', premium: false },
      { id: 'space', name: 'Â§™Á©∫', preview: 'linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%)', premium: true },
      { id: 'crystal', name: 'Ê∞¥Êô∂', preview: 'linear-gradient(135deg, #4a148c 0%, #7b1fa2 50%, #ab47bc 100%)', premium: true },
      { id: 'golden', name: 'ÈªÉÈáë', preview: 'linear-gradient(135deg, #ff8f00 0%, #ffa000 50%, #ffb300 100%)', premium: true }
    ];

    // ËºâÂÖ∑Á≠âÁ¥ö
    const vehicleLevels = {
      0: { name: 'Ê≠•Ë°å', image: '/static/images/vehicles/walk.png', level: 1, power: 0 },
      1000: { name: 'Ëá™Ë°åËªä', image: '/static/images/vehicles/bicycle.png', level: 2, power: 1000 },
      5000: { name: 'Êë©ÊâòËªä', image: '/static/images/vehicles/motorcycle.png', level: 3, power: 2000 },
      10000: { name: 'Ê±ΩËªä', image: '/static/images/vehicles/car.png', level: 4, power: 5000 },
      50000: { name: 'Ë∑ëËªä', image: '/static/images/vehicles/sports_car.png', level: 5, power: 10000 },
      100000: { name: 'Áõ¥ÂçáÊ©ü', image: '/static/images/vehicles/helicopter.png', level: 6, power: 20000 },
      500000: { name: 'ÁßÅ‰∫∫È£õÊ©ü', image: '/static/images/vehicles/private_jet.png', level: 7, power: 50000 },
      1000000: { name: 'Â§™Á©∫Ëàπ', image: '/static/images/vehicles/spaceship.png', level: 8, power: 100000 }
    };

    // ÂàùÂßãÂåñÈÅäÊà≤
    function initGame() {
      loadCharacterData();
      createStars();
      initializeInventory();
      initializeBackgrounds();
      loadCharacterVideo();
      loadVehicle();
      updateUI();
    }

    // ËºâÂÖ•ËßíËâ≤Êï∏Êìö
    function loadCharacterData() {
      const saved = sessionStorage.getItem('sa_result');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (data && data.ok === true) {
            gameData.character.mbti = data.mbti || '';
            gameData.character.gender = data.gender || '';
            gameData.character.username = data.username || '';
            gameData.character.followers = data.followers || 0;
            
            // Ë®àÁÆóÁ≠âÁ¥öÂíåÁ∂ìÈ©ó
            calculateLevel();
            
            // ÂàùÂßãÂåñÈÅìÂÖ∑Ê¨Ñ
            initializePlayerInventory();
          }
        } catch (e) {
          console.error('Failed to parse character data:', e);
        }
      }
    }

    // Ë®àÁÆóÁ≠âÁ¥ö
    function calculateLevel() {
      const followers = gameData.character.followers;
      const baseLevel = Math.floor(followers / 1000) + 1;
      const experience = followers % 1000;
      
      gameData.character.level = Math.max(1, baseLevel);
      gameData.character.experience = experience;
      
      // Ë®àÁÆóÁ∏ΩÊà∞Âäõ
      gameData.character.power = calculateTotalPower();
    }

    // Ë®àÁÆóÁ∏ΩÊà∞Âäõ
    function calculateTotalPower() {
      let totalPower = 1000; // Âü∫Á§éÊà∞Âäõ
      
      // Á≤âÁµ≤Êà∞Âäõ
      totalPower += Math.floor(gameData.character.followers / 100);
      
      // MBTIÊà∞Âäõ
      const mbtiPowers = {
        'INTJ': 200, 'INTP': 180, 'ENTJ': 190, 'ENTP': 170,
        'INFJ': 160, 'INFP': 140, 'ENFJ': 150, 'ENFP': 130,
        'ISTJ': 120, 'ISFJ': 100, 'ESTJ': 110, 'ESFJ': 90,
        'ISTP': 80, 'ISFP': 60, 'ESTP': 70, 'ESFP': 50
      };
      totalPower += mbtiPowers[gameData.character.mbti] || 0;
      
      // Ë£ùÂÇôÊà∞Âäõ
      Object.values(gameData.equipment).forEach(item => {
        if (item) totalPower += item.power;
      });
      
      return totalPower;
    }

    // ÂâµÂª∫ÊòüÁ©∫ËÉåÊôØ
    function createStars() {
      const starsContainer = document.getElementById('stars');
      for (let i = 0; i < 100; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.width = Math.random() * 3 + 1 + 'px';
        star.style.height = star.style.width;
        star.style.animationDelay = Math.random() * 2 + 's';
        starsContainer.appendChild(star);
      }
    }

    // ÂàùÂßãÂåñÈÅìÂÖ∑Ê¨Ñ
    function initializeInventory() {
      const itemsGrid = document.getElementById('itemsGrid');
      itemsGrid.innerHTML = '';
      
      // Âêà‰ΩµÊâÄÊúâÈÅìÂÖ∑
      const allItems = [
        ...itemDatabase.weapon,
        ...itemDatabase.armor,
        ...itemDatabase.accessory,
        ...itemDatabase.special
      ];
      
      allItems.forEach(item => {
        const itemEl = createItemCard(item);
        itemsGrid.appendChild(itemEl);
      });
      
      // Ê∑ªÂä†ÂàÜÈ°ûÁØ©ÈÅ∏
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', () => filterItems(tab.dataset.category));
      });
    }

    // ÂâµÂª∫ÈÅìÂÖ∑Âç°Áâá
    function createItemCard(item) {
      const itemEl = document.createElement('div');
      itemEl.className = `item-card ${item.premium ? 'premium' : ''}`;
      itemEl.dataset.itemId = item.id;
      itemEl.dataset.itemType = item.type;
      
      itemEl.innerHTML = `
        <div class="item-icon">${item.icon}</div>
        <div class="item-name">${item.name}</div>
        <div class="item-power">+${item.power}</div>
        ${item.premium ? `<div class="item-price">${item.price}üíé</div>` : ''}
      `;
      
      itemEl.addEventListener('click', () => equipItem(item));
      return itemEl;
    }

    // ÁØ©ÈÅ∏ÈÅìÂÖ∑
    function filterItems(category) {
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-category="${category}"]`).classList.add('active');
      
      document.querySelectorAll('.item-card').forEach(card => {
        if (category === 'all' || card.dataset.itemType === category) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    }

    // Ë£ùÂÇôÈÅìÂÖ∑
    function equipItem(item) {
      const slotType = item.type;
      
      // Â¶ÇÊûúË©≤Ê¨Ñ‰ΩçÂ∑≤ÊúâË£ùÂÇôÔºåÂÖàÂç∏‰∏ã
      if (gameData.equipment[slotType]) {
        unequipItem(slotType);
      }
      
      // Ë£ùÂÇôÊñ∞ÈÅìÂÖ∑
      gameData.equipment[slotType] = item;
      
      // Êõ¥Êñ∞È°ØÁ§∫
      updateEquipmentDisplay();
      updateUI();
      
      // È°ØÁ§∫Ë£ùÂÇôÊïàÊûú
      showEquipEffect(item);
    }

    // Âç∏‰∏ãÈÅìÂÖ∑
    function unequipItem(slotType) {
      gameData.equipment[slotType] = null;
      updateEquipmentDisplay();
      updateUI();
    }

    // Êõ¥Êñ∞Ë£ùÂÇôÈ°ØÁ§∫
    function updateEquipmentDisplay() {
      // Êõ¥Êñ∞ÈÅìÂÖ∑Âç°ÁâáÁãÄÊÖã
      document.querySelectorAll('.item-card').forEach(card => {
        const itemId = card.dataset.itemId;
        const isEquipped = Object.values(gameData.equipment).some(item => item && item.id === itemId);
        card.classList.toggle('equipped', isEquipped);
      });
      
      // Êõ¥Êñ∞ËßíËâ≤‰∏äÁöÑË£ùÂÇôÁñäÂä†
      Object.keys(gameData.equipment).forEach(slot => {
        const item = gameData.equipment[slot];
        const overlay = document.getElementById(`${slot}Overlay`);
        
        if (item) {
          overlay.textContent = item.icon;
          overlay.style.display = 'block';
        } else {
          overlay.style.display = 'none';
        }
      });
    }

    // È°ØÁ§∫Ë£ùÂÇôÊïàÊûú
    function showEquipEffect(item) {
      // ÂâµÂª∫Ë£ùÂÇôÊïàÊûúÂãïÁï´
      const effect = document.createElement('div');
      effect.style.position = 'absolute';
      effect.style.top = '50%';
      effect.style.left = '50%';
      effect.style.transform = 'translate(-50%, -50%)';
      effect.style.fontSize = '40px';
      effect.style.color = '#4a90e2';
      effect.style.pointerEvents = 'none';
      effect.style.zIndex = '1000';
      effect.textContent = `+${item.power}`;
      
      document.querySelector('.character-display').appendChild(effect);
      
      // ÂãïÁï´ÊïàÊûú
      effect.animate([
        { transform: 'translate(-50%, -50%) scale(0)', opacity: 0 },
        { transform: 'translate(-50%, -70%) scale(1.2)', opacity: 1 },
        { transform: 'translate(-50%, -90%) scale(1)', opacity: 0 }
      ], {
        duration: 1000,
        easing: 'ease-out'
      }).onfinish = () => effect.remove();
    }

    // ÂàùÂßãÂåñËÉåÊôØÈÅ∏È†Ö
    function initializeBackgrounds() {
      const backgroundGrid = document.getElementById('backgroundGrid');
      backgroundGrid.innerHTML = '';
      
      backgroundOptions.forEach(bg => {
        const bgEl = document.createElement('div');
        bgEl.className = `background-option ${bg.premium ? 'premium' : ''} ${bg.id === gameData.background ? 'selected' : ''}`;
        bgEl.innerHTML = `
          <div class="background-preview" style="background: ${bg.preview}"></div>
          <div class="background-name">${bg.name}</div>
        `;
        
        bgEl.addEventListener('click', () => selectBackground(bg));
        backgroundGrid.appendChild(bgEl);
      });
    }

    // ÈÅ∏ÊìáËÉåÊôØ
    function selectBackground(bg) {
      gameData.background = bg.id;
      document.body.style.background = bg.preview;
      
      // Êõ¥Êñ∞ÈÅ∏‰∏≠ÁãÄÊÖã
      document.querySelectorAll('.background-option').forEach(el => el.classList.remove('selected'));
      event.target.closest('.background-option').classList.add('selected');
    }

    // ËºâÂÖ•ËßíËâ≤Ë¶ñÈ†ª
    function loadCharacterVideo() {
      const videoEl = document.getElementById('characterVideo');
      const placeholderEl = document.getElementById('characterPlaceholder');
      
      if (!gameData.character.mbti || !gameData.character.gender) {
        placeholderEl.textContent = 'ÁÑ°Ê≥ïËºâÂÖ•ËßíËâ≤ÔºöÁº∫Â∞ë MBTI ÊàñÊÄßÂà•Ë≥áË®ä';
        return;
      }

      const mbtiType = String(gameData.character.mbti).toUpperCase().trim();
      const videoPath = `/static/videos/mbti/${mbtiType}_${gameData.character.gender}.mp4`;
      
      videoEl.src = videoPath;
      
      videoEl.addEventListener('loadeddata', function() {
        videoEl.style.display = 'block';
        placeholderEl.style.display = 'none';
      });
      
      videoEl.addEventListener('error', function() {
        placeholderEl.textContent = `ÁÑ°Ê≥ïËºâÂÖ• ${mbtiType} ËßíËâ≤Ë¶ñÈ†ª`;
        placeholderEl.style.color = '#ff6b6b';
      });
    }

    // ËºâÂÖ•ËºâÂÖ∑
    function loadVehicle() {
      const vehicleImage = document.getElementById('vehicleImage');
      const vehicleName = document.getElementById('vehicleName');
      const vehicleLevel = document.getElementById('vehicleLevel');
      
      // Ê†πÊìöÁ≤âÁµ≤Êï∏ÈÅ∏ÊìáËºâÂÖ∑
      let selectedVehicle = vehicleLevels[0];
      for (let threshold in vehicleLevels) {
        if (gameData.character.followers >= parseInt(threshold)) {
          selectedVehicle = vehicleLevels[threshold];
        }
      }
      
      vehicleImage.src = selectedVehicle.image;
      vehicleImage.style.display = 'block';
      vehicleName.textContent = selectedVehicle.name;
      vehicleLevel.textContent = `Á≠âÁ¥ö ${selectedVehicle.level}`;
    }

    // ÂàùÂßãÂåñÁé©ÂÆ∂ÈÅìÂÖ∑Ê¨Ñ
    function initializePlayerInventory() {
      // Áµ¶Áé©ÂÆ∂‰∏Ä‰∫õÂü∫Á§éÈÅìÂÖ∑
      gameData.inventory = [
        itemDatabase.weapon[0], // Âü∫Á§éÂäç
        itemDatabase.armor[0]   // Âü∫Á§éË≠∑Áî≤
      ];
    }

    // Êõ¥Êñ∞UI
    function updateUI() {
      // Êõ¥Êñ∞ËßíËâ≤‰ø°ÊÅØ
      document.getElementById('characterName').textContent = gameData.character.username ? `@${gameData.character.username}` : 'ÂåøÂêçÁî®Êà∂';
      document.getElementById('levelBadge').textContent = `Lv.${gameData.character.level}`;
      document.getElementById('powerLevel').textContent = `Êà∞Âäõ: ${gameData.character.power.toLocaleString()}`;
      
      // Êõ¥Êñ∞Ë≤®Âπ£
      document.getElementById('diamonds').textContent = gameData.currency.diamonds;
      document.getElementById('stars').textContent = gameData.currency.stars;
      document.getElementById('coins').textContent = (gameData.currency.coins / 10000).toFixed(2) + 'Ëê¨';
      
      // Êõ¥Êñ∞Â±¨ÊÄß
      updateStats();
      
      // Êõ¥Êñ∞Á≠âÁ¥öÈÄ≤Â∫¶
      updateLevelProgress();
    }

    // Êõ¥Êñ∞Â±¨ÊÄß
    function updateStats() {
      let attack = 0, defense = 0, magic = 0, speed = 0;
      
      Object.values(gameData.equipment).forEach(item => {
        if (item) {
          attack += item.stats.attack;
          defense += item.stats.defense;
          magic += item.stats.magic;
          speed += item.stats.speed;
        }
      });
      
      document.getElementById('attackPower').textContent = attack;
      document.getElementById('defensePower').textContent = defense;
      document.getElementById('magicPower').textContent = magic;
      document.getElementById('speedPower').textContent = speed;
    }

    // Êõ¥Êñ∞Á≠âÁ¥öÈÄ≤Â∫¶
    function updateLevelProgress() {
      const nextLevelExp = 1000;
      const progress = (gameData.character.experience / nextLevelExp) * 100;
      
      document.getElementById('levelProgress').style.width = progress + '%';
      document.getElementById('levelProgressText').textContent = `${gameData.character.experience}/${nextLevelExp}`;
    }

    // ÂÑ≤Â≠òËßíËâ≤
    function saveCharacter() {
      // Â∞áËßíËâ≤Êï∏Êìö‰øùÂ≠òÂà∞sessionStorage
      sessionStorage.setItem('sa_character', JSON.stringify(gameData));
      alert('ËßíËâ≤Â∑≤ÂÑ≤Â≠òÔºÅ');
    }

    // ÊâìÈñãÂïÜÂ∫ó
    function openShop() {
      alert('ÂïÜÂ∫óÂäüËÉΩÈñãÁôº‰∏≠...');
    }

    // ËøîÂõûÁµêÊûúÈ†ÅÈù¢
    function goBackToResult() {
      window.location.href = '/static/result.html';
    }

    // ÂàùÂßãÂåñÈÅäÊà≤
    window.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>
