<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Social Avatar éŠæˆ²ï½œè§’è‰²å®¢è£½åŒ–</title>
  <link rel="stylesheet" href="/static/app.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      color: #ffffff;
      font-family: 'Arial', sans-serif;
      overflow-x: hidden;
    }
    
    /* æ˜Ÿç©ºèƒŒæ™¯å‹•ç•« */
    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: twinkle 2s infinite;
    }
    
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    
    /* ä¸»å®¹å™¨ */
    .game-container {
      position: relative;
      z-index: 10;
      display: grid;
      grid-template-columns: 300px 1fr 300px;
      grid-template-rows: 80px 1fr 80px;
      height: 100vh;
      gap: 10px;
      padding: 10px;
    }
    
    /* é ‚éƒ¨ç‹€æ…‹æ¬„ */
    .status-bar {
      grid-column: 1 / -1;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      border: 2px solid #4a90e2;
      border-radius: 15px;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .character-name {
      font-size: 24px;
      font-weight: bold;
      color: #4a90e2;
      text-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
    }
    
    .level-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .level-badge {
      background: linear-gradient(45deg, #ff6b6b, #ffd93d);
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      color: #000;
      font-size: 14px;
    }
    
    .power-level {
      background: rgba(74, 144, 226, 0.2);
      padding: 5px 15px;
      border-radius: 20px;
      border: 1px solid #4a90e2;
      font-size: 14px;
    }
    
    .currency-display {
      display: flex;
      gap: 15px;
    }
    
    .currency-item {
      display: flex;
      align-items: center;
      gap: 5px;
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 12px;
      border-radius: 15px;
      font-size: 14px;
    }
    
    /* å·¦å´é“å…·æ¬„ */
    .inventory-panel {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #4a90e2;
      border-radius: 15px;
      padding: 20px;
      overflow-y: auto;
    }
    
    .panel-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #4a90e2;
      text-align: center;
      border-bottom: 2px solid rgba(74, 144, 226, 0.3);
      padding-bottom: 10px;
    }
    
    .category-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .category-tab {
      flex: 1;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(74, 144, 226, 0.3);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    
    .category-tab.active {
      background: rgba(74, 144, 226, 0.3);
      border-color: #4a90e2;
    }
    
    .items-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .item-card {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(74, 144, 226, 0.3);
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      text-align: center;
    }
    
    .item-card:hover {
      border-color: #4a90e2;
      background: rgba(74, 144, 226, 0.1);
      transform: translateY(-2px);
    }
    
    .item-card.equipped {
      border-color: #4a90e2;
      background: rgba(74, 144, 226, 0.2);
      box-shadow: 0 0 15px rgba(74, 144, 226, 0.5);
    }
    
    .item-card.premium {
      border-color: #ffd700;
      background: rgba(255, 215, 0, 0.1);
    }
    
    .item-card.premium::after {
      content: 'ğŸ’';
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 12px;
    }
    
    .item-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .item-name {
      font-size: 12px;
      margin-bottom: 3px;
    }
    
    .item-power {
      font-size: 10px;
      color: #4a90e2;
    }
    
    .item-price {
      font-size: 10px;
      color: #ffd700;
      margin-top: 3px;
    }
    
    /* ä¸­å¤®è§’è‰²å±•ç¤ºå€ */
    .character-display {
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid #4a90e2;
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    
    .character-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .character-video {
      max-width: 100%;
      max-height: 400px;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(74, 144, 226, 0.3);
      z-index: 2;
    }
    
    .equipment-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 3;
      perspective: 1000px;
    }
    
    .equipped-item {
      position: absolute;
      font-size: 40px;
      text-shadow: 0 0 10px rgba(74, 144, 226, 0.8);
      animation: itemGlow 2s ease-in-out infinite alternate;
      transform-style: preserve-3d;
    }
    
    @keyframes itemGlow {
      0% { filter: brightness(1); }
      100% { filter: brightness(1.3); }
    }
    
    /* æ­¦å™¨å‹•ç•« - è§’è‰²æ‰‹æŒæ­¦å™¨ */
    .weapon-overlay {
      top: 60%;
      right: 15%;
      animation: weaponSwing 3s ease-in-out infinite, itemGlow 2s ease-in-out infinite alternate;
      transform-origin: bottom center;
    }
    
    @keyframes weaponSwing {
      0%, 100% { transform: rotate(-10deg) translateY(0px); }
      25% { transform: rotate(-5deg) translateY(-5px); }
      50% { transform: rotate(0deg) translateY(-10px); }
      75% { transform: rotate(5deg) translateY(-5px); }
    }
    
    /* è­·ç”²å‹•ç•« - è§’è‰²ç©¿è‘—è­·ç”² */
    .armor-overlay {
      top: 40%;
      left: 50%;
      transform: translateX(-50%);
      animation: armorPulse 2s ease-in-out infinite, itemGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes armorPulse {
      0%, 100% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.1); }
    }
    
    /* é£¾å“å‹•ç•« - è§’è‰²ä½©æˆ´é£¾å“ */
    .accessory-overlay {
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      animation: accessoryFloat 2.5s ease-in-out infinite, itemGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes accessoryFloat {
      0%, 100% { transform: translateX(-50%) translateY(0px) rotate(0deg); }
      25% { transform: translateX(-50%) translateY(-8px) rotate(5deg); }
      50% { transform: translateX(-50%) translateY(-15px) rotate(0deg); }
      75% { transform: translateX(-50%) translateY(-8px) rotate(-5deg); }
    }
    
    /* ç‰¹æ®Šé“å…·å‹•ç•« - ç’°ç¹è§’è‰² */
    .special-overlay {
      top: 50%;
      left: 50%;
      transform: translateX(-50%) translateY(-50%);
      animation: specialOrbit 4s linear infinite, itemGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes specialOrbit {
      0% { transform: translateX(-50%) translateY(-50%) rotate(0deg) translateX(80px) rotate(0deg); }
      100% { transform: translateX(-50%) translateY(-50%) rotate(360deg) translateX(80px) rotate(-360deg); }
    }
    
    /* é“å…·äº’å‹•æ•ˆæœ */
    .equipped-item.interacting {
      animation-play-state: paused;
      transform: scale(1.2);
    }
    
    /* é“å…·é€²å…¥å‹•ç•« */
    .equipped-item.entering {
      animation: itemEnter 0.5s ease-out;
    }
    
    @keyframes itemEnter {
      0% { 
        transform: scale(0) rotate(180deg);
        opacity: 0;
      }
      50% {
        transform: scale(1.2) rotate(90deg);
        opacity: 0.8;
      }
      100% { 
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }
    
    /* é“å…·é›¢é–‹å‹•ç•« */
    .equipped-item.leaving {
      animation: itemLeave 0.3s ease-in;
    }
    
    @keyframes itemLeave {
      0% { 
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
      100% { 
        transform: scale(0) rotate(-180deg);
        opacity: 0;
      }
    }
    
    .character-stats {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #4a90e2;
    }
    
    .stat-label {
      font-size: 12px;
      color: #888;
    }
    
    /* å³å´èƒŒæ™¯å’Œè¼‰å…·é¢æ¿ */
    .customization-panel {
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid #4a90e2;
      border-radius: 15px;
      padding: 20px;
      overflow-y: auto;
    }
    
    .background-section {
      margin-bottom: 20px;
    }
    
    .background-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .background-option {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(74, 144, 226, 0.3);
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .background-option:hover {
      border-color: #4a90e2;
    }
    
    .background-option.selected {
      border-color: #4a90e2;
      background: rgba(74, 144, 226, 0.2);
    }
    
    .background-option.premium {
      border-color: #ffd700;
    }
    
    .background-preview {
      width: 100%;
      height: 60px;
      border-radius: 5px;
      margin-bottom: 5px;
      background-size: cover;
      background-position: center;
    }
    
    .background-name {
      font-size: 12px;
    }
    
    .vehicle-section {
      margin-bottom: 20px;
    }
    
    .vehicle-display {
      text-align: center;
      padding: 15px;
      background: rgba(74, 144, 226, 0.1);
      border-radius: 10px;
      border: 1px solid rgba(74, 144, 226, 0.3);
    }
    
    .vehicle-image {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      margin: 10px auto;
      display: block;
      border: 2px solid #4a90e2;
    }
    
    .vehicle-name {
      font-size: 14px;
      color: #4a90e2;
      margin-top: 5px;
    }
    
    .vehicle-level {
      font-size: 12px;
      color: #888;
      margin-top: 3px;
    }
    
    /* åº•éƒ¨æ§åˆ¶æ¬„ */
    .control-bar {
      grid-column: 1 / -1;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      border: 2px solid #4a90e2;
      border-radius: 15px;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #4a90e2, #357abd);
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(45deg, #357abd, #2c5aa0);
      transform: translateY(-2px);
    }
    
    .btn-premium {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #000;
    }
    
    .btn-premium:hover {
      background: linear-gradient(45deg, #ffed4e, #ffd700);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(74, 144, 226, 0.5);
    }
    
    .btn-secondary:hover {
      background: rgba(74, 144, 226, 0.2);
    }
    
    .level-progress {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .progress-bar {
      width: 200px;
      height: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(45deg, #4a90e2, #357abd);
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      font-size: 12px;
      color: #888;
    }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 1200px) {
      .game-container {
        grid-template-columns: 250px 1fr 250px;
      }
    }
    
    @media (max-width: 768px) {
      .game-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
        height: auto;
        min-height: 100vh;
      }
      
      .inventory-panel,
      .customization-panel {
        order: 2;
      }
      
      .character-display {
        order: 1;
        height: 400px;
      }
      
      .items-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .background-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
  <div class="stars" id="stars"></div>

  <div class="game-container">
    <!-- é ‚éƒ¨ç‹€æ…‹æ¬„ -->
    <div class="status-bar">
      <div class="user-info">
        <div class="character-name" id="characterName">@username</div>
        <div class="level-info">
          <div class="level-badge" id="levelBadge">Lv.1</div>
          <div class="power-level" id="powerLevel">æˆ°åŠ›: 0</div>
        </div>
      </div>
      <div class="currency-display">
        <div class="currency-item">
          <span>ğŸ’</span>
          <span id="diamonds">0</span>
        </div>
        <div class="currency-item">
          <span>â­</span>
          <span id="stars">951</span>
        </div>
        <div class="currency-item">
          <span>ğŸ’°</span>
          <span id="coins">21.82è¬</span>
        </div>
      </div>
    </div>

    <!-- å·¦å´é“å…·æ¬„ -->
    <div class="inventory-panel">
      <div class="panel-title">é“å…·æ¬„</div>
      <div class="category-tabs">
        <div class="category-tab active" data-category="all">å…¨éƒ¨</div>
        <div class="category-tab" data-category="weapon">æ­¦å™¨</div>
        <div class="category-tab" data-category="armor">è­·ç”²</div>
        <div class="category-tab" data-category="accessory">é£¾å“</div>
        <div class="category-tab" data-category="special">ç‰¹æ®Š</div>
      </div>
      <div class="items-grid" id="itemsGrid">
        <!-- é“å…·é …ç›®å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ä¸­å¤®è§’è‰²å±•ç¤ºå€ -->
    <div class="character-display">
      <div class="character-container">
        <video id="characterVideo" class="character-video" autoplay muted loop style="display: none;">
          <source src="" type="video/mp4">
        </video>
        <div id="characterPlaceholder" class="character-video" style="display: flex; align-items: center; justify-content: center; background: rgba(74, 144, 226, 0.1); height: 300px;">
          è¼‰å…¥è§’è‰²ä¸­...
        </div>
        
        <!-- è£å‚™ç–ŠåŠ å±¤ -->
        <div class="equipment-overlay">
          <div class="equipped-item weapon-overlay" id="weaponOverlay" style="display: none;"></div>
          <div class="equipped-item armor-overlay" id="armorOverlay" style="display: none;"></div>
          <div class="equipped-item accessory-overlay" id="accessoryOverlay" style="display: none;"></div>
          <div class="equipped-item special-overlay" id="specialOverlay" style="display: none;"></div>
        </div>
      </div>
      
      <div class="character-stats">
        <div class="stat-item">
          <div class="stat-value" id="attackPower">0</div>
          <div class="stat-label">æ”»æ“ŠåŠ›</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="defensePower">0</div>
          <div class="stat-label">é˜²ç¦¦åŠ›</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="magicPower">0</div>
          <div class="stat-label">é­”æ³•åŠ›</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="speedPower">0</div>
          <div class="stat-label">é€Ÿåº¦</div>
        </div>
      </div>
    </div>

    <!-- å³å´èƒŒæ™¯å’Œè¼‰å…·é¢æ¿ -->
    <div class="customization-panel">
      <div class="background-section">
        <div class="panel-title">èƒŒæ™¯é¢¨æ ¼</div>
        <div class="background-grid" id="backgroundGrid">
          <!-- èƒŒæ™¯é¸é …å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>
      
      <div class="vehicle-section">
        <div class="panel-title">è¼‰å…·</div>
        <div class="vehicle-display">
          <img id="vehicleImage" class="vehicle-image" src="" alt="è¼‰å…·" style="display: none;">
          <div class="vehicle-name" id="vehicleName">åŸºç¤è¼‰å…·</div>
          <div class="vehicle-level" id="vehicleLevel">ç­‰ç´š 1</div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶æ¬„ -->
    <div class="control-bar">
      <div class="level-progress">
        <div class="progress-text">ä¸‹ä¸€ç­‰ç´š</div>
        <div class="progress-bar">
          <div class="progress-fill" id="levelProgress" style="width: 0%"></div>
        </div>
        <div class="progress-text" id="levelProgressText">0/1000</div>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="saveCharacter()">å„²å­˜è§’è‰²</button>
        <button class="btn btn-premium" onclick="openShop()">å•†åº—</button>
        <button class="btn btn-secondary" onclick="goBackToResult()">è¿”å›çµæœ</button>
      </div>
    </div>
  </div>

  <script>
    // éŠæˆ²æ•¸æ“š
    let gameData = {
      character: {
        mbti: '',
        gender: '',
        username: '',
        followers: 0,
        level: 1,
        experience: 0,
        power: 0
      },
      equipment: {
        weapon: null,
        armor: null,
        accessory: null,
        special: null
      },
      inventory: [],
      background: 'default',
      currency: {
        diamonds: 0,
        stars: 951,
        coins: 218200
      }
    };

    // é“å…·æ•¸æ“šåº«
    const itemDatabase = {
      weapon: [
        { id: 'sword_basic', name: 'åŸºç¤åŠ', icon: 'âš”ï¸', power: 100, type: 'weapon', premium: false, price: 0, stats: { attack: 100, defense: 0, magic: 0, speed: 0 } },
        { id: 'sword_fire', name: 'ç«ç„°åŠ', icon: 'ğŸ”¥', power: 500, type: 'weapon', premium: true, price: 100, stats: { attack: 500, defense: 0, magic: 200, speed: 0 } },
        { id: 'sword_ice', name: 'å†°éœœåŠ', icon: 'â„ï¸', power: 500, type: 'weapon', premium: true, price: 100, stats: { attack: 500, defense: 0, magic: 200, speed: 0 } },
        { id: 'staff_lightning', name: 'é›·é›»æ³•æ–', icon: 'âš¡', power: 800, type: 'weapon', premium: true, price: 200, stats: { attack: 300, defense: 0, magic: 800, speed: 100 } }
      ],
      armor: [
        { id: 'armor_basic', name: 'åŸºç¤è­·ç”²', icon: 'ğŸ›¡ï¸', power: 50, type: 'armor', premium: false, price: 0, stats: { attack: 0, defense: 100, magic: 0, speed: 0 } },
        { id: 'armor_plate', name: 'æ¿ç”²', icon: 'ğŸ›¡ï¸', power: 300, type: 'armor', premium: true, price: 150, stats: { attack: 0, defense: 500, magic: 0, speed: -50 } },
        { id: 'robe_magic', name: 'é­”æ³•è¢', icon: 'ğŸ§™', power: 400, type: 'armor', premium: true, price: 200, stats: { attack: 0, defense: 200, magic: 600, speed: 100 } }
      ],
      accessory: [
        { id: 'ring_power', name: 'åŠ›é‡æˆ’æŒ‡', icon: 'ğŸ’', power: 200, type: 'accessory', premium: true, price: 100, stats: { attack: 200, defense: 0, magic: 0, speed: 0 } },
        { id: 'amulet_wisdom', name: 'æ™ºæ…§è­·ç¬¦', icon: 'ğŸ”®', power: 300, type: 'accessory', premium: true, price: 150, stats: { attack: 0, defense: 0, magic: 400, speed: 0 } },
        { id: 'crown_royal', name: 'çš‡å®¶ç‹å† ', icon: 'ğŸ‘‘', power: 500, type: 'accessory', premium: true, price: 300, stats: { attack: 200, defense: 200, magic: 200, speed: 100 } }
      ],
      special: [
        { id: 'wings_angel', name: 'å¤©ä½¿ä¹‹ç¿¼', icon: 'ğŸ‘¼', power: 1000, type: 'special', premium: true, price: 500, stats: { attack: 0, defense: 0, magic: 0, speed: 1000 } },
        { id: 'halo_divine', name: 'ç¥è–å…‰ç’°', icon: 'ğŸ˜‡', power: 800, type: 'special', premium: true, price: 400, stats: { attack: 200, defense: 200, magic: 400, speed: 0 } },
        { id: 'aura_dragon', name: 'é¾ä¹‹æ°£æ¯', icon: 'ğŸ‰', power: 1200, type: 'special', premium: true, price: 600, stats: { attack: 600, defense: 0, magic: 600, speed: 0 } }
      ]
    };

    // èƒŒæ™¯é¸é …
    const backgroundOptions = [
      { id: 'default', name: 'é»˜èª', preview: 'linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%)', premium: false },
      { id: 'forest', name: 'æ£®æ—', preview: 'linear-gradient(135deg, #0d4f3c 0%, #1a5f4a 50%, #2d7a5f 100%)', premium: false },
      { id: 'ocean', name: 'æµ·æ´‹', preview: 'linear-gradient(135deg, #0c4a6e 0%, #1e5f8f 50%, #2d7aa0 100%)', premium: false },
      { id: 'space', name: 'å¤ªç©º', preview: 'linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%)', premium: true },
      { id: 'crystal', name: 'æ°´æ™¶', preview: 'linear-gradient(135deg, #4a148c 0%, #7b1fa2 50%, #ab47bc 100%)', premium: true },
      { id: 'golden', name: 'é»ƒé‡‘', preview: 'linear-gradient(135deg, #ff8f00 0%, #ffa000 50%, #ffb300 100%)', premium: true }
    ];

    // è¼‰å…·ç­‰ç´š
    const vehicleLevels = {
      0: { name: 'æ­¥è¡Œ', image: '/static/images/vehicles/walk.png', level: 1, power: 0 },
      1000: { name: 'è‡ªè¡Œè»Š', image: '/static/images/vehicles/bicycle.png', level: 2, power: 1000 },
      5000: { name: 'æ‘©æ‰˜è»Š', image: '/static/images/vehicles/motorcycle.png', level: 3, power: 2000 },
      10000: { name: 'æ±½è»Š', image: '/static/images/vehicles/car.png', level: 4, power: 5000 },
      50000: { name: 'è·‘è»Š', image: '/static/images/vehicles/sports_car.png', level: 5, power: 10000 },
      100000: { name: 'ç›´å‡æ©Ÿ', image: '/static/images/vehicles/helicopter.png', level: 6, power: 20000 },
      500000: { name: 'ç§äººé£›æ©Ÿ', image: '/static/images/vehicles/private_jet.png', level: 7, power: 50000 },
      1000000: { name: 'å¤ªç©ºèˆ¹', image: '/static/images/vehicles/spaceship.png', level: 8, power: 100000 }
    };

    // åˆå§‹åŒ–éŠæˆ²
    function initGame() {
      loadCharacterData();
      createStars();
      initializeInventory();
      initializeBackgrounds();
      loadCharacterVideo();
      loadVehicle();
      updateUI();
    }

    // è¼‰å…¥è§’è‰²æ•¸æ“š
    function loadCharacterData() {
      const saved = sessionStorage.getItem('sa_result');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (data && data.ok === true) {
            gameData.character.mbti = data.mbti || '';
            gameData.character.gender = data.gender || '';
            gameData.character.username = data.username || '';
            gameData.character.followers = data.followers || 0;
            
            // è¨ˆç®—ç­‰ç´šå’Œç¶“é©—
            calculateLevel();
            
            // åˆå§‹åŒ–é“å…·æ¬„
            initializePlayerInventory();
          }
        } catch (e) {
          console.error('Failed to parse character data:', e);
        }
      }
    }

    // è¨ˆç®—ç­‰ç´š
    function calculateLevel() {
      const followers = gameData.character.followers;
      const baseLevel = Math.floor(followers / 1000) + 1;
      const experience = followers % 1000;
      
      gameData.character.level = Math.max(1, baseLevel);
      gameData.character.experience = experience;
      
      // è¨ˆç®—ç¸½æˆ°åŠ›
      gameData.character.power = calculateTotalPower();
    }

    // è¨ˆç®—ç¸½æˆ°åŠ›
    function calculateTotalPower() {
      let totalPower = 1000; // åŸºç¤æˆ°åŠ›
      
      // ç²‰çµ²æˆ°åŠ›
      totalPower += Math.floor(gameData.character.followers / 100);
      
      // MBTIæˆ°åŠ›
      const mbtiPowers = {
        'INTJ': 200, 'INTP': 180, 'ENTJ': 190, 'ENTP': 170,
        'INFJ': 160, 'INFP': 140, 'ENFJ': 150, 'ENFP': 130,
        'ISTJ': 120, 'ISFJ': 100, 'ESTJ': 110, 'ESFJ': 90,
        'ISTP': 80, 'ISFP': 60, 'ESTP': 70, 'ESFP': 50
      };
      totalPower += mbtiPowers[gameData.character.mbti] || 0;
      
      // è£å‚™æˆ°åŠ›
      Object.values(gameData.equipment).forEach(item => {
        if (item) totalPower += item.power;
      });
      
      return totalPower;
    }

    // å‰µå»ºæ˜Ÿç©ºèƒŒæ™¯
    function createStars() {
      const starsContainer = document.getElementById('stars');
      for (let i = 0; i < 100; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.width = Math.random() * 3 + 1 + 'px';
        star.style.height = star.style.width;
        star.style.animationDelay = Math.random() * 2 + 's';
        starsContainer.appendChild(star);
      }
    }

    // åˆå§‹åŒ–é“å…·æ¬„
    function initializeInventory() {
      const itemsGrid = document.getElementById('itemsGrid');
      itemsGrid.innerHTML = '';
      
      // åˆä½µæ‰€æœ‰é“å…·
      const allItems = [
        ...itemDatabase.weapon,
        ...itemDatabase.armor,
        ...itemDatabase.accessory,
        ...itemDatabase.special
      ];
      
      allItems.forEach(item => {
        const itemEl = createItemCard(item);
        itemsGrid.appendChild(itemEl);
      });
      
      // æ·»åŠ åˆ†é¡ç¯©é¸
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', () => filterItems(tab.dataset.category));
      });
    }

    // å‰µå»ºé“å…·å¡ç‰‡
    function createItemCard(item) {
      const itemEl = document.createElement('div');
      itemEl.className = `item-card ${item.premium ? 'premium' : ''}`;
      itemEl.dataset.itemId = item.id;
      itemEl.dataset.itemType = item.type;
      
      itemEl.innerHTML = `
        <div class="item-icon">${item.icon}</div>
        <div class="item-name">${item.name}</div>
        <div class="item-power">+${item.power}</div>
        ${item.premium ? `<div class="item-price">${item.price}ğŸ’</div>` : ''}
      `;
      
      itemEl.addEventListener('click', () => equipItem(item));
      return itemEl;
    }

    // ç¯©é¸é“å…·
    function filterItems(category) {
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-category="${category}"]`).classList.add('active');
      
      document.querySelectorAll('.item-card').forEach(card => {
        if (category === 'all' || card.dataset.itemType === category) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    }

    // è£å‚™é“å…·
    function equipItem(item) {
      const slotType = item.type;
      
      // å¦‚æœè©²æ¬„ä½å·²æœ‰è£å‚™ï¼Œå…ˆå¸ä¸‹
      if (gameData.equipment[slotType]) {
        unequipItem(slotType);
      }
      
      // è£å‚™æ–°é“å…·
      gameData.equipment[slotType] = item;
      
      // æ›´æ–°é¡¯ç¤º
      updateEquipmentDisplay();
      updateUI();
      
      // é¡¯ç¤ºè£å‚™æ•ˆæœå’Œäº’å‹•å‹•ç•«
      showEquipEffect(item);
      showItemInteraction(item);
    }

    // å¸ä¸‹é“å…·
    function unequipItem(slotType) {
      gameData.equipment[slotType] = null;
      updateEquipmentDisplay();
      updateUI();
    }

    // æ›´æ–°è£å‚™é¡¯ç¤º
    function updateEquipmentDisplay() {
      // æ›´æ–°é“å…·å¡ç‰‡ç‹€æ…‹
      document.querySelectorAll('.item-card').forEach(card => {
        const itemId = card.dataset.itemId;
        const isEquipped = Object.values(gameData.equipment).some(item => item && item.id === itemId);
        card.classList.toggle('equipped', isEquipped);
      });
      
      // æ›´æ–°è§’è‰²ä¸Šçš„è£å‚™ç–ŠåŠ 
      Object.keys(gameData.equipment).forEach(slot => {
        const item = gameData.equipment[slot];
        const overlay = document.getElementById(`${slot}Overlay`);
        
        if (item) {
          overlay.textContent = item.icon;
          overlay.style.display = 'block';
          overlay.className = `equipped-item ${slot}-overlay entering`;
          
          // ç§»é™¤é€²å…¥å‹•ç•«é¡
          setTimeout(() => {
            overlay.classList.remove('entering');
          }, 500);
        } else {
          // æ·»åŠ é›¢é–‹å‹•ç•«
          if (overlay.style.display !== 'none') {
            overlay.classList.add('leaving');
            setTimeout(() => {
              overlay.style.display = 'none';
              overlay.classList.remove('leaving');
            }, 300);
          }
        }
      });
    }

    // é¡¯ç¤ºè£å‚™æ•ˆæœ
    function showEquipEffect(item) {
      // å‰µå»ºè£å‚™æ•ˆæœå‹•ç•«
      const effect = document.createElement('div');
      effect.style.position = 'absolute';
      effect.style.top = '50%';
      effect.style.left = '50%';
      effect.style.transform = 'translate(-50%, -50%)';
      effect.style.fontSize = '40px';
      effect.style.color = '#4a90e2';
      effect.style.pointerEvents = 'none';
      effect.style.zIndex = '1000';
      effect.textContent = `+${item.power}`;
      
      document.querySelector('.character-display').appendChild(effect);
      
      // å‹•ç•«æ•ˆæœ
      effect.animate([
        { transform: 'translate(-50%, -50%) scale(0)', opacity: 0 },
        { transform: 'translate(-50%, -70%) scale(1.2)', opacity: 1 },
        { transform: 'translate(-50%, -90%) scale(1)', opacity: 0 }
      ], {
        duration: 1000,
        easing: 'ease-out'
      }).onfinish = () => effect.remove();
    }

    // é¡¯ç¤ºé“å…·äº’å‹•æ•ˆæœ
    function showItemInteraction(item) {
      const slotType = item.type;
      const overlay = document.getElementById(`${slotType}Overlay`);
      
      if (!overlay) return;
      
      // æ ¹æ“šé“å…·é¡å‹é¡¯ç¤ºä¸åŒçš„äº’å‹•æ•ˆæœ
      switch (slotType) {
        case 'weapon':
          showWeaponInteraction(overlay, item);
          break;
        case 'armor':
          showArmorInteraction(overlay, item);
          break;
        case 'accessory':
          showAccessoryInteraction(overlay, item);
          break;
        case 'special':
          showSpecialInteraction(overlay, item);
          break;
      }
    }

    // æ­¦å™¨äº’å‹•æ•ˆæœ
    function showWeaponInteraction(overlay, item) {
      // æ­¦å™¨æ®èˆæ•ˆæœ
      overlay.classList.add('interacting');
      
      // å‰µå»ºæ®èˆè»Œè·¡æ•ˆæœ
      const trail = document.createElement('div');
      trail.style.position = 'absolute';
      trail.style.top = '60%';
      trail.style.right = '15%';
      trail.style.fontSize = '20px';
      trail.style.color = 'rgba(74, 144, 226, 0.3)';
      trail.style.pointerEvents = 'none';
      trail.style.zIndex = '2';
      trail.textContent = item.icon;
      
      document.querySelector('.character-display').appendChild(trail);
      
      // æ®èˆè»Œè·¡å‹•ç•«
      trail.animate([
        { transform: 'rotate(-30deg) scale(0.5)', opacity: 0.8 },
        { transform: 'rotate(30deg) scale(1.2)', opacity: 0.4 },
        { transform: 'rotate(-30deg) scale(0.5)', opacity: 0 }
      ], {
        duration: 600,
        easing: 'ease-in-out'
      }).onfinish = () => trail.remove();
      
      setTimeout(() => {
        overlay.classList.remove('interacting');
      }, 1000);
    }

    // è­·ç”²äº’å‹•æ•ˆæœ
    function showArmorInteraction(overlay, item) {
      // è­·ç”²é–ƒçˆæ•ˆæœ
      overlay.classList.add('interacting');
      
      // å‰µå»ºè­·ç”²å…‰ç’°æ•ˆæœ
      const aura = document.createElement('div');
      aura.style.position = 'absolute';
      aura.style.top = '40%';
      aura.style.left = '50%';
      aura.style.transform = 'translateX(-50%)';
      aura.style.width = '100px';
      aura.style.height = '100px';
      aura.style.border = '2px solid rgba(74, 144, 226, 0.5)';
      aura.style.borderRadius = '50%';
      aura.style.pointerEvents = 'none';
      aura.style.zIndex = '1';
      
      document.querySelector('.character-display').appendChild(aura);
      
      // å…‰ç’°æ“´æ•£å‹•ç•«
      aura.animate([
        { transform: 'translateX(-50%) scale(0.5)', opacity: 0.8 },
        { transform: 'translateX(-50%) scale(1.5)', opacity: 0 }
      ], {
        duration: 800,
        easing: 'ease-out'
      }).onfinish = () => aura.remove();
      
      setTimeout(() => {
        overlay.classList.remove('interacting');
      }, 1000);
    }

    // é£¾å“äº’å‹•æ•ˆæœ
    function showAccessoryInteraction(overlay, item) {
      // é£¾å“é–ƒçˆæ•ˆæœ
      overlay.classList.add('interacting');
      
      // å‰µå»ºæ˜Ÿå…‰æ•ˆæœ
      for (let i = 0; i < 5; i++) {
        const star = document.createElement('div');
        star.style.position = 'absolute';
        star.style.top = '20%';
        star.style.left = '50%';
        star.style.transform = 'translateX(-50%)';
        star.style.fontSize = '16px';
        star.style.color = '#ffd700';
        star.style.pointerEvents = 'none';
        star.style.zIndex = '2';
        star.textContent = 'âœ¨';
        
        document.querySelector('.character-display').appendChild(star);
        
        // éš¨æ©Ÿä½ç½®æ˜Ÿå…‰å‹•ç•«
        const angle = (i * 72) * Math.PI / 180;
        const distance = 50 + Math.random() * 30;
        const x = Math.cos(angle) * distance;
        const y = Math.sin(angle) * distance;
        
        star.animate([
          { transform: `translateX(-50%) translateY(0px) scale(0)`, opacity: 1 },
          { transform: `translateX(${x - 50}px) translateY(${y}px) scale(1)`, opacity: 0.8 },
          { transform: `translateX(${x - 50}px) translateY(${y - 20}px) scale(0.5)`, opacity: 0 }
        ], {
          duration: 1000 + i * 100,
          easing: 'ease-out'
        }).onfinish = () => star.remove();
      }
      
      setTimeout(() => {
        overlay.classList.remove('interacting');
      }, 1500);
    }

    // ç‰¹æ®Šé“å…·äº’å‹•æ•ˆæœ
    function showSpecialInteraction(overlay, item) {
      // ç‰¹æ®Šé“å…·èƒ½é‡çˆ†ç™¼æ•ˆæœ
      overlay.classList.add('interacting');
      
      // å‰µå»ºèƒ½é‡ç’°æ•ˆæœ
      for (let i = 0; i < 3; i++) {
        const ring = document.createElement('div');
        ring.style.position = 'absolute';
        ring.style.top = '50%';
        ring.style.left = '50%';
        ring.style.transform = 'translate(-50%, -50%)';
        ring.style.width = `${60 + i * 40}px`;
        ring.style.height = `${60 + i * 40}px`;
        ring.style.border = '2px solid rgba(74, 144, 226, 0.6)';
        ring.style.borderRadius = '50%';
        ring.style.pointerEvents = 'none';
        ring.style.zIndex = '1';
        
        document.querySelector('.character-display').appendChild(ring);
        
        // èƒ½é‡ç’°æ“´æ•£å‹•ç•«
        ring.animate([
          { transform: 'translate(-50%, -50%) scale(0)', opacity: 0.8 },
          { transform: 'translate(-50%, -50%) scale(1.5)', opacity: 0 }
        ], {
          duration: 800 + i * 200,
          easing: 'ease-out'
        }).onfinish = () => ring.remove();
      }
      
      setTimeout(() => {
        overlay.classList.remove('interacting');
      }, 1200);
    }

    // åˆå§‹åŒ–èƒŒæ™¯é¸é …
    function initializeBackgrounds() {
      const backgroundGrid = document.getElementById('backgroundGrid');
      backgroundGrid.innerHTML = '';
      
      backgroundOptions.forEach(bg => {
        const bgEl = document.createElement('div');
        bgEl.className = `background-option ${bg.premium ? 'premium' : ''} ${bg.id === gameData.background ? 'selected' : ''}`;
        bgEl.innerHTML = `
          <div class="background-preview" style="background: ${bg.preview}"></div>
          <div class="background-name">${bg.name}</div>
        `;
        
        bgEl.addEventListener('click', () => selectBackground(bg));
        backgroundGrid.appendChild(bgEl);
      });
    }

    // é¸æ“‡èƒŒæ™¯
    function selectBackground(bg) {
      gameData.background = bg.id;
      document.body.style.background = bg.preview;
      
      // æ›´æ–°é¸ä¸­ç‹€æ…‹
      document.querySelectorAll('.background-option').forEach(el => el.classList.remove('selected'));
      event.target.closest('.background-option').classList.add('selected');
    }

    // è¼‰å…¥è§’è‰²è¦–é »
    function loadCharacterVideo() {
      const videoEl = document.getElementById('characterVideo');
      const placeholderEl = document.getElementById('characterPlaceholder');
      
      if (!gameData.character.mbti || !gameData.character.gender) {
        placeholderEl.textContent = 'ç„¡æ³•è¼‰å…¥è§’è‰²ï¼šç¼ºå°‘ MBTI æˆ–æ€§åˆ¥è³‡è¨Š';
        return;
      }

      const mbtiType = String(gameData.character.mbti).toUpperCase().trim();
      const videoPath = `/static/videos/mbti/${mbtiType}_${gameData.character.gender}.mp4`;
      
      videoEl.src = videoPath;
      
      videoEl.addEventListener('loadeddata', function() {
        videoEl.style.display = 'block';
        placeholderEl.style.display = 'none';
      });
      
      videoEl.addEventListener('error', function() {
        placeholderEl.textContent = `ç„¡æ³•è¼‰å…¥ ${mbtiType} è§’è‰²è¦–é »`;
        placeholderEl.style.color = '#ff6b6b';
      });
    }

    // è¼‰å…¥è¼‰å…·
    function loadVehicle() {
      const vehicleImage = document.getElementById('vehicleImage');
      const vehicleName = document.getElementById('vehicleName');
      const vehicleLevel = document.getElementById('vehicleLevel');
      
      // æ ¹æ“šç²‰çµ²æ•¸é¸æ“‡è¼‰å…·
      let selectedVehicle = vehicleLevels[0];
      for (let threshold in vehicleLevels) {
        if (gameData.character.followers >= parseInt(threshold)) {
          selectedVehicle = vehicleLevels[threshold];
        }
      }
      
      vehicleImage.src = selectedVehicle.image;
      vehicleImage.style.display = 'block';
      vehicleName.textContent = selectedVehicle.name;
      vehicleLevel.textContent = `ç­‰ç´š ${selectedVehicle.level}`;
    }

    // åˆå§‹åŒ–ç©å®¶é“å…·æ¬„
    function initializePlayerInventory() {
      // çµ¦ç©å®¶ä¸€äº›åŸºç¤é“å…·
      gameData.inventory = [
        itemDatabase.weapon[0], // åŸºç¤åŠ
        itemDatabase.armor[0]   // åŸºç¤è­·ç”²
      ];
    }

    // æ›´æ–°UI
    function updateUI() {
      // æ›´æ–°è§’è‰²ä¿¡æ¯
      document.getElementById('characterName').textContent = gameData.character.username ? `@${gameData.character.username}` : 'åŒ¿åç”¨æˆ¶';
      document.getElementById('levelBadge').textContent = `Lv.${gameData.character.level}`;
      document.getElementById('powerLevel').textContent = `æˆ°åŠ›: ${gameData.character.power.toLocaleString()}`;
      
      // æ›´æ–°è²¨å¹£
      document.getElementById('diamonds').textContent = gameData.currency.diamonds;
      document.getElementById('stars').textContent = gameData.currency.stars;
      document.getElementById('coins').textContent = (gameData.currency.coins / 10000).toFixed(2) + 'è¬';
      
      // æ›´æ–°å±¬æ€§
      updateStats();
      
      // æ›´æ–°ç­‰ç´šé€²åº¦
      updateLevelProgress();
    }

    // æ›´æ–°å±¬æ€§
    function updateStats() {
      let attack = 0, defense = 0, magic = 0, speed = 0;
      
      Object.values(gameData.equipment).forEach(item => {
        if (item) {
          attack += item.stats.attack;
          defense += item.stats.defense;
          magic += item.stats.magic;
          speed += item.stats.speed;
        }
      });
      
      document.getElementById('attackPower').textContent = attack;
      document.getElementById('defensePower').textContent = defense;
      document.getElementById('magicPower').textContent = magic;
      document.getElementById('speedPower').textContent = speed;
    }

    // æ›´æ–°ç­‰ç´šé€²åº¦
    function updateLevelProgress() {
      const nextLevelExp = 1000;
      const progress = (gameData.character.experience / nextLevelExp) * 100;
      
      document.getElementById('levelProgress').style.width = progress + '%';
      document.getElementById('levelProgressText').textContent = `${gameData.character.experience}/${nextLevelExp}`;
    }

    // å„²å­˜è§’è‰²
    function saveCharacter() {
      // å°‡è§’è‰²æ•¸æ“šä¿å­˜åˆ°sessionStorage
      sessionStorage.setItem('sa_character', JSON.stringify(gameData));
      alert('è§’è‰²å·²å„²å­˜ï¼');
    }

    // æ‰“é–‹å•†åº—
    function openShop() {
      alert('å•†åº—åŠŸèƒ½é–‹ç™¼ä¸­...');
    }

    // è¿”å›çµæœé é¢
    function goBackToResult() {
      window.location.href = '/static/result.html';
    }

    // åˆå§‹åŒ–éŠæˆ²
    window.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>
