<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ä½ çš„ IG èº«åƒ¹è©•ä¼°ï½œåˆ†æçµæœ</title>
  <link rel="stylesheet" href="/static/app.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script type="module">
    import { synthesizeAudience } from './audience_model.js';
    import { synthesizeTravelSplit } from './travel_split_model.js';
    import { getConfidenceBands } from './pricing_confidence_model.js';
    import { computeBrandFit } from './brand_fit_model.js';
    window._IG_Audience = { synthesizeAudience };
    window._IG_Travel = { synthesizeTravelSplit };
    window._IG_Pricing = { getConfidenceBands };
    window._IG_BrandFit = { computeBrandFit };
  </script>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px 0;
    }
    
    .header {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      padding: 16px 24px;
      border-radius: 12px;
      margin: 0 auto 24px;
      max-width: 900px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 16px;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }
    
    /* ä¸»åƒ¹å€¼å¡ */
    .value-hero {
      text-align: center;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 48px 32px;
      border-radius: 20px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }
    
    .value-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: rotate 20s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .value-hero-content {
      position: relative;
      z-index: 1;
    }
    
    .value-label {
      font-size: 18px;
      opacity: 0.9;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .value-amount {
      font-size: 56px;
      font-weight: 800;
      margin: 16px 0;
      text-shadow: 0 4px 12px rgba(0,0,0,0.2);
      line-height: 1.1;
    }
    
    .value-per {
      font-size: 24px;
      opacity: 0.95;
    }
    
    .value-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 24px;
    }
    
    .value-item {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .value-item-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 8px;
    }
    
    .value-item-amount {
      font-size: 24px;
      font-weight: 700;
    }
    
    /* é¡å‹å±•ç¤º */
    .type-badge {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      padding: 12px 24px;
      border-radius: 50px;
      margin-bottom: 16px;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .type-emoji {
      font-size: 28px;
    }
    
    /* åƒ¹å€¼çµ„æˆ */
    .breakdown-section {
      margin-bottom: 32px;
    }
    
    .breakdown-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    
    .breakdown-label {
      font-size: 16px;
      color: #555;
      flex: 1;
    }
    
    .breakdown-sublabel {
      font-size: 13px;
      color: #888;
      margin-top: 4px;
    }
    
    .breakdown-value {
      font-size: 20px;
      font-weight: 700;
      color: #f5576c;
    }
    
    .multiplier-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-left: 12px;
    }
    
    /* å“è³ªè©•åˆ† */
    .quality-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .quality-item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
    }
    
    .quality-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .quality-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .quality-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 1s ease;
    }
    
    .quality-score {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }
    
    /* æ”¹é€²å»ºè­° */
    .tips-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .tip-item {
      padding: 16px;
      background: #f0f7ff;
      border-left: 4px solid #667eea;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 15px;
      color: #333;
      line-height: 1.6;
    }
    
    .tip-item::before {
      content: 'ğŸ’¡ ';
      margin-right: 8px;
    }
    
    /* ç”¨æˆ¶è³‡è¨Š */
    .user-info {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .user-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }
    
    .user-details h3 {
      margin: 0 0 4px;
      font-size: 20px;
      color: #333;
    }
    
    .user-handle {
      color: #666;
      font-size: 14px;
    }
    
    .stats-row {
      display: flex;
      gap: 24px;
      margin-top: 12px;
    }
    
    .stat {
      font-size: 13px;
      color: #555;
    }
    
    .stat strong {
      font-weight: 700;
      color: #333;
      margin-right: 4px;
    }
    
    /* æŒ‰éˆ• */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .btn-restart {
      flex: 1;
      padding: 14px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .btn-restart:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102,126,234,0.3);
    }
    
    /* å“ç‰Œå¥‘åˆåº¦ */
    .brand-fit-card .fit-row {
      display: grid;
      grid-template-columns: 140px 1fr 60px;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .fit-label { font-size:14px; color:#555; }
    .fit-bar { height:10px; background:#e6e6e6; border-radius:6px; overflow:hidden; }
    .fit-fill { height:100%; width:0%; background: linear-gradient(90deg,#667eea,#764ba2); transition: width .8s ease; }
    .fit-score { font-weight:700; color:#667eea; text-align:right; }

    /* é¢¨æ ¼é›·é”åœ–å®¹å™¨ */
    .radar-wrap { background:#fff; border-radius:16px; padding:20px; }
    .radar-sub { font-size:13px; color:#777; margin-top:6px; }

    /* å“ç‰Œå»ºè­° chips */
    .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip { padding:6px 12px; border-radius:999px; background:linear-gradient(135deg,#a8edea,#fed6e3); color:#333; font-size:13px; font-weight:600; }

    /* å»ºè­°æ¸…å–® */
    .brand-suggest li { padding:12px 14px; background:#f0fff6; border-left:4px solid #22c55e; border-radius:8px; margin-bottom:10px; }

    /* å—çœ¾åˆ†æ */
    .audience-grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:16px; }
    .aud-card { background:#f8f9fa; border-radius:12px; padding:16px; text-align:center; }
    .aud-chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .aud-chip { padding:4px 10px; border-radius:999px; background:linear-gradient(135deg,#e0c3fc,#8ec5fc); color:#333; font-size:12px; font-weight:500; }

    /* æ—…éŠé¡åˆ¥ç´°åˆ† */
    .travel-split .split-row {
      display: grid;
      grid-template-columns: 120px 1fr 50px;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .split-label { font-size:13px; color:#555; }
    .split-bar { height:8px; background:#e6e6e6; border-radius:4px; overflow:hidden; }
    .split-fill { height:100%; width:0%; background: linear-gradient(90deg,#667eea,#764ba2); transition: width .8s ease; }
    .split-score { font-weight:600; color:#667eea; text-align:right; font-size:13px; }

    /* å ±åƒ¹å€é–“ä¿¡å¿ƒæ¢ */
    .conf-row {
      display: grid;
      grid-template-columns: 100px 1fr;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .conf-label { font-size:14px; color:#555; font-weight:500; }
    .conf-bar { 
      height:12px; 
      background:#f0f0f0; 
      border-radius:6px; 
      overflow:hidden; 
      position:relative;
    }
    .conf-fill { 
      height:100%; 
      background: linear-gradient(90deg,#667eea,#764ba2); 
      border-radius:6px;
      transition: all .8s ease;
    }
    .conf-bounds { 
      font-size:12px; 
      color:#666; 
      margin-top:4px; 
      text-align:center;
    }

    /* éŸ¿æ‡‰å¼ */
    @media (max-width: 768px) {
      .value-amount {
        font-size: 42px;
      }
      
      .value-grid {
        grid-template-columns: 1fr;
      }
      
      .quality-grid {
        grid-template-columns: 1fr;
      }
      
      .card {
        padding: 24px 20px;
      }

      .audience-grid {
        grid-template-columns: 1fr;
      }

      .brand-fit-card .fit-row {
        grid-template-columns: 120px 1fr 50px;
      }

      .travel-split .split-row {
        grid-template-columns: 100px 1fr 45px;
      }

      .conf-row {
        grid-template-columns: 80px 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div><strong>ğŸ’° IG èº«åƒ¹è©•ä¼°</strong></div>
    <button class="btn btn-ghost btn-sm" onclick="clearAndRestart()">é‡æ–°è©•ä¼°</button>
  </header>

  <main class="container">
    <div id="err" class="status-error hidden"></div>
    
    <!-- ç”¨æˆ¶è³‡è¨Š -->
    <div class="user-info">
      <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
      <div class="user-details">
        <h3 id="displayName">ä½¿ç”¨è€…</h3>
        <div class="user-handle" id="username">@username</div>
        <div class="stats-row">
          <div class="stat"><strong id="followers">0</strong> ç²‰çµ²</div>
          <div class="stat"><strong id="following">0</strong> è¿½è¹¤</div>
          <div class="stat"><strong id="posts">0</strong> è²¼æ–‡</div>
        </div>
      </div>
    </div>
    
    <!-- ä¸»åƒ¹å€¼å¡ -->
    <div class="value-hero">
      <div class="value-hero-content">
        <div class="type-badge" id="typeBadge">
          <span class="type-emoji">ğŸ¨</span>
          <span id="typeName">å‰µä½œè€…</span>
        </div>
        <div class="value-label">ä½ çš„ç™¼æ–‡åƒ¹å€¼</div>
        <div class="value-amount">
          NT$ <span id="postValue">0</span>
        </div>
        <div class="value-per">/ ç¯‡</div>
        
        <div class="value-grid">
          <div class="value-item">
            <div class="value-item-label">ğŸ¬ Story</div>
            <div class="value-item-amount">NT$ <span id="storyValue">0</span></div>
          </div>
          <div class="value-item">
            <div class="value-item-label">ğŸ“¹ Reels</div>
            <div class="value-item-amount">NT$ <span id="reelsValue">0</span></div>
          </div>
          <div class="value-item">
            <div class="value-item-label">ğŸ“¦ æœˆé…åˆ</div>
            <div class="value-item-amount">NT$ <span id="monthlyValue">0</span></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- åƒ¹å€¼çµ„æˆåˆ†æ -->
    <div class="card">
      <div class="breakdown-section">
        <h2 class="breakdown-title">ğŸ“Š åƒ¹å€¼çµ„æˆåˆ†æ</h2>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">åŸºç¤èº«åƒ¹ï¼ˆç²‰çµ²æ•¸ï¼‰</div>
            <div class="breakdown-sublabel" id="followerTier">â€”</div>
          </div>
          <div class="breakdown-value">NT$ <span id="basePrice">0</span></div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">è¦–è¦ºå“è³ªåŠ æˆ</div>
            <div class="breakdown-sublabel">è‰²å½©ã€æ§‹åœ–ã€å¾Œè£½å“è³ª</div>
          </div>
          <div>
            <span class="multiplier-badge" id="visualMult">Ã—1.0</span>
          </div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">å…§å®¹é¡å‹åŠ æˆ</div>
            <div class="breakdown-sublabel" id="contentType">â€”</div>
          </div>
          <div>
            <span class="multiplier-badge" id="contentMult">Ã—1.0</span>
          </div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">å°ˆæ¥­åº¦åŠ æˆ</div>
            <div class="breakdown-sublabel">Bioã€ç™¼æ–‡è¦å¾‹ã€å“ç‰Œè­˜åˆ¥</div>
          </div>
          <div>
            <span class="multiplier-badge" id="profMult">Ã—1.0</span>
          </div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">ç²‰çµ²å“è³ªåŠ æˆ</div>
            <div class="breakdown-sublabel" id="followerQuality">â€”</div>
          </div>
          <div>
            <span class="multiplier-badge" id="followerMult">Ã—1.0</span>
          </div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">é¢¨æ ¼ç¨ç‰¹æ€§åŠ æˆ</div>
            <div class="breakdown-sublabel" id="styleSignature">â€”</div>
          </div>
          <div>
            <span class="multiplier-badge" id="uniqueMult">Ã—1.0</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å“è³ªè©•åˆ† -->
    <div class="card">
      <h2 class="breakdown-title">â­ å“è³ªè©•åˆ†</h2>
      <div class="quality-grid" id="qualityGrid">
        <!-- JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>

    <!-- é¢¨æ ¼é›·é”åœ– -->
    <div class="card">
      <h2 class="breakdown-title">ğŸ§­ é¢¨æ ¼æŒ‡æ•¸ Radar</h2>
      <div class="radar-wrap">
        <canvas id="styleRadar" height="220"></canvas>
        <div class="radar-sub">ä»¥ã€ŒçœŸå¯¦åº¦ã€æ™‚å°šæ„Ÿã€è¦ªå’ŒåŠ›ã€å¨›æ¨‚æ€§ã€å°ˆæ¥­åº¦ã€äº”è»¸è©•ä¼°å¸³è™Ÿèª¿æ€§ã€‚</div>
      </div>
    </div>

    <!-- å“ç‰Œå¥‘åˆåº¦ -->
    <div class="card brand-fit-card">
      <h2 class="breakdown-title">ğŸ·ï¸ å“ç‰Œå¥‘åˆåº¦</h2>
      <div id="brandFitRows"></div>
      <div class="chips" id="brandFitChips"></div>
    </div>

    <!-- åˆä½œå“ç‰Œå»ºè­° -->
    <div class="card">
      <h2 class="breakdown-title">ğŸ¤ åˆä½œå“ç‰Œå»ºè­°</h2>
      <ul class="brand-suggest" id="brandSuggestList"></ul>
    </div>

    <!-- å—çœ¾è¼ªå»“æ¨æ¸¬ -->
    <div class="card">
      <h2 class="breakdown-title">ğŸ‘¥ å—çœ¾è¼ªå»“ï¼ˆæ¨æ¸¬ï¼‰</h2>
      <div class="audience-grid">
        <div class="aud-card">
          <canvas id="genderPie" height="160"></canvas>
          <div class="radar-sub">ä»¥å½±åƒ/æ–‡å­—èª¿æ€§æ¨æ¸¬æ€§åˆ¥å æ¯”ã€‚</div>
        </div>
        <div class="aud-card">
          <canvas id="ageBar" height="160"></canvas>
          <div class="radar-sub">å¹´é½¡å€é–“ï¼ˆ18â€“24ã€25â€“34ã€35â€“44ã€45+ï¼‰ã€‚</div>
        </div>
      </div>
      <div style="margin-top:12px;">
        <div class="quality-label">åŸå¸‚ï¼é¢¨æ ¼åå¥½ï¼ˆæ¨æ¸¬ï¼‰</div>
        <div class="aud-chips" id="cityStyleChips"></div>
      </div>
    </div>

    <!-- æ—…éŠé¡åˆ¥ç´°åˆ† -->
    <div class="card travel-split">
      <h2 class="breakdown-title">ğŸ¨ æ—…éŠé¡åˆ¥ç´°åˆ†</h2>
      <div id="travelSplitRows"></div>
    </div>

    <!-- å ±åƒ¹å€é–“ï¼ˆä¿¡å¿ƒæ¢ï¼‰ -->
    <div class="card">
      <h2 class="breakdown-title">ğŸ“‰ å ±åƒ¹å€é–“ï¼ˆä¿¡å¿ƒæ¢ï¼‰</h2>
      <div class="conf-row">
        <div class="conf-label">è²¼æ–‡ Post</div>
        <div>
          <div class="conf-bar"><div id="postConf" class="conf-fill" style="left:0%; width:0%"></div></div>
          <div id="postBounds" class="conf-bounds"></div>
        </div>
      </div>
      <div class="conf-row">
        <div class="conf-label">é™å‹• Story</div>
        <div>
          <div class="conf-bar"><div id="storyConf" class="conf-fill" style="left:0%; width:0%"></div></div>
          <div id="storyBounds" class="conf-bounds"></div>
        </div>
      </div>
      <div class="conf-row">
        <div class="conf-label">çŸ­ç‰‡ Reels</div>
        <div>
          <div class="conf-bar"><div id="reelsConf" class="conf-fill" style="left:0%; width:0%"></div></div>
          <div id="reelsBounds" class="conf-bounds"></div>
        </div>
      </div>
      <div class="conf-row">
        <div class="conf-label">æœˆé…åˆ</div>
        <div>
          <div class="conf-bar"><div id="monthlyConf" class="conf-fill" style="left:0%; width:0%"></div></div>
          <div id="monthlyBounds" class="conf-bounds"></div>
        </div>
      </div>
      <div class="radar-sub">èªªæ˜ï¼šä¾è¦–è¦ºå“è³ªã€å°ˆæ¥­åº¦ã€å…§å®¹é¡å‹èˆ‡ç²‰çµ²å“è³ªæ¨ä¼° Â±(10%â€“35%) çš„ä¸ç¢ºå®šæ€§å€é–“ã€‚</div>
    </div>
    
    <!-- åƒ¹å€¼é™³è¿° -->
    <div class="card">
      <h2 class="breakdown-title">ğŸ’¬ ä½ çš„åƒ¹å€¼å®šä½</h2>
      <p style="font-size: 16px; line-height: 1.8; color: #333;" id="valueStatement">
        è¼‰å…¥ä¸­...
      </p>
    </div>
    
    <!-- æ”¹é€²å»ºè­° -->
    <div class="card">
      <h2 class="breakdown-title">ğŸ“ˆ åƒ¹å€¼æå‡å»ºè­°</h2>
      <ul class="tips-list" id="improvementTips">
        <!-- JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </ul>
    </div>
    
    <div class="action-buttons">
      <button class="btn-restart" onclick="clearAndRestart()">
        ğŸ”„ é‡æ–°è©•ä¼°
      </button>
    </div>
  </main>

  <script type="module">
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // é˜²æ­¢è¿”å›
    (function() {
      if (window.history && window.history.pushState) {
        window.history.pushState(null, null, window.location.href);
        window.addEventListener('popstate', function() {
          window.history.pushState(null, null, window.location.href);
          if (confirm('âš ï¸ ç„¡æ³•è¿”å›ä¸Šä¸€é \n\nè‹¥è¦é‡æ–°è©•ä¼°ï¼Œè«‹é»æ“Šã€Œé‡æ–°è©•ä¼°ã€ã€‚')) {
            clearAndRestart();
          }
        });
      }
    })();

    function formatNumber(num) {
      return num.toLocaleString('zh-TW');
    }

    function destroyAllCharts() {
      // éŠ·æ¯€æ‰€æœ‰åœ–è¡¨å¯¦ä¾‹
      if (window.styleRadarChart) {
        window.styleRadarChart.destroy();
        window.styleRadarChart = null;
      }
      if (window.genderPieChart) {
        window.genderPieChart.destroy();
        window.genderPieChart = null;
      }
      if (window.ageBarChart) {
        window.ageBarChart.destroy();
        window.ageBarChart = null;
      }
    }

    function fillUI(data) {
      console.log('Filling UI with data:', data);
      
      // æ¸…ç†ç¾æœ‰åœ–è¡¨å¯¦ä¾‹
      destroyAllCharts();
      
      // åŸºæœ¬è³‡è¨Š
      document.getElementById('displayName').textContent = data.display_name || 'ä½¿ç”¨è€…';
      document.getElementById('username').textContent = data.username ? '@' + data.username : 'â€”';
      document.getElementById('followers').textContent = formatNumber(data.followers || 0);
      document.getElementById('following').textContent = formatNumber(data.following || 0);
      document.getElementById('posts').textContent = formatNumber(data.posts || 0);
      
      // é¡å‹
      const type = data.primary_type || {};
      document.getElementById('typeBadge').innerHTML = `
        <span class="type-emoji">${type.emoji || 'ğŸ¨'}</span>
        <span>${type.name_zh || 'å‰µä½œè€…'}</span>
      `;
      
      // é ­åƒ emoji
      document.getElementById('userAvatar').textContent = type.emoji || 'ğŸ‘¤';
      
      // åƒ¹å€¼
      const value = data.value_estimation || {};
      document.getElementById('postValue').textContent = formatNumber(value.post_value || 0);
      document.getElementById('storyValue').textContent = formatNumber(value.story_value || 0);
      document.getElementById('reelsValue').textContent = formatNumber(value.reels_value || 0);
      document.getElementById('monthlyValue').textContent = formatNumber(value.monthly_package || 0);
      
      // åƒ¹å€¼çµ„æˆ
      document.getElementById('basePrice').textContent = formatNumber(value.base_price || 0);
      document.getElementById('followerTier').textContent = 
        `ä½ çš„ç´šåˆ¥ï¼š${value.follower_tier || 'ç´ äºº'}ï¼ˆ${formatNumber(data.followers || 0)} ç²‰çµ²ï¼‰`;
      
      const mult = value.multipliers || {};
      document.getElementById('visualMult').textContent = 'Ã—' + (mult.visual || 1.0);
      document.getElementById('contentMult').textContent = 'Ã—' + (mult.content || 1.0);
      document.getElementById('profMult').textContent = 'Ã—' + (mult.professional || 1.0);
      document.getElementById('followerMult').textContent = 'Ã—' + (mult.follower || 1.0);
      document.getElementById('uniqueMult').textContent = 'Ã—' + (mult.unique || 1.0);
      
      // å…§å®¹é¡å‹
      const analysis = data.analysis || {};
      const contentType = analysis.content_type || {};
      const topic = contentType.primary || 'ç”Ÿæ´»';
      document.getElementById('contentType').textContent = topic;
      
      // ç²‰çµ²å“è³ª
      document.getElementById('followerQuality').textContent = 
        `ç²‰çµ²/è¿½è¹¤æ¯” = ${(data.followers / (data.following || 1)).toFixed(1)}ï¼ˆ${value.follower_quality || 'æ¨™æº–'}ï¼‰`;
      
      // é¢¨æ ¼ç°½å
      const uniqueness = analysis.uniqueness || {};
      document.getElementById('styleSignature').textContent = uniqueness.style_signature || 'â€”';
      
      // å“è³ªè©•åˆ†
      const visual = analysis.visual_quality || {};
      const qualityItems = [
        { label: 'è‰²å½©å’Œè«§åº¦', score: visual.color_harmony || 5 },
        { label: 'æ§‹åœ–å°ˆæ¥­åº¦', score: visual.composition || 5 },
        { label: 'å¾Œè£½å“è³ª', score: visual.editing || 5 },
        { label: 'æ•´é«”ç¾æ„Ÿ', score: visual.overall || 5 }
      ];
      
      const qualityGrid = document.getElementById('qualityGrid');
      qualityGrid.innerHTML = '';
      
      qualityItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'quality-item';
        div.innerHTML = `
          <div class="quality-label">${item.label}</div>
          <div class="quality-bar">
            <div class="quality-fill" style="width: ${item.score * 10}%"></div>
          </div>
          <div class="quality-score">${item.score.toFixed(1)} / 10</div>
        `;
        qualityGrid.appendChild(div);
      });

      // ---- Radar Style Index ----
      const style = (analysis.style_index || {});
      const radarData = [
        style.authenticity ?? Math.min(10, (visual.overall || 6) * 0.9 + 1.5),
        style.fashion ?? (visual.color_harmony || 6) * 0.9,
        style.affinity ?? (mult.follower >= 1.5 ? 7.5 : 6.2),
        style.entertainment ?? (contentType.primary?.includes('æ—…éŠ') || contentType.primary?.includes('ç”Ÿæ´»') ? 7.8 : 6.0),
        style.professional ?? (mult.professional ? 6 + (mult.professional-1)*4 : 6.2),
      ].map(v => Math.max(3, Math.min(9.8, Number(v))));

      const ctx = document.getElementById('styleRadar');
      if (ctx && window.Chart) {
        // éŠ·æ¯€ç¾æœ‰çš„åœ–è¡¨å¯¦ä¾‹
        if (window.styleRadarChart) {
          window.styleRadarChart.destroy();
        }
        
        window.styleRadarChart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: ['çœŸå¯¦åº¦','æ™‚å°šæ„Ÿ','è¦ªå’ŒåŠ›','å¨›æ¨‚æ€§','å°ˆæ¥­åº¦'],
            datasets: [{
              label: 'é¢¨æ ¼æŒ‡æ•¸',
              data: radarData
            }]
          },
          options: {
            responsive: true,
            scales: { r: { suggestedMin: 0, suggestedMax: 10, ticks: { stepSize: 2 } } },
            plugins: { legend: { display: false } }
          }
        });
      }

      // ---- Brand Fit ----
      const bf = window._IG_BrandFit?.computeBrandFit({
        topic,
        visual,
        multipliers: mult
      }) || { scores: [], suggested: [] };

      const rows = document.getElementById('brandFitRows');
      const chips = document.getElementById('brandFitChips');
      rows.innerHTML = ''; chips.innerHTML = '';

      (bf.scores || []).forEach(item => {
        const row = document.createElement('div');
        row.className = 'fit-row';
        row.innerHTML = `
          <div class="fit-label">${item.label}</div>
          <div class="fit-bar"><div class="fit-fill" style="width:${item.score}%"></div></div>
          <div class="fit-score">${item.score}%</div>`;
        rows.appendChild(row);
      });

      (bf.suggested || []).forEach(t => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = t;
        chips.appendChild(chip);
      });

      // ---- Collaboration Suggestions ----
      const suggest = document.getElementById('brandSuggestList');
      suggest.innerHTML = '';

      function addSuggest(title, body) {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${title}</strong><br>${body}`;
        suggest.appendChild(li);
      }

      const tier = (value.follower_tier || '').toString();
      const postVal = Number(value.post_value || 0);
      const storyVal = Number(value.story_value || 0);
      const reelsVal = Number(value.reels_value || 0);

      addSuggest('æ—…å®¿ 2å¤©1å¤œ ä½å®¿äº¤æ› + å…§å®¹æˆæ¬Š',
        `ä»¥ Reels + è²¼æ–‡ + 2-3 çµ„ Storyï¼Œæ›å–å¹³æ—¥å…¥ä½ï¼ˆæˆ–æŠ˜æŠµé‡‘é¡ NT$ ${(postVal*0.6).toLocaleString('zh-TW')}ï¼‰ï¼Œå»ºè­°åŠ è³¼äºŒæ¬¡æ›å…‰ï¼ˆåŠ åƒ¹ NT$ ${(storyVal*0.5).toLocaleString('zh-TW')}ï¼‰ã€‚`);

      addSuggest('é¤é£²è©¦åƒï¼‹çŸ­å½±éŸ³å¥—é¤',
        `1 Reels + 1 Story ç²¾é¸ï¼ˆæ°¸ä¹…ï¼‰ï¼Œå»ºè­°å ±åƒ¹ NT$ ${(reelsVal*0.85).toLocaleString('zh-TW')}ï¼Œç›®æ¨™æŠ•æ”¾æ–¼å•†åœˆå¾®å‹å“ç‰Œã€‚`);

      addSuggest('ç”Ÿæ´»å®¶é›»é«”é©—ï¼‹æœˆé…åˆ',
        `æ¯æœˆ 1 è²¼æ–‡ + 2 Storyï¼Œæœˆè²» NT$ ${(Math.max(15000, postVal*0.4+storyVal*0.6)).toLocaleString('zh-TW')}ï¼Œå«åŸºç¤ç´ ææˆæ¬Šï¼ˆ30å¤©ï¼‰ã€‚`);

      if (postVal > 60000) {
        addSuggest('å“ç‰Œå¤§ä½¿ï¼ˆå­£åº¦ï¼‰',
          `æ¯å­£ 2 è²¼æ–‡ + 3 Reels + 6 Storyï¼Œå­£åº¦è²»ç”¨ç´„ NT$ ${(postVal*3 + reelsVal*2).toLocaleString('zh-TW')}ï¼Œå«å“ç‰Œé é¢éœ²å‡ºèˆ‡å®˜ç¶²ç´ æã€‚`);
      }

      // ---- Audience Synthesis ----
      const audSynth = window._IG_Audience?.synthesizeAudience({
        topic,
        visual,
        mult,
        analysis
      }) || { male_ratio:0.5, age_dist:[0.25,0.45,0.2,0.1], city_styles:['å°åŒ—éƒ½æœƒ','ç”Ÿæ´»æ©Ÿèƒ½'] };

      const male = audSynth.male_ratio;
      const female = audSynth.female_ratio;
      const ageDist = audSynth.age_dist;

      if (window.Chart) {
        const gctx = document.getElementById('genderPie');
        if (gctx) {
          // éŠ·æ¯€ç¾æœ‰çš„æ€§åˆ¥åœ“é¤…åœ–å¯¦ä¾‹
          if (window.genderPieChart) {
            window.genderPieChart.destroy();
          }
          
          window.genderPieChart = new Chart(gctx, {
            type:'doughnut',
            data:{ labels:['ç”·æ€§','å¥³æ€§'], datasets:[{ data:[Math.round(male*100), Math.round(female*100)] }] },
            options:{ plugins:{ legend:{ position:'bottom' } } }
          });
        }

        const actx = document.getElementById('ageBar');
        if (actx) {
          // éŠ·æ¯€ç¾æœ‰çš„å¹´é½¡é•·æ¢åœ–å¯¦ä¾‹
          if (window.ageBarChart) {
            window.ageBarChart.destroy();
          }
          
          window.ageBarChart = new Chart(actx, {
            type:'bar',
            data:{
              labels:['18â€“24','25â€“34','35â€“44','45+'],
              datasets:[{ label:'å æ¯”(%)', data: ageDist.map(x=>Math.round(x*100)) }]
            },
            options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ suggestedMax: 60 } } }
          });
        }
      }

      // City style chips
      const chipEl = document.getElementById('cityStyleChips');
      if (chipEl) {
        chipEl.innerHTML = '';
        (audSynth.city_styles || []).forEach(name => {
          const d = document.createElement('div');
          d.className = 'aud-chip';
          d.textContent = name;
          chipEl.appendChild(d);
        });
      }

      // ---- Travel Split ----
      const tsRows = document.getElementById('travelSplitRows');
      if (tsRows) {
        tsRows.innerHTML = '';
        const ts = window._IG_Travel?.synthesizeTravelSplit({ topic, visual, uniqueness, analysis }) ||
                   { city_hotel:72, resort:75, design_hotel:70 };
        const items = [
          {label:'åŸå¸‚é£¯åº—', v: ts.city_hotel},
          {label:'åº¦å‡æ‘', v: ts.resort},
          {label:'è¨­è¨ˆæ—…åº—', v: ts.design_hotel},
        ];
        items.forEach(it => {
          const row = document.createElement('div');
          row.className = 'split-row';
          row.innerHTML = `
            <div class="split-label">${it.label}</div>
            <div class="split-bar"><div class="split-fill" style="width:${it.v}%"></div></div>
            <div class="split-score">${it.v}%</div>`;
          tsRows.appendChild(row);
        });
      }

      // ---- Pricing Confidence Bands ----
      function setBounds(idFill, idText, center, pct){
        const lo = Math.max(0, Math.round(center*(1-pct)));
        const hi = Math.round(center*(1+pct));
        const total = hi==0?1:hi;
        const left = (lo/total)*100;
        const width = ((hi-lo)/total)*100;
        const fill = document.getElementById(idFill);
        const txt = document.getElementById(idText);
        if (fill) { fill.style.left = left+'%'; fill.style.width = width+'%'; }
        if (txt) { txt.textContent = `ä¼°è¨ˆå€é–“ï¼šNT$ ${lo.toLocaleString('zh-TW')} ~ NT$ ${hi.toLocaleString('zh-TW')}ï¼ˆÂ±${Math.round(pct*100)}%ï¼‰`; }
      }

      const bands = window._IG_Pricing?.getConfidenceBands({
        value,
        visual,
        mult,
        contentPrimary: contentType.primary || ''
      }) || { post:0.2, story:0.22, reels:0.25, monthly:0.15 };

      setBounds('postConf','postBounds', Number(value.post_value||0), bands.post);
      setBounds('storyConf','storyBounds', Number(value.story_value||0), bands.story);
      setBounds('reelsConf','reelsBounds', Number(value.reels_value||0), bands.reels);
      setBounds('monthlyConf','monthlyBounds', Number(value.monthly_package||0), bands.monthly);
      
      // åƒ¹å€¼é™³è¿°
      document.getElementById('valueStatement').textContent = 
        data.value_statement || 'æ­£åœ¨åˆ†æä½ çš„ç¨ç‰¹åƒ¹å€¼...';
      
      // æ”¹é€²å»ºè­°
      const tips = data.improvement_tips || [];
      const tipsList = document.getElementById('improvementTips');
      tipsList.innerHTML = '';
      
      if (tips.length > 0) {
        tips.forEach(tip => {
          const li = document.createElement('li');
          li.className = 'tip-item';
          li.textContent = tip;
          tipsList.appendChild(li);
        });
      } else {
        tipsList.innerHTML = '<li class="tip-item">ç›®å‰æ²’æœ‰å»ºè­°ï¼Œä½ çš„å¸³è™Ÿå·²ç¶“å¾ˆæ£’äº†ï¼</li>';
      }
    }

    async function loadResult() {
      const saved = sessionStorage.getItem('sa_result');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (data && data.ok) {
            fillUI(data);
            return;
          }
        } catch {}
      }
      
      // Fallback: å¾ debug endpoint
      try {
        const r = await fetch('/debug/last_ai?ts=' + Date.now());
        if (r.ok) {
          const j = await r.json();
          let parsed = null;
          try {
            parsed = JSON.parse(j.text || j.raw || '{}');
          } catch {}
          if (parsed && parsed.ok) {
            fillUI(parsed);
            return;
          }
        }
      } catch {}
      
      // å¦‚æœæ²’æœ‰æ‰¾åˆ°çœŸå¯¦æ•¸æ“šï¼Œé¡¯ç¤ºç¤ºä¾‹æ•¸æ“šç”¨æ–¼æ¼”ç¤º
      console.log('æ²’æœ‰æ‰¾åˆ°çœŸå¯¦åˆ†æçµæœï¼Œé¡¯ç¤ºç¤ºä¾‹æ•¸æ“š');
      showDemoModeNotice();
      const demoData = createDemoData();
      fillUI(demoData);
    }

    function showDemoModeNotice() {
      // åœ¨é é¢é ‚éƒ¨é¡¯ç¤ºæ¼”ç¤ºæ¨¡å¼æç¤º
      const notice = document.createElement('div');
      notice.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #ff6b6b, #ffa500);
        color: white;
        padding: 12px;
        text-align: center;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      `;
      notice.innerHTML = `
        ğŸ­ æ¼”ç¤ºæ¨¡å¼ï¼šæ­£åœ¨é¡¯ç¤ºç¤ºä¾‹æ•¸æ“šã€‚è¦æŸ¥çœ‹çœŸå¯¦åˆ†æçµæœï¼Œè«‹å…ˆä¸Šå‚³ä½ çš„ IG è³‡æ–™é€²è¡Œåˆ†æã€‚
        <button onclick="this.parentElement.remove()" style="margin-left: 10px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer;">âœ•</button>
      `;
      document.body.insertBefore(notice, document.body.firstChild);
      
      // èª¿æ•´é é¢é ‚éƒ¨é–“è·
      document.body.style.paddingTop = '60px';
    }

    function createDemoData() {
      return {
        ok: true,
        display_name: "Danny TJ Kan | ğŸ€ğŸ¦ğŸ”¥ğŸ¼",
        username: "dannytjkan",
        followers: 10100,
        following: 909,
        posts: 181,
        primary_type: {
          emoji: "ğŸœ",
          name_zh: "ç”Ÿæ´»è¨˜éŒ„è€…"
        },
        value_estimation: {
          post_value: 55721,
          story_value: 22288,
          reels_value: 72437,
          monthly_package: 222884,
          base_price: 12000,
          follower_tier: "æ„è¦‹é ˜è¢–",
          multipliers: {
            visual: 1.5,
            content: 1.0,
            professional: 1.59,
            follower: 1.5,
            unique: 1.3
          },
          follower_quality: "é«˜å½±éŸ¿åŠ›"
        },
        analysis: {
          content_type: {
            primary: "æ—…éŠç¾é£Ÿ"
          },
          visual_quality: {
            color_harmony: 7.5,
            composition: 7.0,
            editing: 7.8,
            overall: 7.5
          },
          uniqueness: {
            style_signature: "éš¨æ€§ç”Ÿæ´»ç´€éŒ„"
          },
          style_index: {
            authenticity: 8.2,
            fashion: 6.8,
            affinity: 7.5,
            entertainment: 7.9,
            professional: 6.5
          }
        },
        value_statement: "æ•æ‰ç”Ÿæ´»ä¸­çš„æ¯ä¸€åˆ»ï¼Œå±•ç¾çœŸå¯¦è€Œéš¨æ€§çš„æ—¥å¸¸æ•…äº‹ã€‚",
        improvement_tips: [
          "å¢åŠ å°ˆæ¥­æ”å½±ä½œå“ä»¥æå‡è¦–è¦ºå¸å¼•åŠ›",
          "ä½¿ç”¨ Hashtags å¢åŠ æ›å…‰ç‡",
          "å˜—è©¦ç™¼ä½ˆçŸ­å½±ç‰‡ä»¥å¸å¼•æ›´å¤šäº’å‹•",
          "è€ƒæ…®èˆ‡å…¶ä»–å…§å®¹å‰µä½œè€…åˆä½œä»¥æ“´å¤§å½±éŸ¿åŠ›"
        ]
      };
    }

    window.clearAndRestart = async function() {
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸¦é‡æ–°é–‹å§‹ï¼Ÿ')) return;
      
      try {
        const config = {
          apiKey: "AIzaSyBI2-4yEwzxvYOvui9FZiGAzCE22OhKmU8",
          authDomain: "social-avatar-d13c8.firebaseapp.com",
          projectId: "social-avatar-d13c8",
          storageBucket: "social-avatar-d13c8.appspot.com",
          messagingSenderId: "280598358339",
          appId: "1:280598358339:web:214a0d4ca53793163367f6"
        };

        const app = getApps().length ? getApps()[0] : initializeApp(config);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const user = auth.currentUser;
        if (user) {
          await deleteDoc(doc(db, 'users', user.uid)).catch(() => {});
        }
        
        sessionStorage.clear();
        localStorage.clear();
        await signOut(auth).catch(() => {});
        
        alert('âœ… å·²æ¸…é™¤æ‰€æœ‰è³‡æ–™');
        location.replace('/static/landing.html');
      } catch (e) {
        alert('æ¸…é™¤å¤±æ•—ï¼š' + e.message);
      }
    };

    window.addEventListener('DOMContentLoaded', loadResult);
  </script>
</body>
</html>
