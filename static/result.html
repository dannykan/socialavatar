<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>分析結果｜Social Avatar</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --border:#1f2937; --text:#e5e7eb;
      --accent:#22d3ee; --muted:#94a3b8;
    }
    body{margin:0;background:radial-gradient(1000px 600px at -10% -10%, #0ea5e9 0, transparent 60%),
                   radial-gradient(1200px 600px at 110% 0%, #9333ea 0, transparent 60%),
                   var(--bg);
         color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;min-height:100vh}
    header{padding:16px 20px;border-bottom:1px solid var(--border);background:#0b1220aa;backdrop-filter:blur(6px);position:sticky;top:0}
    main{max-width:900px;margin:0 auto;padding:20px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:860px){.grid{grid-template-columns:1fr;}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px}
    .title{display:flex;align-items:center;gap:10px;margin:2px 0 10px}
    .badge{padding:6px 10px;border-radius:999px;font-weight:700;background:#1f2937;color:#e2e8f0;border:1px solid #334155}
    .vehicle{font-weight:700;padding:8px 12px;border-radius:10px;background:#052e1a;border:1px solid #14532d;color:#bbf7d0;display:inline-block}
    .muted{color:var(--muted)}
    .buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button,.btn{border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--accent);color:#0b1220}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    pre{white-space:pre-wrap;background:#0b1220;border:1px solid var(--border);padding:10px;border-radius:8px}
    .err{background:#7f1d1d;color:#fecaca;border:1px solid #ef4444;padding:12px;border-radius:10px;margin:10px 0;display:none}
  </style>
  <script>
    function fillUI(x) {
      // 依你的 DOM id/class 調整
      const dn = (v) => (v ?? '').toString();
      const di = (sel, v) => { const el = document.querySelector(sel); if (el) el.textContent = v; };
    
      di('#display_name', dn(x.display_name || '使用者'));
      di('#username', x.username ? '@' + x.username : '—');
      di('#followers', (x.followers ?? 0).toLocaleString());
      di('#following', (x.following ?? 0).toLocaleString());
      di('#posts', (x.posts ?? 0).toLocaleString());
      di('#mbti', (x.mbti || '—').toUpperCase());
      di('#vehicle', x.vehicle || '—');
      di('#summary', dn(x.summary || ''));
    }
    
    function safeParseJson(text) {
      if (!text) return null;
      let s = text.trim();
      // 去掉 ```json ... ```
      if (s.startsWith('```')) {
        const i = s.indexOf('\n');
        if (i >= 0) s = s.slice(i + 1);
        if (s.endsWith('```')) s = s.slice(0, -3);
      }
      // 擷取第一個 { 到最後一個 }
      const l = s.indexOf('{'), r = s.lastIndexOf('}');
      if (l >= 0 && r > l) s = s.slice(l, r + 1);
      try { return JSON.parse(s); } catch { return null; }
    }
    
    async function loadResult() {
      // 1) 優先使用上一步存的結果
      const saved = sessionStorage.getItem('sa_result');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          fillUI(data);
          // 顯示診斷 (可選)
          const dbg = document.querySelector('#diagnose_json');
          if (dbg && data.diagnose) dbg.textContent = JSON.stringify(data.diagnose, null, 2);
          return;
        } catch {}
      }
    
      // 2) 沒有暫存 → 從 /debug/last_ai 補抓（重新整理/直開 result.html 的情境）
      try {
        const r = await fetch('/debug/last_ai');
        const j = await r.json();
        const parsed = safeParseJson(j.text || j.raw || '');
        if (parsed) {
          // 從 AI 文字回應填基本欄位
          const fallbackData = {
            display_name: parsed.display_name || '使用者',
            username: parsed.username || '',
            followers: Number(parsed.followers || 0),
            following: Number(parsed.following || 0),
            posts: Number(parsed.posts || 0),
            mbti: (parsed.mbti || '').toUpperCase(),
            summary: parsed.summary || '',
            vehicle: parsed.vehicle || '—'
          };
          fillUI(fallbackData);
          // 診斷面板（可用 /debug/config 補充）
          const cfg = await fetch('/debug/config').then(r=>r.json()).catch(()=>null);
          const dbg = document.querySelector('#diagnose_json');
          if (dbg) dbg.textContent = JSON.stringify({
            ai_on: cfg?.ai_on ?? true,
            model: cfg?.model ?? 'gpt-4o-mini',
            source: 'debug/last_ai'
          }, null, 2);
          return;
        }
      } catch (e) {
        console.error('load from /debug/last_ai failed:', e);
      }
    
      // 3) 都沒有 → 提示回去重新上傳
      alert('找不到分析結果，請回到上一步重新上傳並開始分析。');
      window.location.href = '/static/landing.html';
    }
    
    document.addEventListener('DOMContentLoaded', loadResult);
    
    
    function clearAndRestart(){
      try{
        localStorage.removeItem('sa_result');
      }catch(e){}
      location.href='/static/landing.html';
    }

    function paintMBTI(mbti){
      // 簡單色系依 MBTI 第一碼
      const map = {E:'#22d3ee', I:'#a78bfa'};
      const c = map[(mbti||'')[0]] || '#22c55e';
      const el = document.querySelector('.badge');
      if (el) el.style.background = c + '33';
      if (el) el.style.borderColor = c + '88';
      if (el) el.style.color = '#fff';
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      const box = document.getElementById('result');
      const debugBox = document.getElementById('debug');
      const errBox = document.getElementById('err');

      try{
        const raw = localStorage.getItem('sa_result');
        if (!raw){ location.href='/static/upload.html'; return; }

        const data = JSON.parse(raw);
        const ai = data.ai || {};
        const diag = data.diagnose || {};

        // 基本防呆
        const mbti = ai.mbti || '—';
        const summary = ai.summary || '—';
        const display = ai.display_name || '使用者';
        const username = ai.username || '';
        const followers = ai.followers ?? '—';
        const following = ai.following ?? '—';
        const posts = ai.posts ?? '—';
        const vehicle = ai.vehicle || '—';

        box.innerHTML = `
          <div class="grid">
            <div class="card">
              <div class="title">
                <span class="badge" title="MBTI">${mbti}</span>
                <h2 style="margin:0">${display}</h2>
                ${username ? `<span class="muted">@${username}</span>` : ``}
              </div>
              <p class="muted">Followers / Following / Posts ： <strong>${followers}</strong> / <strong>${following}</strong> / <strong>${posts}</strong></p>
              <p style="line-height:1.7">${summary}</p>
              <div class="buttons">
                <button class="btn btn-primary" onclick="clearAndRestart()">清除並重新開始</button>
                <a class="btn btn-ghost" href="/debug/last_ai" target="_blank">檢視原始 AI</a>
              </div>
            </div>
            <div class="card">
              <h3 style="margin-top:0">你的載具</h3>
              <p class="vehicle">${vehicle}</p>
              <p class="muted">（之後可解鎖更多造型與動畫）</p>
            </div>
          </div>
        `;

        paintMBTI(mbti);

        // Debug 區
        debugBox.innerHTML = `<pre>${JSON.stringify(diag, null, 2)}</pre>`;
      }catch(e){
        errBox.style.display='block';
        errBox.textContent='顯示錯誤：' + e.message;
      }
    });
  </script>
</head>
<body>
  <header>
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div><strong>Social Avatar</strong></div>
      <nav class="buttons">
        <button class="btn btn-ghost" onclick="clearAndRestart()">清除並重新開始</button>
      </nav>
    </div>
  </header>

  <main>
    <h1 style="margin:10px 0 12px">分析結果</h1>
    <div id="err" class="err"></div>
    <div id="result" class="card">讀取中…</div>

    <details class="card" style="margin-top:14px">
      <summary>診斷資訊（debug）</summary>
      <div id="debug" style="margin-top:10px"></div>
    </details>
  </main>
</body>
</html>
