<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‰Ω†ÁöÑ IG Ë∫´ÂÉπË©ï‰º∞ÔΩúÂàÜÊûêÁµêÊûú</title>
  <link rel="stylesheet" href="/static/app.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script type="module">
    import { synthesizeAudience } from './audience_model.js';
    import { synthesizeTravelSplit } from './travel_split_model.js';
    import { getConfidenceBands } from './pricing_confidence_model.js';
    import { computeBrandFit } from './brand_fit_model.js';
    window._IG_Audience = { synthesizeAudience };
    window._IG_Travel = { synthesizeTravelSplit };
    window._IG_Pricing = { getConfidenceBands };
    window._IG_BrandFit = { computeBrandFit };
  </script>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px 0;
    }
    
    .header {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      padding: 16px 24px;
      border-radius: 12px;
      margin: 0 auto 24px;
      max-width: 900px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 16px;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }
    
    /* ‰∏ªÂÉπÂÄºÂç° */
    .value-hero {
      text-align: center;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 48px 32px;
      border-radius: 20px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }
    
    .value-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: rotate 20s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .value-hero-content {
      position: relative;
      z-index: 1;
    }
    
    .value-label {
      font-size: 18px;
      opacity: 0.9;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .value-amount {
      font-size: 56px;
      font-weight: 800;
      margin: 16px 0;
      text-shadow: 0 4px 12px rgba(0,0,0,0.2);
      line-height: 1.1;
    }
    
    .value-per {
      font-size: 24px;
      opacity: 0.95;
    }
    
    .value-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 24px;
    }
    
    .value-item {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .value-item-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 8px;
    }
    
    .value-item-amount {
      font-size: 24px;
      font-weight: 700;
    }
    
    /* È°ûÂûãÂ±ïÁ§∫ */
    .type-badge {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      padding: 12px 24px;
      border-radius: 50px;
      margin-bottom: 16px;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .type-emoji {
      font-size: 28px;
    }
    
    /* ÂÉπÂÄºÁµÑÊàê */
    .breakdown-section {
      margin-bottom: 32px;
    }
    
    .breakdown-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    
    .breakdown-label {
      font-size: 16px;
      color: #555;
      flex: 1;
    }
    
    .breakdown-sublabel {
      font-size: 13px;
      color: #888;
      margin-top: 4px;
    }
    
    .breakdown-value {
      font-size: 20px;
      font-weight: 700;
      color: #f5576c;
    }
    
    .multiplier-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-left: 12px;
    }
    
    /* ÂìÅË≥™Ë©ïÂàÜ */
    .quality-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .quality-item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
    }
    
    .quality-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .quality-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .quality-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 1s ease;
    }
    
    .quality-score {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }
    
    /* ÊîπÈÄ≤Âª∫Ë≠∞ */
    .tips-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .tip-item {
      padding: 16px;
      background: #f0f7ff;
      border-left: 4px solid #667eea;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 15px;
      color: #333;
      line-height: 1.6;
    }
    
    .tip-item::before {
      content: 'üí° ';
      margin-right: 8px;
    }
    
    /* Áî®Êà∂Ë≥áË®ä */
    .user-info {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .user-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }
    
    .user-details h3 {
      margin: 0 0 4px;
      font-size: 20px;
      color: #333;
    }
    
    .user-handle {
      color: #666;
      font-size: 14px;
    }
    
    .stats-row {
      display: flex;
      gap: 24px;
      margin-top: 12px;
    }
    
    .stat {
      font-size: 13px;
      color: #555;
    }
    
    .stat strong {
      font-weight: 700;
      color: #333;
      margin-right: 4px;
    }
    
    /* ÊåâÈàï */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .btn-restart {
      flex: 1;
      padding: 14px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .btn-restart:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102,126,234,0.3);
    }
    
    /* ÂìÅÁâåÂ•ëÂêàÂ∫¶ */
    .brand-fit-card .fit-row {
      display: grid;
      grid-template-columns: 140px 1fr 60px;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .fit-label { font-size:14px; color:#555; }
    .fit-bar { height:10px; background:#e6e6e6; border-radius:6px; overflow:hidden; }
    .fit-fill { height:100%; width:0%; background: linear-gradient(90deg,#667eea,#764ba2); transition: width .8s ease; }
    .fit-score { font-weight:700; color:#667eea; text-align:right; }

    /* È¢®Ê†ºÈõ∑ÈÅîÂúñÂÆπÂô® */
    .radar-wrap { background:#fff; border-radius:16px; padding:20px; }
    .radar-sub { font-size:13px; color:#777; margin-top:6px; }

    /* ÂìÅÁâåÂª∫Ë≠∞ chips */
    .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip { padding:6px 12px; border-radius:999px; background:linear-gradient(135deg,#a8edea,#fed6e3); color:#333; font-size:13px; font-weight:600; }

    /* Âª∫Ë≠∞Ê∏ÖÂñÆ */
    .brand-suggest li { padding:12px 14px; background:#f0fff6; border-left:4px solid #22c55e; border-radius:8px; margin-bottom:10px; }

    /* ÂèóÁúæÂàÜÊûê */
    .audience-grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:16px; }
    .aud-card { background:#f8f9fa; border-radius:12px; padding:16px; text-align:center; }
    .aud-chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .aud-chip { padding:4px 10px; border-radius:999px; background:linear-gradient(135deg,#e0c3fc,#8ec5fc); color:#333; font-size:12px; font-weight:500; }

    /* ÊóÖÈÅäÈ°ûÂà•Á¥∞ÂàÜ */
    .travel-split .split-row {
      display: grid;
      grid-template-columns: 120px 1fr 50px;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .split-label { font-size:13px; color:#555; }
    .split-bar { height:8px; background:#e6e6e6; border-radius:4px; overflow:hidden; }
    .split-fill { height:100%; width:0%; background: linear-gradient(90deg,#667eea,#764ba2); transition: width .8s ease; }
    .split-score { font-weight:600; color:#667eea; text-align:right; font-size:13px; }

    /* Â†±ÂÉπÂçÄÈñì‰ø°ÂøÉÊ¢ù */
    .conf-row {
      display: grid;
      grid-template-columns: 100px 1fr;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .conf-label { font-size:14px; color:#555; font-weight:500; }
    .conf-bar { 
      height:12px; 
      background:#f0f0f0; 
      border-radius:6px; 
      overflow:hidden; 
      position:relative;
    }
    .conf-fill { 
      height:100%; 
      background: linear-gradient(90deg,#667eea,#764ba2); 
      border-radius:6px;
      transition: all .8s ease;
    }
    .conf-bounds { 
      font-size:12px; 
      color:#666; 
      margin-top:4px; 
      text-align:center;
    }

    /* ÈüøÊáâÂºè */
    @media (max-width: 768px) {
      .value-amount {
        font-size: 42px;
      }
      
      .value-grid {
        grid-template-columns: 1fr;
      }
      
      .quality-grid {
        grid-template-columns: 1fr;
      }
      
      .card {
        padding: 24px 20px;
      }

      .audience-grid {
        grid-template-columns: 1fr;
      }

      .brand-fit-card .fit-row {
        grid-template-columns: 120px 1fr 50px;
      }

      .travel-split .split-row {
        grid-template-columns: 100px 1fr 45px;
      }

      .conf-row {
        grid-template-columns: 80px 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div><strong>üí∞ IG Ë∫´ÂÉπË©ï‰º∞</strong></div>
    <button class="btn btn-ghost btn-sm" onclick="clearAndRestart()">ÈáçÊñ∞Ë©ï‰º∞</button>
  </header>

  <main class="container">
    <div id="err" class="status-error hidden"></div>
    
    <!-- Áî®Êà∂Ë≥áË®ä -->
    <div class="user-info">
      <div class="user-avatar" id="userAvatar">üë§</div>
      <div class="user-details">
        <h3 id="displayName">‰ΩøÁî®ËÄÖ</h3>
        <div class="user-handle" id="username">@username</div>
        <div class="stats-row">
          <div class="stat"><strong id="followers">0</strong> Á≤âÁµ≤</div>
          <div class="stat"><strong id="following">0</strong> ËøΩËπ§</div>
          <div class="stat"><strong id="posts">0</strong> Ë≤ºÊñá</div>
        </div>
      </div>
    </div>
    
    <!-- ‰∏ªÂÉπÂÄºÂç° -->
    <div class="value-hero">
      <div class="value-hero-content">
        <div class="type-badge" id="typeBadge">
          <span class="type-emoji">üé®</span>
          <span id="typeName">Ââµ‰ΩúËÄÖ</span>
        </div>
        <div class="value-label">‰Ω†ÁöÑÁôºÊñáÂÉπÂÄº</div>
        <div class="value-amount">
          NT$ <span id="postValue">0</span>
        </div>
        <div class="value-per">/ ÁØá</div>
        
        <div class="value-grid">
          <div class="value-item">
            <div class="value-item-label">üé¨ Story</div>
            <div class="value-item-amount">NT$ <span id="storyValue">0</span></div>
          </div>
          <div class="value-item">
            <div class="value-item-label">üìπ Reels</div>
            <div class="value-item-amount">NT$ <span id="reelsValue">0</span></div>
          </div>
          <div class="value-item">
            <div class="value-item-label">üì¶ ÊúàÈÖçÂêà</div>
            <div class="value-item-amount">NT$ <span id="monthlyValue">0</span></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ÂÉπÂÄºÁµÑÊàêÂàÜÊûê -->
    <div class="card">
      <div class="breakdown-section">
        <h2 class="breakdown-title">üìä ÂÉπÂÄºÁµÑÊàêÂàÜÊûê</h2>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">Âü∫Á§éË∫´ÂÉπÔºàÁ≤âÁµ≤Êï∏Ôºâ</div>
            <div class="breakdown-sublabel" id="followerTier">‚Äî</div>
          </div>
          <div class="breakdown-value">NT$ <span id="basePrice">0</span></div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">Ë¶ñË¶∫ÂìÅË≥™Âä†Êàê</div>
            <div class="breakdown-sublabel">Ëâ≤ÂΩ©„ÄÅÊßãÂúñ„ÄÅÂæåË£ΩÂìÅË≥™</div>
          </div>
          <div>
            <span class="multiplier-badge" id="visualMult">√ó1.0</span>
          </div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">ÂÖßÂÆπÈ°ûÂûãÂä†Êàê</div>
            <div class="breakdown-sublabel" id="contentType">‚Äî</div>
          </div>
          <div>
            <span class="multiplier-badge" id="contentMult">√ó1.0</span>
          </div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">Â∞àÊ•≠Â∫¶Âä†Êàê</div>
            <div class="breakdown-sublabel">Bio„ÄÅÁôºÊñáË¶èÂæã„ÄÅÂìÅÁâåË≠òÂà•</div>
          </div>
          <div>
            <span class="multiplier-badge" id="profMult">√ó1.0</span>
          </div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">Á≤âÁµ≤ÂìÅË≥™Âä†Êàê</div>
            <div class="breakdown-sublabel" id="followerQuality">‚Äî</div>
          </div>
          <div>
            <span class="multiplier-badge" id="followerMult">√ó1.0</span>
          </div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">È¢®Ê†ºÁç®ÁâπÊÄßÂä†Êàê</div>
            <div class="breakdown-sublabel" id="styleSignature">‚Äî</div>
          </div>
          <div>
            <span class="multiplier-badge" id="uniqueMult">√ó1.0</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ÂìÅË≥™Ë©ïÂàÜ -->
    <div class="card">
      <h2 class="breakdown-title">‚≠ê ÂìÅË≥™Ë©ïÂàÜ</h2>
      <div class="quality-grid" id="qualityGrid">
        <!-- JavaScript ÂãïÊÖãÁîüÊàê -->
      </div>
    </div>

    <!-- È¢®Ê†ºÈõ∑ÈÅîÂúñ -->
    <div class="card">
      <h2 class="breakdown-title">üß≠ È¢®Ê†ºÊåáÊï∏ Radar</h2>
      <div class="radar-wrap">
        <canvas id="styleRadar" height="220"></canvas>
        <div class="radar-sub">‰ª•„ÄåÁúüÂØ¶Â∫¶„ÄÅÊôÇÂ∞öÊÑü„ÄÅË¶™ÂíåÂäõ„ÄÅÂ®õÊ®ÇÊÄß„ÄÅÂ∞àÊ•≠Â∫¶„Äç‰∫îËª∏Ë©ï‰º∞Â∏≥ËôüË™øÊÄß„ÄÇ</div>
      </div>
    </div>

    <!-- ÂìÅÁâåÂ•ëÂêàÂ∫¶ -->
    <div class="card brand-fit-card">
      <h2 class="breakdown-title">üè∑Ô∏è ÂìÅÁâåÂ•ëÂêàÂ∫¶</h2>
      <div id="brandFitRows"></div>
      <div class="chips" id="brandFitChips"></div>
    </div>

    <!-- Âêà‰ΩúÂìÅÁâåÂª∫Ë≠∞ -->
    <div class="card">
      <h2 class="breakdown-title">ü§ù Âêà‰ΩúÂìÅÁâåÂª∫Ë≠∞</h2>
      <ul class="brand-suggest" id="brandSuggestList"></ul>
    </div>

    <!-- ÂèóÁúæËº™ÂªìÊé®Ê∏¨ -->
    <div class="card">
      <h2 class="breakdown-title">üë• ÂèóÁúæËº™ÂªìÔºàÊé®Ê∏¨Ôºâ</h2>
      <div class="audience-grid">
        <div class="aud-card">
          <canvas id="genderPie" height="160"></canvas>
          <div class="radar-sub">‰ª•ÂΩ±ÂÉè/ÊñáÂ≠óË™øÊÄßÊé®Ê∏¨ÊÄßÂà•Âç†ÊØî„ÄÇ</div>
        </div>
        <div class="aud-card">
          <canvas id="ageBar" height="160"></canvas>
          <div class="radar-sub">Âπ¥ÈΩ°ÂçÄÈñìÔºà18‚Äì24„ÄÅ25‚Äì34„ÄÅ35‚Äì44„ÄÅ45+Ôºâ„ÄÇ</div>
        </div>
      </div>
      <div style="margin-top:12px;">
        <div class="quality-label">ÂüéÂ∏ÇÔºèÈ¢®Ê†ºÂÅèÂ•ΩÔºàÊé®Ê∏¨Ôºâ</div>
        <div class="aud-chips" id="cityStyleChips"></div>
      </div>
    </div>

    <!-- ÊóÖÈÅäÈ°ûÂà•Á¥∞ÂàÜ -->
    <div class="card travel-split">
      <h2 class="breakdown-title">üè® ÊóÖÈÅäÈ°ûÂà•Á¥∞ÂàÜ</h2>
      <div id="travelSplitRows"></div>
    </div>

    <!-- Â†±ÂÉπÂçÄÈñìÔºà‰ø°ÂøÉÊ¢ùÔºâ -->
    <div class="card">
      <h2 class="breakdown-title">üìâ Â†±ÂÉπÂçÄÈñìÔºà‰ø°ÂøÉÊ¢ùÔºâ</h2>
      <div class="conf-row">
        <div class="conf-label">Ë≤ºÊñá Post</div>
        <div>
          <div class="conf-bar"><div id="postConf" class="conf-fill" style="left:0%; width:0%"></div></div>
          <div id="postBounds" class="conf-bounds"></div>
        </div>
      </div>
      <div class="conf-row">
        <div class="conf-label">ÈôêÂãï Story</div>
        <div>
          <div class="conf-bar"><div id="storyConf" class="conf-fill" style="left:0%; width:0%"></div></div>
          <div id="storyBounds" class="conf-bounds"></div>
        </div>
      </div>
      <div class="conf-row">
        <div class="conf-label">Áü≠Áâá Reels</div>
        <div>
          <div class="conf-bar"><div id="reelsConf" class="conf-fill" style="left:0%; width:0%"></div></div>
          <div id="reelsBounds" class="conf-bounds"></div>
        </div>
      </div>
      <div class="conf-row">
        <div class="conf-label">ÊúàÈÖçÂêà</div>
        <div>
          <div class="conf-bar"><div id="monthlyConf" class="conf-fill" style="left:0%; width:0%"></div></div>
          <div id="monthlyBounds" class="conf-bounds"></div>
        </div>
      </div>
      <div class="radar-sub">Ë™™ÊòéÔºö‰æùË¶ñË¶∫ÂìÅË≥™„ÄÅÂ∞àÊ•≠Â∫¶„ÄÅÂÖßÂÆπÈ°ûÂûãËàáÁ≤âÁµ≤ÂìÅË≥™Êé®‰º∞ ¬±(10%‚Äì35%) ÁöÑ‰∏çÁ¢∫ÂÆöÊÄßÂçÄÈñì„ÄÇ</div>
    </div>
    
    <!-- ÂÉπÂÄºÈô≥Ëø∞ -->
    <div class="card">
      <h2 class="breakdown-title">üí¨ ‰Ω†ÁöÑÂÉπÂÄºÂÆö‰Ωç</h2>
      <p style="font-size: 16px; line-height: 1.8; color: #333;" id="valueStatement">
        ËºâÂÖ•‰∏≠...
      </p>
    </div>
    
    <!-- ÊîπÈÄ≤Âª∫Ë≠∞ -->
    <div class="card">
      <h2 class="breakdown-title">üìà ÂÉπÂÄºÊèêÂçáÂª∫Ë≠∞</h2>
      <ul class="tips-list" id="improvementTips">
        <!-- JavaScript ÂãïÊÖãÁîüÊàê -->
      </ul>
    </div>
    
    <div class="action-buttons">
      <button class="btn-restart" onclick="clearAndRestart()">
        üîÑ ÈáçÊñ∞Ë©ï‰º∞
      </button>
    </div>
  </main>

  <script type="module">
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Èò≤Ê≠¢ËøîÂõû
    (function() {
      if (window.history && window.history.pushState) {
        window.history.pushState(null, null, window.location.href);
        window.addEventListener('popstate', function() {
          window.history.pushState(null, null, window.location.href);
          if (confirm('‚ö†Ô∏è ÁÑ°Ê≥ïËøîÂõû‰∏ä‰∏ÄÈ†Å\n\nËã•Ë¶ÅÈáçÊñ∞Ë©ï‰º∞ÔºåË´ãÈªûÊìä„ÄåÈáçÊñ∞Ë©ï‰º∞„Äç„ÄÇ')) {
            clearAndRestart();
          }
        });
      }
    })();

    function formatNumber(num) {
      return num.toLocaleString('zh-TW');
    }

    function destroyAllCharts() {
      // Èä∑ÊØÄÊâÄÊúâÂúñË°®ÂØ¶‰æã
      if (window.styleRadarChart) {
        window.styleRadarChart.destroy();
        window.styleRadarChart = null;
      }
      if (window.genderPieChart) {
        window.genderPieChart.destroy();
        window.genderPieChart = null;
      }
      if (window.ageBarChart) {
        window.ageBarChart.destroy();
        window.ageBarChart = null;
      }
    }

    function fillUI(data) {
      console.log('Filling UI with data:', data);
      
      // Ê∏ÖÁêÜÁèæÊúâÂúñË°®ÂØ¶‰æã
      destroyAllCharts();
      
      // Âü∫Êú¨Ë≥áË®ä
      document.getElementById('displayName').textContent = data.display_name || '‰ΩøÁî®ËÄÖ';
      document.getElementById('username').textContent = data.username ? '@' + data.username : '‚Äî';
      document.getElementById('followers').textContent = formatNumber(data.followers || 0);
      document.getElementById('following').textContent = formatNumber(data.following || 0);
      document.getElementById('posts').textContent = formatNumber(data.posts || 0);
      
      // È°ûÂûã
      const type = data.primary_type || {};
      document.getElementById('typeBadge').innerHTML = `
        <span class="type-emoji">${type.emoji || 'üé®'}</span>
        <span>${type.name_zh || 'Ââµ‰ΩúËÄÖ'}</span>
      `;
      
      // È†≠ÂÉè emoji
      document.getElementById('userAvatar').textContent = type.emoji || 'üë§';
      
      // ÂÉπÂÄº
      const value = data.value_estimation || {};
      document.getElementById('postValue').textContent = formatNumber(value.post_value || 0);
      document.getElementById('storyValue').textContent = formatNumber(value.story_value || 0);
      document.getElementById('reelsValue').textContent = formatNumber(value.reels_value || 0);
      document.getElementById('monthlyValue').textContent = formatNumber(value.monthly_package || 0);
      
      // ÂÉπÂÄºÁµÑÊàê
      document.getElementById('basePrice').textContent = formatNumber(value.base_price || 0);
      document.getElementById('followerTier').textContent = 
        `‰Ω†ÁöÑÁ¥öÂà•Ôºö${value.follower_tier || 'Á¥†‰∫∫'}Ôºà${formatNumber(data.followers || 0)} Á≤âÁµ≤Ôºâ`;
      
      const mult = value.multipliers || {};
      document.getElementById('visualMult').textContent = '√ó' + (mult.visual || 1.0);
      document.getElementById('contentMult').textContent = '√ó' + (mult.content || 1.0);
      document.getElementById('profMult').textContent = '√ó' + (mult.professional || 1.0);
      document.getElementById('followerMult').textContent = '√ó' + (mult.follower || 1.0);
      document.getElementById('uniqueMult').textContent = '√ó' + (mult.unique || 1.0);
      
      // ÂÖßÂÆπÈ°ûÂûã
      const analysis = data.analysis || {};
      const contentType = analysis.content_type || {};
      const topic = contentType.primary || 'ÁîüÊ¥ª';
      document.getElementById('contentType').textContent = topic;
      
      // Á≤âÁµ≤ÂìÅË≥™
      document.getElementById('followerQuality').textContent = 
        `Á≤âÁµ≤/ËøΩËπ§ÊØî = ${(data.followers / (data.following || 1)).toFixed(1)}Ôºà${value.follower_quality || 'Ê®ôÊ∫ñ'}Ôºâ`;
      
      // È¢®Ê†ºÁ∞ΩÂêç
      const uniqueness = analysis.uniqueness || {};
      document.getElementById('styleSignature').textContent = uniqueness.style_signature || '‚Äî';
      
      // ÂìÅË≥™Ë©ïÂàÜ
      const visual = analysis.visual_quality || {};
      const qualityItems = [
        { label: 'Ëâ≤ÂΩ©ÂíåË´ßÂ∫¶', score: visual.color_harmony || 5 },
        { label: 'ÊßãÂúñÂ∞àÊ•≠Â∫¶', score: visual.composition || 5 },
        { label: 'ÂæåË£ΩÂìÅË≥™', score: visual.editing || 5 },
        { label: 'Êï¥È´îÁæéÊÑü', score: visual.overall || 5 }
      ];
      
      const qualityGrid = document.getElementById('qualityGrid');
      qualityGrid.innerHTML = '';
      
      qualityItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'quality-item';
        div.innerHTML = `
          <div class="quality-label">${item.label}</div>
          <div class="quality-bar">
            <div class="quality-fill" style="width: ${item.score * 10}%"></div>
          </div>
          <div class="quality-score">${item.score.toFixed(1)} / 10</div>
        `;
        qualityGrid.appendChild(div);
      });

      // ---- Radar Style Index ----
      const style = (analysis.style_index || {});
      const radarData = [
        style.authenticity ?? Math.min(10, (visual.overall || 6) * 0.9 + 1.5),
        style.fashion ?? (visual.color_harmony || 6) * 0.9,
        style.affinity ?? (mult.follower >= 1.5 ? 7.5 : 6.2),
        style.entertainment ?? (contentType.primary?.includes('ÊóÖÈÅä') || contentType.primary?.includes('ÁîüÊ¥ª') ? 7.8 : 6.0),
        style.professional ?? (mult.professional ? 6 + (mult.professional-1)*4 : 6.2),
      ].map(v => Math.max(3, Math.min(9.8, Number(v))));

      const ctx = document.getElementById('styleRadar');
      if (ctx && window.Chart) {
        // Èä∑ÊØÄÁèæÊúâÁöÑÂúñË°®ÂØ¶‰æã
        if (window.styleRadarChart) {
          window.styleRadarChart.destroy();
        }
        
        window.styleRadarChart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: ['ÁúüÂØ¶Â∫¶','ÊôÇÂ∞öÊÑü','Ë¶™ÂíåÂäõ','Â®õÊ®ÇÊÄß','Â∞àÊ•≠Â∫¶'],
            datasets: [{
              label: 'È¢®Ê†ºÊåáÊï∏',
              data: radarData
            }]
          },
          options: {
            responsive: true,
            scales: { r: { suggestedMin: 0, suggestedMax: 10, ticks: { stepSize: 2 } } },
            plugins: { legend: { display: false } }
          }
        });
      }

      // ---- Brand Fit ----
      const bf = window._IG_BrandFit?.computeBrandFit({
        topic,
        visual,
        multipliers: mult
      }) || { scores: [], suggested: [] };

      const rows = document.getElementById('brandFitRows');
      const chips = document.getElementById('brandFitChips');
      rows.innerHTML = ''; chips.innerHTML = '';

      (bf.scores || []).forEach(item => {
        const row = document.createElement('div');
        row.className = 'fit-row';
        row.innerHTML = `
          <div class="fit-label">${item.label}</div>
          <div class="fit-bar"><div class="fit-fill" style="width:${item.score}%"></div></div>
          <div class="fit-score">${item.score}%</div>`;
        rows.appendChild(row);
      });

      (bf.suggested || []).forEach(t => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = t;
        chips.appendChild(chip);
      });

      // ---- Collaboration Suggestions ----
      const suggest = document.getElementById('brandSuggestList');
      suggest.innerHTML = '';

      function addSuggest(title, body) {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${title}</strong><br>${body}`;
        suggest.appendChild(li);
      }

      const tier = (value.follower_tier || '').toString();
      const postVal = Number(value.post_value || 0);
      const storyVal = Number(value.story_value || 0);
      const reelsVal = Number(value.reels_value || 0);

      addSuggest('ÊóÖÂÆø 2Â§©1Â§ú ‰ΩèÂÆø‰∫§Êèõ + ÂÖßÂÆπÊéàÊ¨ä',
        `‰ª• Reels + Ë≤ºÊñá + 2-3 ÁµÑ StoryÔºåÊèõÂèñÂπ≥Êó•ÂÖ•‰ΩèÔºàÊàñÊäòÊäµÈáëÈ°ç NT$ ${(postVal*0.6).toLocaleString('zh-TW')}ÔºâÔºåÂª∫Ë≠∞Âä†Ë≥º‰∫åÊ¨°ÊõùÂÖâÔºàÂä†ÂÉπ NT$ ${(storyVal*0.5).toLocaleString('zh-TW')}Ôºâ„ÄÇ`);

      addSuggest('È§êÈ£≤Ë©¶ÂêÉÔºãÁü≠ÂΩ±Èü≥Â•óÈ§ê',
        `1 Reels + 1 Story Á≤æÈÅ∏ÔºàÊ∞∏‰πÖÔºâÔºåÂª∫Ë≠∞Â†±ÂÉπ NT$ ${(reelsVal*0.85).toLocaleString('zh-TW')}ÔºåÁõÆÊ®ôÊäïÊîæÊñºÂïÜÂúàÂæÆÂûãÂìÅÁâå„ÄÇ`);

      addSuggest('ÁîüÊ¥ªÂÆ∂ÈõªÈ´îÈ©óÔºãÊúàÈÖçÂêà',
        `ÊØèÊúà 1 Ë≤ºÊñá + 2 StoryÔºåÊúàË≤ª NT$ ${(Math.max(15000, postVal*0.4+storyVal*0.6)).toLocaleString('zh-TW')}ÔºåÂê´Âü∫Á§éÁ¥†ÊùêÊéàÊ¨äÔºà30Â§©Ôºâ„ÄÇ`);

      if (postVal > 60000) {
        addSuggest('ÂìÅÁâåÂ§ß‰ΩøÔºàÂ≠£Â∫¶Ôºâ',
          `ÊØèÂ≠£ 2 Ë≤ºÊñá + 3 Reels + 6 StoryÔºåÂ≠£Â∫¶Ë≤ªÁî®Á¥Ñ NT$ ${(postVal*3 + reelsVal*2).toLocaleString('zh-TW')}ÔºåÂê´ÂìÅÁâåÈ†ÅÈù¢Èú≤Âá∫ËàáÂÆòÁ∂≤Á¥†Êùê„ÄÇ`);
      }

      // ---- Audience Synthesis ----
      const audSynth = window._IG_Audience?.synthesizeAudience({
        topic,
        visual,
        mult,
        analysis
      }) || { male_ratio:0.5, age_dist:[0.25,0.45,0.2,0.1], city_styles:['Âè∞ÂåóÈÉΩÊúÉ','ÁîüÊ¥ªÊ©üËÉΩ'] };

      const male = audSynth.male_ratio;
      const female = audSynth.female_ratio;
      const ageDist = audSynth.age_dist;

      if (window.Chart) {
        const gctx = document.getElementById('genderPie');
        if (gctx) {
          // Èä∑ÊØÄÁèæÊúâÁöÑÊÄßÂà•ÂúìÈ§ÖÂúñÂØ¶‰æã
          if (window.genderPieChart) {
            window.genderPieChart.destroy();
          }
          
          window.genderPieChart = new Chart(gctx, {
            type:'doughnut',
            data:{ labels:['Áî∑ÊÄß','Â•≥ÊÄß'], datasets:[{ data:[Math.round(male*100), Math.round(female*100)] }] },
            options:{ plugins:{ legend:{ position:'bottom' } } }
          });
        }

        const actx = document.getElementById('ageBar');
        if (actx) {
          // Èä∑ÊØÄÁèæÊúâÁöÑÂπ¥ÈΩ°Èï∑Ê¢ùÂúñÂØ¶‰æã
          if (window.ageBarChart) {
            window.ageBarChart.destroy();
          }
          
          window.ageBarChart = new Chart(actx, {
            type:'bar',
            data:{
              labels:['18‚Äì24','25‚Äì34','35‚Äì44','45+'],
              datasets:[{ label:'Âç†ÊØî(%)', data: ageDist.map(x=>Math.round(x*100)) }]
            },
            options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ suggestedMax: 60 } } }
          });
        }
      }

      // City style chips
      const chipEl = document.getElementById('cityStyleChips');
      if (chipEl) {
        chipEl.innerHTML = '';
        (audSynth.city_styles || []).forEach(name => {
          const d = document.createElement('div');
          d.className = 'aud-chip';
          d.textContent = name;
          chipEl.appendChild(d);
        });
      }

      // ---- Travel Split ----
      const tsRows = document.getElementById('travelSplitRows');
      if (tsRows) {
        tsRows.innerHTML = '';
        const ts = window._IG_Travel?.synthesizeTravelSplit({ topic, visual, uniqueness, analysis }) ||
                   { city_hotel:72, resort:75, design_hotel:70 };
        const items = [
          {label:'ÂüéÂ∏ÇÈ£ØÂ∫ó', v: ts.city_hotel},
          {label:'Â∫¶ÂÅáÊùë', v: ts.resort},
          {label:'Ë®≠Ë®àÊóÖÂ∫ó', v: ts.design_hotel},
        ];
        items.forEach(it => {
          const row = document.createElement('div');
          row.className = 'split-row';
          row.innerHTML = `
            <div class="split-label">${it.label}</div>
            <div class="split-bar"><div class="split-fill" style="width:${it.v}%"></div></div>
            <div class="split-score">${it.v}%</div>`;
          tsRows.appendChild(row);
        });
      }

      // ---- Pricing Confidence Bands ----
      function setBounds(idFill, idText, center, pct){
        const lo = Math.max(0, Math.round(center*(1-pct)));
        const hi = Math.round(center*(1+pct));
        const total = hi==0?1:hi;
        const left = (lo/total)*100;
        const width = ((hi-lo)/total)*100;
        const fill = document.getElementById(idFill);
        const txt = document.getElementById(idText);
        if (fill) { fill.style.left = left+'%'; fill.style.width = width+'%'; }
        if (txt) { txt.textContent = `‰º∞Ë®àÂçÄÈñìÔºöNT$ ${lo.toLocaleString('zh-TW')} ~ NT$ ${hi.toLocaleString('zh-TW')}Ôºà¬±${Math.round(pct*100)}%Ôºâ`; }
      }

      const bands = window._IG_Pricing?.getConfidenceBands({
        value,
        visual,
        mult,
        contentPrimary: contentType.primary || ''
      }) || { post:0.2, story:0.22, reels:0.25, monthly:0.15 };

      setBounds('postConf','postBounds', Number(value.post_value||0), bands.post);
      setBounds('storyConf','storyBounds', Number(value.story_value||0), bands.story);
      setBounds('reelsConf','reelsBounds', Number(value.reels_value||0), bands.reels);
      setBounds('monthlyConf','monthlyBounds', Number(value.monthly_package||0), bands.monthly);
      
      // ÂÉπÂÄºÈô≥Ëø∞
      document.getElementById('valueStatement').textContent = 
        data.value_statement || 'Ê≠£Âú®ÂàÜÊûê‰Ω†ÁöÑÁç®ÁâπÂÉπÂÄº...';
      
      // ÊîπÈÄ≤Âª∫Ë≠∞
      const tips = data.improvement_tips || [];
      const tipsList = document.getElementById('improvementTips');
      tipsList.innerHTML = '';
      
      if (tips.length > 0) {
        tips.forEach(tip => {
          const li = document.createElement('li');
          li.className = 'tip-item';
          li.textContent = tip;
          tipsList.appendChild(li);
        });
      } else {
        tipsList.innerHTML = '<li class="tip-item">ÁõÆÂâçÊ≤íÊúâÂª∫Ë≠∞Ôºå‰Ω†ÁöÑÂ∏≥ËôüÂ∑≤Á∂ìÂæàÊ£í‰∫ÜÔºÅ</li>';
      }
    }

    async function loadResult() {
      const saved = sessionStorage.getItem('sa_result');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (data && data.ok) {
            fillUI(data);
            return;
          }
        } catch {}
      }
      
      // Fallback: Âæû debug endpoint
      try {
        const r = await fetch('/debug/last_ai?ts=' + Date.now());
        if (r.ok) {
          const j = await r.json();
          let parsed = null;
          try {
            parsed = JSON.parse(j.text || j.raw || '{}');
          } catch {}
          if (parsed && parsed.ok) {
            fillUI(parsed);
            return;
          }
        }
      } catch {}
      
      // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞ÁúüÂØ¶Êï∏ÊìöÔºåÈ°ØÁ§∫Á§∫‰æãÊï∏ÊìöÁî®ÊñºÊºîÁ§∫
      console.log('Ê≤íÊúâÊâæÂà∞ÁúüÂØ¶ÂàÜÊûêÁµêÊûúÔºåÈ°ØÁ§∫Á§∫‰æãÊï∏Êìö');
      showDemoModeNotice();
      const demoData = createDemoData();
      fillUI(demoData);
    }

    function showDemoModeNotice() {
      // Âú®È†ÅÈù¢È†ÇÈÉ®È°ØÁ§∫ÊºîÁ§∫Ê®°ÂºèÊèêÁ§∫
      const notice = document.createElement('div');
      notice.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #ff6b6b, #ffa500);
        color: white;
        padding: 12px;
        text-align: center;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      `;
      notice.innerHTML = `
        üé≠ ÊºîÁ§∫Ê®°ÂºèÔºöÊ≠£Âú®È°ØÁ§∫Á§∫‰æãÊï∏Êìö„ÄÇË¶ÅÊü•ÁúãÁúüÂØ¶ÂàÜÊûêÁµêÊûúÔºåË´ãÂÖà‰∏äÂÇ≥‰Ω†ÁöÑ IG Ë≥áÊñôÈÄ≤Ë°åÂàÜÊûê„ÄÇ
        <button onclick="this.parentElement.remove()" style="margin-left: 10px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button>
      `;
      document.body.insertBefore(notice, document.body.firstChild);
      
      // Ë™øÊï¥È†ÅÈù¢È†ÇÈÉ®ÈñìË∑ù
      document.body.style.paddingTop = '60px';
    }

    function createDemoData() {
      return {
        ok: true,
        display_name: "Danny TJ Kan | üèÄü¶Åüî•üêº",
        username: "dannytjkan",
        followers: 10100,
        following: 909,
        posts: 181,
        primary_type: {
          emoji: "üçú",
          name_zh: "ÁîüÊ¥ªË®òÈåÑËÄÖ"
        },
        value_estimation: {
          post_value: 55721,
          story_value: 22288,
          reels_value: 72437,
          monthly_package: 222884,
          base_price: 12000,
          follower_tier: "ÊÑèË¶ãÈ†òË¢ñ",
          multipliers: {
            visual: 1.5,
            content: 1.0,
            professional: 1.59,
            follower: 1.5,
            unique: 1.3
          },
          follower_quality: "È´òÂΩ±ÈüøÂäõ"
        },
        analysis: {
          content_type: {
            primary: "ÊóÖÈÅäÁæéÈ£ü"
          },
          visual_quality: {
            color_harmony: 7.5,
            composition: 7.0,
            editing: 7.8,
            overall: 7.5
          },
          uniqueness: {
            style_signature: "Èö®ÊÄßÁîüÊ¥ªÁ¥ÄÈåÑ"
          },
          style_index: {
            authenticity: 8.2,
            fashion: 6.8,
            affinity: 7.5,
            entertainment: 7.9,
            professional: 6.5
          }
        },
        value_statement: "ÊçïÊçâÁîüÊ¥ª‰∏≠ÁöÑÊØè‰∏ÄÂàªÔºåÂ±ïÁèæÁúüÂØ¶ËÄåÈö®ÊÄßÁöÑÊó•Â∏∏ÊïÖ‰∫ã„ÄÇ",
        improvement_tips: [
          "Â¢ûÂä†Â∞àÊ•≠ÊîùÂΩ±‰ΩúÂìÅ‰ª•ÊèêÂçáË¶ñË¶∫Âê∏ÂºïÂäõ",
          "‰ΩøÁî® Hashtags Â¢ûÂä†ÊõùÂÖâÁéá",
          "ÂòóË©¶Áôº‰ΩàÁü≠ÂΩ±Áâá‰ª•Âê∏ÂºïÊõ¥Â§ö‰∫íÂãï",
          "ËÄÉÊÖÆËàáÂÖ∂‰ªñÂÖßÂÆπÂâµ‰ΩúËÄÖÂêà‰Ωú‰ª•Êì¥Â§ßÂΩ±ÈüøÂäõ"
        ]
      };
    }

    window.clearAndRestart = async function() {
      if (!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâË≥áÊñô‰∏¶ÈáçÊñ∞ÈñãÂßãÔºü')) return;
      
      try {
        const config = {
          apiKey: "AIzaSyBI2-4yEwzxvYOvui9FZiGAzCE22OhKmU8",
          authDomain: "social-avatar-d13c8.firebaseapp.com",
          projectId: "social-avatar-d13c8",
          storageBucket: "social-avatar-d13c8.appspot.com",
          messagingSenderId: "280598358339",
          appId: "1:280598358339:web:214a0d4ca53793163367f6"
        };

        const app = getApps().length ? getApps()[0] : initializeApp(config);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const user = auth.currentUser;
        if (user) {
          await deleteDoc(doc(db, 'users', user.uid)).catch(() => {});
        }
        
        sessionStorage.clear();
        localStorage.clear();
        await signOut(auth).catch(() => {});
        
        alert('‚úÖ Â∑≤Ê∏ÖÈô§ÊâÄÊúâË≥áÊñô');
        location.replace('/static/landing.html');
      } catch (e) {
        alert('Ê∏ÖÈô§Â§±ÊïóÔºö' + e.message);
      }
    };

    window.addEventListener('DOMContentLoaded', loadResult);
  </script>
</body>
</html>
