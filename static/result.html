<script>
/**
 * 先讀 localStorage，再補打 /debug/last_ai。都沒有就顯示錯誤。
 */
const KEY = "sa_result";

function render(ai) {
  // 根據你的 UI 元素 id 對應塞值；以下是範例：
  const $ = (sel) => document.querySelector(sel);
  $("#displayName").textContent = ai.display_name || "使用者";
  $("#username").textContent    = ai.username ? "@" + ai.username : "@—";
  $("#followers").textContent   = (ai.followers ?? 0).toLocaleString();
  $("#following").textContent   = (ai.following ?? 0).toLocaleString();
  $("#posts").textContent       = (ai.posts ?? 0).toLocaleString();
  $("#mbti").textContent        = ai.mbti || "—";
  $("#vehicle").textContent     = ai.vehicle || "—";
  $("#summary").textContent     = ai.summary || "依上傳截圖初步推斷，僅供娛樂參考。";

  // 錯誤細節（若有）
  const detailBox = $("#errorDetail");
  if (detailBox) {
    let txt = "";
    if (ai.__used_fallback) txt += "（此結果為 fallback ）\n";
    if (ai.__raw && ai.__raw.trim()) txt += ai.__raw;
    detailBox.textContent = txt;
    detailBox.style.display = txt ? "block" : "none";
  }
}

function looksValid(ai) {
  return !!(ai && (ai.username || ai.summary || ai.followers > 0 || ai.posts > 0 || (ai.mbti && ai.mbti.length > 2)));
}

async function boot() {
  // 1) localStorage
  try {
    const raw = localStorage.getItem(KEY);
    if (raw) {
      const ai = JSON.parse(raw);
      if (looksValid(ai)) {
        render(ai);
        return;
      }
    }
  } catch (e) {
    console.log("local parse err:", e);
  }

  // 2) fallback：直接問後端
  try {
    const r = await fetch("/debug/last_ai", { cache: "no-store" });
    if (r.ok) {
      const data = await r.json();
      const ai   = data.ai || data;
      if (looksValid(ai)) {
        // 補寫入，避免 F5 又沒資料
        localStorage.setItem(KEY, JSON.stringify({
          ...ai,
          __raw: data.raw || "",
          __used_fallback: !!data.used_fallback
        }));
        render(ai);
        return;
      }
    }
  } catch (e) {
    console.log("fetch last_ai err:", e);
  }

  // 3) 兩邊都沒有 → 給提示與回上傳
  alert("找不到分析結果，請重新上傳並開始分析。");
  location.href = "/static/upload.html";
}

boot();

// 註銷並重來（你頁面上有「註銷並重來」按鈕就綁它）
window.saReset = function () {
  localStorage.removeItem(KEY);
  location.href = "/static/landing.html";
};
</script>
