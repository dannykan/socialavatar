<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test Firestore</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
    button { padding: 10px 20px; margin: 10px 0; cursor: pointer; font-size: 16px; }
    .log { background: #000; padding: 10px; margin: 10px 0; border: 1px solid #333; max-height: 400px; overflow-y: auto; }
    .success { color: #00ff00; }
    .error { color: #ff0000; }
    .info { color: #00aaff; }
  </style>
</head>
<body>
  <h1>üî• Firestore Connection Test</h1>
  <p>This page tests if Firestore is working correctly.</p>
  
  <button onclick="testFirestore()">1. Test Firestore Connection</button>
  <button onclick="testWrite()">2. Test Write Data</button>
  <button onclick="testRead()">3. Test Read Data</button>
  <button onclick="clearLog()">Clear Log</button>
  
  <div class="log" id="log"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBI2-4yEwzxvYOvui9FZiGAzCE22OhKmU8",
      authDomain: "social-avatar-d13c8.firebaseapp.com",
      projectId: "social-avatar-d13c8",
      storageBucket: "social-avatar-d13c8.appspot.com",
      messagingSenderId: "280598358339",
      appId: "1:280598358339:web:214a0d4ca53793163367f6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.db = db;
    window.auth = auth;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      logDiv.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    window.clearLog = function() {
      document.getElementById('log').innerHTML = '';
    };

    // Check auth on load
    onAuthStateChanged(auth, (user) => {
      if (user) {
        log(`‚úÖ Logged in as: ${user.email} (${user.uid})`, 'success');
      } else {
        log('‚ö†Ô∏è  Not logged in. Please login first.', 'error');
      }
    });

    window.testFirestore = async function() {
      log('Testing Firestore connection...', 'info');
      
      const user = auth.currentUser;
      if (!user) {
        log('‚ùå Not logged in! Click below to login:', 'error');
        const provider = new GoogleAuthProvider();
        try {
          await signInWithPopup(auth, provider);
          log('‚úÖ Login successful!', 'success');
        } catch (error) {
          log(`‚ùå Login failed: ${error.message}`, 'error');
        }
        return;
      }

      try {
        const testRef = doc(db, 'users', user.uid);
        log(`‚úÖ Firestore initialized`, 'success');
        log(`üìù Document path: users/${user.uid}`, 'info');
      } catch (error) {
        log(`‚ùå Firestore error: ${error.message}`, 'error');
      }
    };

    window.testWrite = async function() {
      log('Testing Firestore WRITE...', 'info');
      
      const user = auth.currentUser;
      if (!user) {
        log('‚ùå Not logged in! Please run Test 1 first.', 'error');
        return;
      }

      try {
        const testData = {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || 'Test User',
          hasAnalysis: true,
          latestAnalysis: {
            ok: true,
            mbti: 'TEST',
            display_name: 'Test Name',
            username: 'testuser',
            followers: 100,
            following: 50,
            posts: 10,
            summary: 'This is a test analysis',
            vehicle: 'Ê∏¨Ë©¶ËºâÂÖ∑',
            timestamp: serverTimestamp()
          },
          updatedAt: serverTimestamp()
        };

        log(`üì§ Writing to Firestore...`, 'info');
        log(`Data: ${JSON.stringify(testData, null, 2)}`, 'info');

        const userDocRef = doc(db, 'users', user.uid);
        await setDoc(userDocRef, testData);

        log('‚úÖ Write successful!', 'success');
        log('üëâ Now check Firebase Console to see the data', 'success');
      } catch (error) {
        log(`‚ùå Write failed: ${error.message}`, 'error');
        log(`Error code: ${error.code}`, 'error');
        
        if (error.code === 'permission-denied') {
          log('‚ö†Ô∏è  PERMISSION DENIED - Check Firestore Rules!', 'error');
        }
      }
    };

    window.testRead = async function() {
      log('Testing Firestore READ...', 'info');
      
      const user = auth.currentUser;
      if (!user) {
        log('‚ùå Not logged in! Please run Test 1 first.', 'error');
        return;
      }

      try {
        const userDocRef = doc(db, 'users', user.uid);
        log(`üì• Reading from Firestore...`, 'info');
        
        const docSnap = await getDoc(userDocRef);

        if (docSnap.exists()) {
          log('‚úÖ Document found!', 'success');
          log(`Data: ${JSON.stringify(docSnap.data(), null, 2)}`, 'success');
        } else {
          log('‚ö†Ô∏è  Document does not exist', 'error');
          log('Run Test 2 (Write) first to create data', 'info');
        }
      } catch (error) {
        log(`‚ùå Read failed: ${error.message}`, 'error');
        log(`Error code: ${error.code}`, 'error');
        
        if (error.code === 'permission-denied') {
          log('‚ö†Ô∏è  PERMISSION DENIED - Check Firestore Rules!', 'error');
        }
      }
    };

    // Auto-run test on load
    log('üöÄ Firestore Test Page Loaded', 'success');
    log('Click the buttons above to test Firestore', 'info');
  </script>
</body>
</html>
