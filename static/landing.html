<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>SocialAvatar — 登入</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./app.css">
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="h1">歡迎來到 SocialAvatar</div>
      <div class="sub">AI 驅動的 IG 人格分析。登入後即在平台建立帳號。</div>
      <div class="my row">
        <button id="btnGoogle" class="btn brand">使用 Google 登入</button>
        <button id="btnFacebook" class="btn">使用 Facebook 登入</button>
      </div>
      <div class="sub">登入即代表你同意服務條款與隱私政策。</div>
    </div>
  </div>

  <script>
    // …(原本的 Firebase 初始化)
    // 若本機已有分析結果，直接看結果頁
    const hasResult = !!sessionStorage.getItem('BD_RESULT');
    if (hasResult) location.replace('./result.html');
  
    firebase.onAuthStateChanged(auth, (u)=>{
      if(u) {
        // 若已登入而且已有結果，同樣導到結果；否則進上傳
        if (hasResult) location.replace('./result.html');
        else location.replace('./upload.html');
      }
    });
    
    // TODO: 填入你的 Firebase 設定
    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER",
      appId: "APP_ID"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.getAuth();
    const db   = firebase.getFirestore();

    async function createUserIfMissing(user){
      const ref = firebase.doc(db, "users", user.uid);
      const snap = await firebase.getDoc(ref);
      if(!snap.exists()){
        await firebase.setDoc(ref,{
          uid: user.uid,
          email: user.email || null,
          provider: user.providerData?.[0]?.providerId || null,
          analyzed: false,
          createdAt: Date.now(),
          updatedAt: Date.now()
        });
      }else{
        await firebase.updateDoc(ref,{ updatedAt: Date.now() });
      }
    }

    document.getElementById('btnGoogle').onclick = async ()=>{
      const provider = new firebase.GoogleAuthProvider();
      const cred = await firebase.signInWithPopup(auth, provider);
      await createUserIfMissing(cred.user);
      location.href = "./upload.html";
    };

    document.getElementById('btnFacebook').onclick = async ()=>{
      const provider = new firebase.FacebookAuthProvider();
      const cred = await firebase.signInWithPopup(auth, provider);
      await createUserIfMissing(cred.user);
      location.href = "./upload.html";
    };

    // 若已登入，直接進入上傳頁
    firebase.onAuthStateChanged(auth, (u)=>{
      if(u) location.href = "./upload.html";
    });
  </script>
<script type="module">
  // 1) CDN imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithPopup,
    GoogleAuthProvider, FacebookAuthProvider, signOut, deleteUser
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // 2) 你的 config（從 Console 貼）
  const firebaseConfig = {
    apiKey: "AI...your key...",
    authDomain: "your-project-id.firebaseapp.com",
    projectId: "your-project-id",
    storageBucket: "your-project-id.appspot.com",
    messagingSenderId: "...",
    appId: "1:...:web:..."
  };

  // 3) 初始化
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // 4) 讓別的 script 可取用（可選）
  window.firebase = { app, auth, db,
    onAuthStateChanged, signInWithPopup, GoogleAuthProvider, FacebookAuthProvider,
    signOut, deleteUser, doc, getDoc, setDoc, updateDoc, deleteDoc
  };
</script>
<button id="btnGoogle">用 Google 登入</button>
<button id="btnFacebook">用 Facebook 登入</button>

<script type="module">
  const { auth, db, signInWithPopup, GoogleAuthProvider, FacebookAuthProvider, doc, getDoc, setDoc, onAuthStateChanged } = window.firebase;

  async function afterLogin(user) {
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, {
        email: user.email || "",
        provider: (user.providerData[0]?.providerId || "").replace(".com",""),
        createdAt: Date.now(),
        analyzed: false,
        result: null
      }, { merge: true });
    }
    // 你的策略：若已有結果，去 result；否則去 upload
    const hasResult = !!sessionStorage.getItem("BD_RESULT");
    location.replace(hasResult ? "./result.html" : "./upload.html");
  }

  document.getElementById("btnGoogle").onclick = async () => {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider).then(({user}) => afterLogin(user));
  };

  document.getElementById("btnFacebook").onclick = async () => {
    const provider = new FacebookAuthProvider();
    await signInWithPopup(auth, provider).then(({user}) => afterLogin(user));
  };

  onAuthStateChanged(auth, (u) => {
    if (u) {
      const hasResult = !!sessionStorage.getItem("BD_RESULT");
      location.replace(hasResult ? "./result.html" : "./upload.html");
    }
  });
</script>
</body>
</html>
