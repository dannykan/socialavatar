<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SocialAvatar — 登入</title>
  <style>
    body{margin:0;background:#0b0f14;color:#e6eef9;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto}
    .wrap{min-height:100svh;display:grid;place-items:center}
    .card{width:min(560px,90vw);padding:32px;border-radius:16px;background:#0f1724;border:1px solid #1f2a3c;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 12px;font-size:28px}
    p{opacity:.8}
    button{width:100%;padding:14px 16px;margin:8px 0;border-radius:12px;border:1px solid #334155;background:#172031;color:#e6eef9;cursor:pointer;font-weight:600}
    button:hover{background:#1b263a}
    .hint{margin-top:12px;font-size:12px;opacity:.7}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>IG 人格分析（MBTI）</h1>
      <p>使用 Google 或 Facebook 登入，以建立你的平台帳號。</p>
      <button id="btnGoogle">以 Google 登入</button>
      <button id="btnFacebook">以 Facebook 登入</button>
      <div class="hint">登入後將前往上傳頁，成功分析一次後，往後會直接顯示你的結果頁。</div>
    </div>
  </div>

  <!-- Firebase CDN + 初始化 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup,
      GoogleAuthProvider, FacebookAuthProvider
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    /* TODO: 換成你的 Firebase config */
    const firebaseConfig = {
      apiKey: "AI...YOUR_KEY...",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "XXXX",
      appId: "1:XXXX:web:XXXX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    async function afterLogin(user){
      const ref = doc(db,"users",user.uid);
      const snap= await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref,{
          email: user.email || "",
          provider: (user.providerData?.[0]?.providerId||"").replace(".com",""),
          createdAt: Date.now(),
          analyzed: false,
          result: null
        },{merge:true});
      }
      const hasResult = !!sessionStorage.getItem("BD_RESULT");
      location.replace(hasResult ? "./result.html" : "./upload.html");
    }

    document.getElementById("btnGoogle").onclick = async ()=>{
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider).then(({user})=>afterLogin(user));
    };
    document.getElementById("btnFacebook").onclick = async ()=>{
      const provider = new FacebookAuthProvider();
      await signInWithPopup(auth, provider).then(({user})=>afterLogin(user));
    };

    // 已登入者自動導向
    onAuthStateChanged(auth, (u)=>{
      if(!u) return;
      const hasResult = !!sessionStorage.getItem("BD_RESULT");
      location.replace(hasResult ? "./result.html" : "./upload.html");
    });
  </script>
</body>
</html>
