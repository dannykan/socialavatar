<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å„€è¡¨æ¿ - Social NetWorth</title>
    <link rel="stylesheet" href="/static/app.css">
    <style>
        body {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary));
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: rgba(11, 18, 32, 0.95);
            backdrop-filter: blur(12px);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dashboard-title {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            margin: 0 0 var(--spacing) 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing);
            margin-top: var(--spacing-lg);
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            padding: var(--spacing);
            text-align: center;
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-light);
            margin-bottom: var(--spacing-xs);
        }

        .stat-value {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--primary);
        }

        .analyses-section {
            background: rgba(11, 18, 32, 0.95);
            backdrop-filter: blur(12px);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin: 0 0 var(--spacing-lg) 0;
            color: var(--text);
        }

        .analyses-list {
            display: grid;
            gap: var(--spacing);
        }

        .analysis-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            padding: var(--spacing);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .analysis-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .analysis-username {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text);
        }

        .analysis-date {
            font-size: var(--font-size-sm);
            color: var(--text-light);
        }

        .analysis-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--spacing-sm);
        }

        .analysis-value {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--primary);
        }

        .analysis-text {
            font-size: var(--font-size-sm);
            color: var(--text-light);
            margin-top: var(--spacing-xs);
            line-height: 1.5;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: var(--spacing);
        }

        .loading {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-light);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing);
            margin-top: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: var(--spacing);
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-inverse);
            font-weight: 700;
            font-size: var(--font-size-xl);
            overflow: hidden;
            flex-shrink: 0;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text);
            margin: 0 0 4px 0;
        }

        .user-email {
            font-size: var(--font-size-sm);
            color: var(--text-light);
            margin: 0;
        }

        .chart-section {
            background: rgba(11, 18, 32, 0.95);
            backdrop-filter: blur(12px);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin-top: var(--spacing);
        }

        .chart-svg {
            width: 100%;
            height: 100%;
        }

        .chart-line {
            fill: none;
            stroke: var(--primary);
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .chart-area {
            fill: url(#gradient);
            opacity: 0.3;
        }

        .chart-point {
            fill: var(--primary);
            cursor: pointer;
            transition: r 0.2s;
        }

        .chart-point:hover {
            r: 6;
        }

        .chart-label {
            font-size: var(--font-size-xs);
            fill: var(--text-light);
            text-anchor: middle;
        }

        @media (max-width: 640px) {
            .dashboard-container {
                padding: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .user-profile {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1 class="dashboard-title">ğŸ“Š æˆ‘çš„å„€è¡¨æ¿</h1>
            <div id="userProfile" class="user-profile" style="display: none;">
                <div class="user-avatar" id="userAvatar">
                    <span id="userAvatarInitial">?</span>
                </div>
                <div class="user-info">
                    <div class="user-name" id="userName">è¼‰å…¥ä¸­...</div>
                    <div class="user-email" id="userEmail">-</div>
                </div>
            </div>
            <div class="action-buttons">
                <a href="/static/upload.html" class="btn btn-primary">
                    â• æ–°å¢åˆ†æ
                </a>
                <a href="/static/result.html" class="btn btn-ghost" id="latestResultLink" style="display: none;">
                    ğŸ“„ æŸ¥çœ‹æœ€æ–°çµæœ
                </a>
                <a href="/static/landing.html" class="btn btn-ghost">
                    ğŸ  è¿”å›é¦–é 
                </a>
            </div>
        </div>

        <div id="chartSection" class="chart-section" style="display: none;">
            <h2 class="section-title">ğŸ“ˆ åƒ¹å€¼è¶¨å‹¢</h2>
            <div class="chart-container">
                <svg class="chart-svg" id="valueChart">
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:var(--primary);stop-opacity:0.5" />
                            <stop offset="100%" style="stop-color:var(--primary);stop-opacity:0" />
                        </linearGradient>
                    </defs>
                </svg>
            </div>
        </div>

        <div id="statsSection" class="stats-grid" style="display: none;">
            <div class="stat-card">
                <div class="stat-label">ç¸½åˆ†ææ¬¡æ•¸</div>
                <div class="stat-value" id="totalAnalyses">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ€æ–°åƒ¹å€¼</div>
                <div class="stat-value" id="latestValue">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ€é«˜åƒ¹å€¼</div>
                <div class="stat-value" id="highestValue">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">é¦–æ¬¡åˆ†æ</div>
                <div class="stat-value" id="firstAnalysisDate" style="font-size: var(--font-size-sm);">-</div>
            </div>
        </div>

        <div class="analyses-section">
            <h2 class="section-title">ğŸ“‹ åˆ†ææ­·å²</h2>
            <div id="analysesList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/auth-utils.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBI2-4yEwzxvYOvui9FZiGAzCE22OhKmU8",
            authDomain: "social-avatar-d13c8.firebaseapp.com",
            projectId: "social-avatar-d13c8",
            storageBucket: "social-avatar-d13c8.appspot.com",
            messagingSenderId: "280598358339",
            appId: "1:280598358339:web:214a0d4ca53793163367f6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert('è«‹å…ˆç™»å…¥');
                window.location.href = '/static/landing.html';
                return;
            }
            currentUser = user;
            await loadDashboard();
        });

        async function loadDashboard() {
            try {
                // ç²å–æœ‰æ•ˆçš„ token
                const headers = await getAuthHeaders(currentUser);
                
                // è¼‰å…¥ç”¨æˆ¶è³‡è¨Š
                const userRes = await fetch('/api/user/me', {
                    headers: headers
                });
                
                if (userRes.ok) {
                    const userData = await userRes.json();
                    if (userData.ok) {
                        renderUserProfile(userData.user);
                    }
                }

                // è¼‰å…¥çµ±è¨ˆè³‡è¨Š
                const statsRes = await fetch('/api/user/stats', {
                    headers: headers
                });
                
                if (statsRes.ok) {
                    const statsData = await statsRes.json();
                    if (statsData.ok) {
                        renderStats(statsData.stats);
                        if (statsData.stats.value_history && statsData.stats.value_history.length > 0) {
                            renderChart(statsData.stats.value_history);
                        }
                    }
                }

                // è¼‰å…¥åˆ†æåˆ—è¡¨
                const analysesRes = await fetch('/api/user/analyses', {
                    headers: headers
                });

                if (!analysesRes.ok) {
                    throw new Error('ç„¡æ³•è¼‰å…¥åˆ†æè¨˜éŒ„');
                }

                const analysesData = await analysesRes.json();
                if (analysesData.ok) {
                    renderAnalyses(analysesData.analyses);
                    // å¦‚æœæœ‰æœ€æ–°åˆ†æï¼Œæ›´æ–°ã€ŒæŸ¥çœ‹æœ€æ–°çµæœã€é€£çµ
                    if (analysesData.analyses.length > 0) {
                        const latestUsername = analysesData.analyses[0].username;
                        const latestLink = document.getElementById('latestResultLink');
                        if (latestLink) {
                            latestLink.href = `/static/result.html?username=${encodeURIComponent(latestUsername)}`;
                            latestLink.style.display = 'inline-block';
                        }
                    }
                } else {
                    throw new Error(analysesData.error || 'è¼‰å…¥å¤±æ•—');
                }
            } catch (error) {
                console.error('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—:', error);
                document.getElementById('analysesList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <p>è¼‰å…¥å¤±æ•—ï¼š${error.message}</p>
                        <button class="btn btn-primary" onclick="location.reload()" style="margin-top: var(--spacing);">
                            é‡æ–°è¼‰å…¥
                        </button>
                    </div>
                `;
            }
        }

        function renderUserProfile(user) {
            const profileDiv = document.getElementById('userProfile');
            const avatarDiv = document.getElementById('userAvatar');
            const nameDiv = document.getElementById('userName');
            const emailDiv = document.getElementById('userEmail');
            
            if (user.avatar_url) {
                avatarDiv.innerHTML = `<img src="${user.avatar_url}" alt="${user.display_name || user.username}">`;
            } else {
                const initial = (user.display_name || user.username || '?').charAt(0).toUpperCase();
                document.getElementById('userAvatarInitial').textContent = initial;
            }
            
            nameDiv.textContent = user.display_name || user.username || 'ç”¨æˆ¶';
            emailDiv.textContent = user.email || '-';
            
            profileDiv.style.display = 'flex';
        }

        function renderStats(stats) {
            document.getElementById('totalAnalyses').textContent = stats.total_analyses || 0;
            document.getElementById('latestValue').textContent = formatPrice(stats.latest_value || 0);
            document.getElementById('highestValue').textContent = formatPrice(stats.highest_value || 0);
            
            if (stats.first_analysis_date) {
                const date = new Date(stats.first_analysis_date);
                document.getElementById('firstAnalysisDate').textContent = date.toLocaleDateString('zh-TW');
            }
            
            document.getElementById('statsSection').style.display = 'grid';
        }

        function renderAnalyses(analyses) {
            const container = document.getElementById('analysesList');
            
            if (analyses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>é‚„æ²’æœ‰åˆ†æè¨˜éŒ„</p>
                        <a href="/static/upload.html" class="btn btn-primary" style="margin-top: var(--spacing);">
                            é–‹å§‹ç¬¬ä¸€æ¬¡åˆ†æ
                        </a>
                    </div>
                `;
                return;
            }

            container.innerHTML = analyses.map(analysis => {
                const date = new Date(analysis.created_at);
                const dateStr = date.toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="analysis-card" onclick="viewAnalysis('${analysis.username}')">
                        <div class="analysis-header">
                            <div class="analysis-username">@${analysis.username}</div>
                            <div class="analysis-date">${dateStr}</div>
                        </div>
                        <div class="analysis-preview">
                            <div>
                                <div style="font-size: var(--font-size-sm); color: var(--text-light); margin-bottom: 4px;">
                                    ç²‰çµ²æ•¸ï¼š${formatNumber(analysis.followers)}
                                </div>
                                <div class="analysis-value">${formatPrice(analysis.account_asset_value)}</div>
                            </div>
                        </div>
                        ${analysis.analysis_text ? `<div class="analysis-text">${analysis.analysis_text}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function viewAnalysis(username) {
            window.location.href = `/static/result.html?username=${encodeURIComponent(username)}`;
        }

        function formatPrice(value) {
            if (value >= 1000000) {
                return `$${(value / 1000000).toFixed(1)}M`;
            } else if (value >= 1000) {
                return `$${(value / 1000).toFixed(1)}K`;
            }
            return `$${value.toLocaleString()}`;
        }

        function formatNumber(value) {
            if (value >= 1000000) {
                return `${(value / 1000000).toFixed(1)}M`;
            } else if (value >= 1000) {
                return `${(value / 1000).toFixed(1)}K`;
            }
            return value.toLocaleString();
        }

        function renderChart(history) {
            if (!history || history.length === 0) return;
            
            const chartSection = document.getElementById('chartSection');
            const svg = document.getElementById('valueChart');
            chartSection.style.display = 'block';
            
            // æ¸…ç©º SVG
            svg.innerHTML = `
                <defs>
                    <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:var(--primary);stop-opacity:0.5" />
                        <stop offset="100%" style="stop-color:var(--primary);stop-opacity:0" />
                    </linearGradient>
                </defs>
            `;
            
            const width = svg.clientWidth || 600;
            const height = svg.clientHeight || 200;
            const padding = { top: 20, right: 20, bottom: 40, left: 60 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            // è¨ˆç®—æ•¸æ“šç¯„åœ
            const values = history.map(h => h.value);
            const minValue = Math.min(...values);
            const maxValue = Math.max(...values);
            const valueRange = maxValue - minValue || 1;
            
            // ç”Ÿæˆè·¯å¾‘é»
            const points = history.map((item, index) => {
                const x = padding.left + (index / (history.length - 1 || 1)) * chartWidth;
                const y = padding.top + chartHeight - ((item.value - minValue) / valueRange) * chartHeight;
                return { x, y, value: item.value, date: item.date, username: item.username };
            });
            
            // ç¹ªè£½å€åŸŸ
            if (points.length > 1) {
                let areaPath = `M ${points[0].x} ${padding.top + chartHeight} L ${points[0].x} ${points[0].y} `;
                points.forEach(p => areaPath += `L ${p.x} ${p.y} `);
                areaPath += `L ${points[points.length - 1].x} ${padding.top + chartHeight} Z`;
                
                const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                area.setAttribute('d', areaPath);
                area.setAttribute('class', 'chart-area');
                svg.appendChild(area);
            }
            
            // ç¹ªè£½ç·šæ¢
            if (points.length > 1) {
                let linePath = `M ${points[0].x} ${points[0].y} `;
                for (let i = 1; i < points.length; i++) {
                    linePath += `L ${points[i].x} ${points[i].y} `;
                }
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                line.setAttribute('d', linePath);
                line.setAttribute('class', 'chart-line');
                svg.appendChild(line);
            }
            
            // ç¹ªè£½é»
            points.forEach((point, index) => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', 4);
                circle.setAttribute('class', 'chart-point');
                circle.setAttribute('data-value', point.value);
                circle.setAttribute('data-username', point.username);
                svg.appendChild(circle);
                
                // æ·»åŠ æ—¥æœŸæ¨™ç±¤ï¼ˆåªé¡¯ç¤ºç¬¬ä¸€å€‹å’Œæœ€å¾Œä¸€å€‹ï¼‰
                if (index === 0 || index === points.length - 1) {
                    const date = new Date(point.date);
                    const dateStr = date.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' });
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', point.x);
                    text.setAttribute('y', height - 10);
                    text.setAttribute('class', 'chart-label');
                    text.textContent = dateStr;
                    svg.appendChild(text);
                }
            });
            
            // æ·»åŠ  Y è»¸æ¨™ç±¤ï¼ˆæœ€å°å€¼ã€æœ€å¤§å€¼ï¼‰
            const minText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            minText.setAttribute('x', 10);
            minText.setAttribute('y', height - padding.bottom);
            minText.setAttribute('class', 'chart-label');
            minText.setAttribute('text-anchor', 'start');
            minText.textContent = formatPrice(minValue);
            svg.appendChild(minText);
            
            const maxText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            maxText.setAttribute('x', 10);
            maxText.setAttribute('y', padding.top + 10);
            maxText.setAttribute('class', 'chart-label');
            maxText.setAttribute('text-anchor', 'start');
            maxText.textContent = formatPrice(maxValue);
            svg.appendChild(maxText);
        }
    </script>
</body>
</html>

