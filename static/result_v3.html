<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ä½ çš„ IG èº«åƒ¹è©•ä¼°ï½œåˆ†æçµæœ</title>
  <link rel="stylesheet" href="/static/app.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px 0;
    }
    
    .header {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      padding: 16px 24px;
      border-radius: 12px;
      margin: 0 auto 24px;
      max-width: 900px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 16px;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }
    
    /* ä¸»åƒ¹å€¼å¡ */
    .value-hero {
      text-align: center;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 48px 32px;
      border-radius: 20px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }
    
    .value-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: rotate 20s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .value-hero-content {
      position: relative;
      z-index: 1;
    }
    
    .value-label {
      font-size: 18px;
      opacity: 0.9;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .value-amount {
      font-size: 56px;
      font-weight: 800;
      margin: 16px 0;
      text-shadow: 0 4px 12px rgba(0,0,0,0.2);
      line-height: 1.1;
    }
    
    .value-per {
      font-size: 24px;
      opacity: 0.95;
    }
    
    .value-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 24px;
    }
    
    .value-item {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      padding: 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .value-item-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 8px;
    }
    
    .value-item-amount {
      font-size: 24px;
      font-weight: 700;
    }
    
    /* é¡å‹å±•ç¤º */
    .type-badge {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      padding: 12px 24px;
      border-radius: 50px;
      margin-bottom: 16px;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .type-emoji {
      font-size: 28px;
    }
    
    /* åƒ¹å€¼çµ„æˆ */
    .breakdown-section {
      margin-bottom: 32px;
    }
    
    .breakdown-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .breakdown-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    
    .breakdown-label {
      font-size: 16px;
      color: #555;
      flex: 1;
    }
    
    .breakdown-sublabel {
      font-size: 13px;
      color: #888;
      margin-top: 4px;
    }
    
    .breakdown-value {
      font-size: 20px;
      font-weight: 700;
      color: #f5576c;
    }
    
    .multiplier-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-left: 12px;
    }
    
    /* å“è³ªè©•åˆ† */
    .quality-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .quality-item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
    }
    
    .quality-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .quality-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .quality-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 1s ease;
    }
    
    .quality-score {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }
    
    /* æ”¹é€²å»ºè­° */
    .tips-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .tip-item {
      padding: 16px;
      background: #f0f7ff;
      border-left: 4px solid #667eea;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 15px;
      color: #333;
      line-height: 1.6;
    }
    
    .tip-item::before {
      content: 'ğŸ’¡ ';
      margin-right: 8px;
    }
    
    /* ç”¨æˆ¶è³‡è¨Š */
    .user-info {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .user-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }
    
    .user-details h3 {
      margin: 0 0 4px;
      font-size: 20px;
      color: #333;
    }
    
    .user-handle {
      color: #666;
      font-size: 14px;
    }
    
    .stats-row {
      display: flex;
      gap: 24px;
      margin-top: 12px;
    }
    
    .stat {
      font-size: 13px;
      color: #555;
    }
    
    .stat strong {
      font-weight: 700;
      color: #333;
      margin-right: 4px;
    }
    
    /* æŒ‰éˆ• */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .btn-restart {
      flex: 1;
      padding: 14px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .btn-restart:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102,126,234,0.3);
    }
    
    /* éŸ¿æ‡‰å¼ */
    @media (max-width: 768px) {
      .value-amount {
        font-size: 42px;
      }
      
      .value-grid {
        grid-template-columns: 1fr;
      }
      
      .quality-grid {
        grid-template-columns: 1fr;
      }
      
      .card {
        padding: 24px 20px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div><strong>ğŸ’° IG èº«åƒ¹è©•ä¼°</strong></div>
    <button class="btn btn-ghost btn-sm" onclick="clearAndRestart()">é‡æ–°è©•ä¼°</button>
  </header>

  <main class="container">
    <div id="err" class="status-error hidden"></div>
    
    <!-- ç”¨æˆ¶è³‡è¨Š -->
    <div class="user-info">
      <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
      <div class="user-details">
        <h3 id="displayName">ä½¿ç”¨è€…</h3>
        <div class="user-handle" id="username">@username</div>
        <div class="stats-row">
          <div class="stat"><strong id="followers">0</strong> ç²‰çµ²</div>
          <div class="stat"><strong id="following">0</strong> è¿½è¹¤</div>
          <div class="stat"><strong id="posts">0</strong> è²¼æ–‡</div>
        </div>
      </div>
    </div>
    
    <!-- ä¸»åƒ¹å€¼å¡ -->
    <div class="value-hero">
      <div class="value-hero-content">
        <div class="type-badge" id="typeBadge">
          <span class="type-emoji">ğŸ¨</span>
          <span id="typeName">å‰µä½œè€…</span>
        </div>
        <div class="value-label">ä½ çš„ç™¼æ–‡åƒ¹å€¼</div>
        <div class="value-amount">
          NT$ <span id="postValue">0</span>
        </div>
        <div class="value-per">/ ç¯‡</div>
        
        <div class="value-grid">
          <div class="value-item">
            <div class="value-item-label">ğŸ¬ Story</div>
            <div class="value-item-amount">NT$ <span id="storyValue">0</span></div>
          </div>
          <div class="value-item">
            <div class="value-item-label">ğŸ“¹ Reels</div>
            <div class="value-item-amount">NT$ <span id="reelsValue">0</span></div>
          </div>
          <div class="value-item">
            <div class="value-item-label">ğŸ“¦ æœˆé…åˆ</div>
            <div class="value-item-amount">NT$ <span id="monthlyValue">0</span></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- åƒ¹å€¼çµ„æˆåˆ†æ -->
    <div class="card">
      <div class="breakdown-section">
        <h2 class="breakdown-title">ğŸ“Š åƒ¹å€¼çµ„æˆåˆ†æ</h2>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">åŸºç¤èº«åƒ¹ï¼ˆç²‰çµ²æ•¸ï¼‰</div>
            <div class="breakdown-sublabel" id="followerTier">â€”</div>
          </div>
          <div class="breakdown-value">NT$ <span id="basePrice">0</span></div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">è¦–è¦ºå“è³ªåŠ æˆ</div>
            <div class="breakdown-sublabel">è‰²å½©ã€æ§‹åœ–ã€å¾Œè£½å“è³ª</div>
          </div>
          <div>
            <span class="multiplier-badge" id="visualMult">Ã—1.0</span>
          </div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">å…§å®¹é¡å‹åŠ æˆ</div>
            <div class="breakdown-sublabel" id="contentType">â€”</div>
          </div>
          <div>
            <span class="multiplier-badge" id="contentMult">Ã—1.0</span>
          </div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">å°ˆæ¥­åº¦åŠ æˆ</div>
            <div class="breakdown-sublabel">Bioã€ç™¼æ–‡è¦å¾‹ã€å“ç‰Œè­˜åˆ¥</div>
          </div>
          <div>
            <span class="multiplier-badge" id="profMult">Ã—1.0</span>
          </div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">ç²‰çµ²å“è³ªåŠ æˆ</div>
            <div class="breakdown-sublabel" id="followerQuality">â€”</div>
          </div>
          <div>
            <span class="multiplier-badge" id="followerMult">Ã—1.0</span>
          </div>
        </div>
        
        <div class="breakdown-item">
          <div>
            <div class="breakdown-label">é¢¨æ ¼ç¨ç‰¹æ€§åŠ æˆ</div>
            <div class="breakdown-sublabel" id="styleSignature">â€”</div>
          </div>
          <div>
            <span class="multiplier-badge" id="uniqueMult">Ã—1.0</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å“è³ªè©•åˆ† -->
    <div class="card">
      <h2 class="breakdown-title">â­ å“è³ªè©•åˆ†</h2>
      <div class="quality-grid" id="qualityGrid">
        <!-- JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>
    
    <!-- åƒ¹å€¼é™³è¿° -->
    <div class="card">
      <h2 class="breakdown-title">ğŸ’¬ ä½ çš„åƒ¹å€¼å®šä½</h2>
      <p style="font-size: 16px; line-height: 1.8; color: #333;" id="valueStatement">
        è¼‰å…¥ä¸­...
      </p>
    </div>
    
    <!-- æ”¹é€²å»ºè­° -->
    <div class="card">
      <h2 class="breakdown-title">ğŸ“ˆ åƒ¹å€¼æå‡å»ºè­°</h2>
      <ul class="tips-list" id="improvementTips">
        <!-- JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </ul>
    </div>
    
    <div class="action-buttons">
      <button class="btn-restart" onclick="clearAndRestart()">
        ğŸ”„ é‡æ–°è©•ä¼°
      </button>
    </div>
  </main>

  <script type="module">
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // é˜²æ­¢è¿”å›
    (function() {
      if (window.history && window.history.pushState) {
        window.history.pushState(null, null, window.location.href);
        window.addEventListener('popstate', function() {
          window.history.pushState(null, null, window.location.href);
          if (confirm('âš ï¸ ç„¡æ³•è¿”å›ä¸Šä¸€é \n\nè‹¥è¦é‡æ–°è©•ä¼°ï¼Œè«‹é»æ“Šã€Œé‡æ–°è©•ä¼°ã€ã€‚')) {
            clearAndRestart();
          }
        });
      }
    })();

    function formatNumber(num) {
      return num.toLocaleString('zh-TW');
    }

    function fillUI(data) {
      console.log('Filling UI with data:', data);
      
      // åŸºæœ¬è³‡è¨Š
      document.getElementById('displayName').textContent = data.display_name || 'ä½¿ç”¨è€…';
      document.getElementById('username').textContent = data.username ? '@' + data.username : 'â€”';
      document.getElementById('followers').textContent = formatNumber(data.followers || 0);
      document.getElementById('following').textContent = formatNumber(data.following || 0);
      document.getElementById('posts').textContent = formatNumber(data.posts || 0);
      
      // é¡å‹
      const type = data.primary_type || {};
      document.getElementById('typeBadge').innerHTML = `
        <span class="type-emoji">${type.emoji || 'ğŸ¨'}</span>
        <span>${type.name_zh || 'å‰µä½œè€…'}</span>
      `;
      
      // é ­åƒ emoji
      document.getElementById('userAvatar').textContent = type.emoji || 'ğŸ‘¤';
      
      // åƒ¹å€¼
      const value = data.value_estimation || {};
      document.getElementById('postValue').textContent = formatNumber(value.post_value || 0);
      document.getElementById('storyValue').textContent = formatNumber(value.story_value || 0);
      document.getElementById('reelsValue').textContent = formatNumber(value.reels_value || 0);
      document.getElementById('monthlyValue').textContent = formatNumber(value.monthly_package || 0);
      
      // åƒ¹å€¼çµ„æˆ
      document.getElementById('basePrice').textContent = formatNumber(value.base_price || 0);
      document.getElementById('followerTier').textContent = 
        `ä½ çš„ç´šåˆ¥ï¼š${value.follower_tier || 'ç´ äºº'}ï¼ˆ${formatNumber(data.followers || 0)} ç²‰çµ²ï¼‰`;
      
      const mult = value.multipliers || {};
      document.getElementById('visualMult').textContent = 'Ã—' + (mult.visual || 1.0);
      document.getElementById('contentMult').textContent = 'Ã—' + (mult.content || 1.0);
      document.getElementById('profMult').textContent = 'Ã—' + (mult.professional || 1.0);
      document.getElementById('followerMult').textContent = 'Ã—' + (mult.follower || 1.0);
      document.getElementById('uniqueMult').textContent = 'Ã—' + (mult.unique || 1.0);
      
      // å…§å®¹é¡å‹
      const analysis = data.analysis || {};
      const contentType = analysis.content_type || {};
      document.getElementById('contentType').textContent = contentType.primary || 'â€”';
      
      // ç²‰çµ²å“è³ª
      document.getElementById('followerQuality').textContent = 
        `ç²‰çµ²/è¿½è¹¤æ¯” = ${(data.followers / (data.following || 1)).toFixed(1)}ï¼ˆ${value.follower_quality || 'æ¨™æº–'}ï¼‰`;
      
      // é¢¨æ ¼ç°½å
      const uniqueness = analysis.uniqueness || {};
      document.getElementById('styleSignature').textContent = uniqueness.style_signature || 'â€”';
      
      // å“è³ªè©•åˆ†
      const visual = analysis.visual_quality || {};
      const qualityItems = [
        { label: 'è‰²å½©å’Œè«§åº¦', score: visual.color_harmony || 5 },
        { label: 'æ§‹åœ–å°ˆæ¥­åº¦', score: visual.composition || 5 },
        { label: 'å¾Œè£½å“è³ª', score: visual.editing || 5 },
        { label: 'æ•´é«”ç¾æ„Ÿ', score: visual.overall || 5 }
      ];
      
      const qualityGrid = document.getElementById('qualityGrid');
      qualityGrid.innerHTML = '';
      
      qualityItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'quality-item';
        div.innerHTML = `
          <div class="quality-label">${item.label}</div>
          <div class="quality-bar">
            <div class="quality-fill" style="width: ${item.score * 10}%"></div>
          </div>
          <div class="quality-score">${item.score.toFixed(1)} / 10</div>
        `;
        qualityGrid.appendChild(div);
      });
      
      // åƒ¹å€¼é™³è¿°
      document.getElementById('valueStatement').textContent = 
        data.value_statement || 'æ­£åœ¨åˆ†æä½ çš„ç¨ç‰¹åƒ¹å€¼...';
      
      // æ”¹é€²å»ºè­°
      const tips = data.improvement_tips || [];
      const tipsList = document.getElementById('improvementTips');
      tipsList.innerHTML = '';
      
      if (tips.length > 0) {
        tips.forEach(tip => {
          const li = document.createElement('li');
          li.className = 'tip-item';
          li.textContent = tip;
          tipsList.appendChild(li);
        });
      } else {
        tipsList.innerHTML = '<li class="tip-item">ç›®å‰æ²’æœ‰å»ºè­°ï¼Œä½ çš„å¸³è™Ÿå·²ç¶“å¾ˆæ£’äº†ï¼</li>';
      }
    }

    async function loadResult() {
      const saved = sessionStorage.getItem('sa_result');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (data && data.ok) {
            fillUI(data);
            return;
          }
        } catch {}
      }
      
      // Fallback: å¾ debug endpoint
      try {
        const r = await fetch('/debug/last_ai?ts=' + Date.now());
        if (r.ok) {
          const j = await r.json();
          let parsed = null;
          try {
            parsed = JSON.parse(j.text || j.raw || '{}');
          } catch {}
          if (parsed && parsed.ok) {
            fillUI(parsed);
            return;
          }
        }
      } catch {}
      
      document.getElementById('err').textContent = 'æ‰¾ä¸åˆ°åˆ†æçµæœï¼Œ3ç§’å¾Œè¿”å›é¦–é ';
      document.getElementById('err').style.display = 'block';
      setTimeout(() => location.href = '/static/upload.html', 3000);
    }

    window.clearAndRestart = async function() {
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸¦é‡æ–°é–‹å§‹ï¼Ÿ')) return;
      
      try {
        const config = {
          apiKey: "AIzaSyBI2-4yEwzxvYOvui9FZiGAzCE22OhKmU8",
          authDomain: "social-avatar-d13c8.firebaseapp.com",
          projectId: "social-avatar-d13c8",
          storageBucket: "social-avatar-d13c8.appspot.com",
          messagingSenderId: "280598358339",
          appId: "1:280598358339:web:214a0d4ca53793163367f6"
        };

        const app = getApps().length ? getApps()[0] : initializeApp(config);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const user = auth.currentUser;
        if (user) {
          await deleteDoc(doc(db, 'users', user.uid)).catch(() => {});
        }
        
        sessionStorage.clear();
        localStorage.clear();
        await signOut(auth).catch(() => {});
        
        alert('âœ… å·²æ¸…é™¤æ‰€æœ‰è³‡æ–™');
        location.replace('/static/landing.html');
      } catch (e) {
        alert('æ¸…é™¤å¤±æ•—ï¼š' + e.message);
      }
    };

    window.addEventListener('DOMContentLoaded', loadResult);
  </script>
</body>
</html>
