<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>分析中… | IG 人格分析 (MBTI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg1:#121321;--bg2:#1a1d33;--card:#181a2a;--line:#262a44;--fg:#eef1ff;--muted:#aeb6d9;--accent:#5f86ff}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 20% 10%,var(--bg2),var(--bg1));color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC",Roboto}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:36px}
    .card{width:min(640px,92vw);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:28px 24px;box-shadow:0 12px 40px rgba(0,0,0,.35);text-align:center}
    h1{margin:0 0 8px;font-size:22px}
    .muted{color:var(--muted)}
    .spinner{width:68px;height:68px;margin:18px auto 10px;border-radius:50%;border:6px solid rgba(255,255,255,.14);border-top-color:var(--accent);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(1turn)}}
    .err{margin-top:12px;color:#ffb9c1;font-size:13px;display:none}
    .btn{margin-top:10px;background:#3d56ff;color:#fff;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>AI 分析中，請稍候…</h1>
      <div class="spinner"></div>
      <div class="muted" id="step">正在解析圖片與文字線索…</div>
      <div class="muted" style="margin-top:6px">通常需 5–15 秒，請勿關閉視窗。</div>
      <div id="err" class="err"></div>
      <button id="retry" class="btn">重試</button>
    </div>
  </div>
  <script>
    // 若上一步已把結果寫入 localStorage → 直接去結果
    const cached = localStorage.getItem('mbti_result');
    if (cached) {
      try { const o = JSON.parse(cached); if (o && (o.display_name || (o.ai && o.ai.display_name))) location.replace('/static/result.html'); } catch {}
    }

    const step = document.getElementById('step');
    const errEl= document.getElementById('err');
    const retry= document.getElementById('retry');
    const steps = ['辨識人名、帳號與數據…', '分析首屏貼文風格…', '推斷社群 MBTI…', '撰寫個性化說明…'];
    let i=0, tries=0; setInterval(()=>{ i=(i+1)%steps.length; step.textContent=steps[i]; },1200);

    async function poll(){
      tries++;
      try{
        const r = await fetch('/debug/last_ai',{cache:'no-store'});
        const j = await r.json().catch(()=>({}));
        const ai = j.ai || j;
        if (ai && (ai.display_name || ai.username || ai.mbti || ai.summary)){
          localStorage.setItem('mbti_result', JSON.stringify(ai));
          location.replace('/static/result.html'); return;
        }
      }catch{}

      if (tries<60) setTimeout(poll,1200);
      else { errEl.style.display='block'; errEl.textContent='分析逾時，可能繁忙或圖片過大。'; retry.style.display='inline-block'; }
    }
    retry.onclick = ()=>{ errEl.style.display='none'; retry.style.display='none'; tries=0; poll(); };
    poll();
  </script>
</body>
</html>
