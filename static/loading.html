<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>分析中…</title>
<link rel="icon" href="data:," />
<style>
  :root{color-scheme:dark}
  body{margin:0;background:#0f1115;color:#e6e9ef;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;display:grid;place-items:center;min-height:100svh}
  .box{text-align:center}
  .spinner{width:68px;height:68px;border:6px solid #2b3040;border-top-color:#9aa6ff;border-radius:50%;animation:spin 1s linear infinite;margin:18px auto}
  @keyframes spin{to{transform:rotate(360deg)}}
  .hint{opacity:.7}
</style>
</head>
<body>
<div class="box">
  <div class="spinner"></div>
  <h2>AI 分析中，請稍候…</h2>
  <p class="hint">通常需 5–15 秒；若逾時會自動返回上傳頁。</p>
</div>

<script>
  const KEY = "sa_result";
  const POLL_INTERVAL = 1200;
  const POLL_MAX_MS   = 90_000;

  function looksValid(ai){
    return !!(ai && (ai.username || ai.display_name || ai.summary ||
      (ai.followers|0)>0 || (ai.posts|0)>0 || (ai.mbti && ai.mbti.length>1)));
  }

  async function poll(){
    const start = Date.now();
    while (Date.now() - start < POLL_MAX_MS){
      try{
        const r = await fetch("/debug/last_ai", { cache:"no-store" });
        if (r.ok){
          const data = await r.json();
          const ai = data.ai || data;
          if (looksValid(ai)){
            localStorage.setItem(KEY, JSON.stringify({
              ...ai, __raw: data.raw || "", __used_fallback: !!data.used_fallback
            }));
            location.replace("/static/result.html");
            return;
          }
        }
      }catch{}
      await new Promise(r=>setTimeout(r,POLL_INTERVAL));
    }
    location.replace("/static/upload.html");
  }
  poll();
</script>
</body>
</html>
