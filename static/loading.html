<script>
/**
 * 會輪詢 /debug/last_ai，拿到有效結果就寫入 localStorage 後導到 result.html
 */
const POLL_INTERVAL = 1200;      // 1.2s
const POLL_MAX_MS   = 90_000;    // 最多等 90 秒
const KEY           = "sa_result";

function looksValid(ai) {
  if (!ai) return false;
  // 只要有其中一個關鍵訊號即可視為有效
  return Boolean(
    (ai.username && ai.username.length > 0) ||
    (ai.display_name && ai.display_name.length > 0) ||
    (ai.summary && ai.summary.length > 10) ||
    (ai.followers && ai.followers > 0) ||
    (ai.posts && ai.posts > 0) ||
    (ai.mbti && ai.mbti.length > 2)
  );
}

async function pollLastAI() {
  const start = Date.now();
  while (Date.now() - start < POLL_MAX_MS) {
    try {
      const r = await fetch("/debug/last_ai", { cache: "no-store" });
      if (!r.ok) throw new Error("HTTP " + r.status);
      const data = await r.json(); // { ai: {...}, raw?: "...", used_fallback?: true }
      const ai = data.ai || data;  // 容錯：有些版本直接回 ai 物件
      if (looksValid(ai)) {
        // 帶上 raw 與 used_fallback，之後結果頁可以顯示錯誤細節
        localStorage.setItem(KEY, JSON.stringify({
          ...ai,
          __raw: data.raw || "",
          __used_fallback: !!data.used_fallback
        }));
        location.href = "/static/result.html";
        return;
      }
    } catch (e) {
      console.log("poll failed:", e);
    }
    await new Promise(res => setTimeout(res, POLL_INTERVAL));
  }
  // 超時：落地顯示錯誤並回上傳
  alert("分析逾時，請重試。若持續發生，請稍後再試。");
  location.href = "/static/upload.html";
}

pollLastAI();
</script>
