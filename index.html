<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SocialAvatar</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#0b1220; color:#dbe4ff; }
    .wrap { max-width: 860px; margin: 64px auto; padding: 0 20px; }
    h1 { font-size: 36px; text-align: center; margin: 8px 0 24px; }
    .card{ background:#0f172a; border:1px solid #233; border-radius: 14px; padding:24px; }
    .row{ display:flex; gap:12px; }
    .row>*{ flex:1; }
    input,button{ font:inherit; padding:12px 14px; border-radius:10px; border:1px solid #2a2f48; background:#0b1220; color:#dbe4ff; }
    button{ background:#6ea8fe; color:#051030; border: none; cursor:pointer; }
    button.secondary{ background:#253049; color:#bcd; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .mt{ margin-top:16px; }
    .mt2{ margin-top:28px; }
    .muted{ color:#8aa1c7; font-size:14px; }
    .result{ background:#0b1328; border:1px dashed #234; padding:16px; border-radius:12px; min-height:128px; white-space:pre-wrap; }
    .footer{ text-align:center; margin-top:36px; color:#8aa1c7; font-size:14px; }
    .hint{ margin-top:12px; color:#9fb2da; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>SocialAvatar</h1>
    <p style="text-align:center" class="muted">AI 驅動的 Instagram 人格分析工具</p>

    <div class="card mt2">
      <div class="row">
        <input id="username" placeholder="輸入 IG 帳號（例如：dannytjkan）" />
        <button id="btnAnalyze">開始分析</button>
        <button id="btnBind" class="secondary" title="綁定你的 IG（一次）">連結 Instagram</button>
      </div>

      <div class="hint">系統將分析用戶公開資料與貼文特徵，輸出 <b>IG帳號</b>、<b>Profile 名稱</b>、<b>MBTI 類型</b> 與 <b>50字內分析說明</b>。</div>

      <div class="mt result" id="result">尚未分析。</div>
    </div>

    <div class="footer">
      © 2025 SocialAvatar · <a href="privacy.html">隱私權政策</a> · <a href="terms.html">服務條款</a> · <a href="data-deletion.html">資料刪除說明</a>
    </div>
  </div>

  <script>
    const API = "https://socialavatar.onrender.com"; // 換成你的後端

    const $ = sel => document.querySelector(sel);
    const btnAnalyze = $('#btnAnalyze');
    const btnBind = $('#btnBind');
    const $username = $('#username');
    const $result = $('#result');

    // If redirect from /auth/callback
    if (new URL(location.href).searchParams.get('bind') === 'success') {
      showMsg('綁定成功！可以開始分析自己的 IG 了。');
      history.replaceState({}, '', location.pathname);
    }

    btnBind.onclick = () => {
      // 導去後端 OAuth
      location.href = API + "/auth/login";
    };

    btnAnalyze.onclick = async () => {
      try {
        btnAnalyze.disabled = true;
        $result.textContent = '分析中…';

        // 確認是否已綁定
        const st = await fetch(API + '/auth/status', { credentials: 'include' }).then(r=>r.json());
        if (st.status !== 'bound') {
          $result.textContent = '尚未綁定。請先點「連結 Instagram」完成一次授權。';
          return;
        }
        // 後端 /me/ig/analyze 會用 session 內的 ig_user_id/page_token 執行分析
        const r = await fetch(API + '/me/ig/analyze', {
          method:'POST',
          credentials:'include'
        });
        const data = await r.json();

        if (!r.ok) {
          $result.textContent = '分析失敗：' + JSON.stringify(data);
          return;
        }
        // 顯示四個欄位
        const lines = [
          `IG 帳號： ${data.ig_account || '-'}`,
          `Profile 名稱： ${data.profile_name || '-'}`,
          `MBTI 類型： ${data.mbti || '-'}`,
          `分析說明： ${data.reason || '-'}`,
        ];
        $result.textContent = lines.join('\n');
      } catch (err) {
        $result.textContent = '分析錯誤：' + err;
      } finally {
        btnAnalyze.disabled = false;
      }
    };

    function showMsg(msg){ $result.textContent = msg; }
  </script>
</body>
</html>
